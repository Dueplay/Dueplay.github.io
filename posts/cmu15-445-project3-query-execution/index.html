<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CMU15-445 Project3 Query Execution | Cookie&#39;s Blog</title>
<meta name="keywords" content="Database">
<meta name="description" content="Building the Query Execution Engine for Bustub.">
<meta name="author" content="Me">
<link rel="canonical" href="https://canonical.url/to/page">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2eadbb982468c11a433a3e291f01326f2ba43f065e256bf792dbd79640a92316.js" integrity="sha256-Lq27mCRowRpDOj4pHwEybyukPwZeJWv3ktvXlkCpIxY="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/cmu15-445-project3-query-execution/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XHWHM02GB"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-4XHWHM02GB', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="CMU15-445 Project3 Query Execution" />
<meta property="og:description" content="Building the Query Execution Engine for Bustub." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/cmu15-445-project3-query-execution/" />
<meta property="og:image" content="http://localhost:1313/%3Cimage%20path/url%3E" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-26T22:57:31&#43;08:00" />
<meta property="article:modified_time" content="2022-11-26T22:57:31&#43;08:00" /><meta property="og:site_name" content="ExampleSite" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/%3Cimage%20path/url%3E" />
<meta name="twitter:title" content="CMU15-445 Project3 Query Execution"/>
<meta name="twitter:description" content="Building the Query Execution Engine for Bustub."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CMU15-445 Project3 Query Execution",
      "item": "http://localhost:1313/posts/cmu15-445-project3-query-execution/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CMU15-445 Project3 Query Execution",
  "name": "CMU15-445 Project3 Query Execution",
  "description": "Building the Query Execution Engine for Bustub.",
  "keywords": [
    "Database"
  ],
  "articleBody": "æ¥è®°å½•ä¸€ä¸‹ Bustub Query Execution çš„å®ç°è¿‡ç¨‹ã€‚\nåœ¨é˜…è¯»æœ¬æ–‡å‰ï¼Œå¢™è£‚æ¨èé˜…è¯» Project 3 å¼€å‘è€…è¿Ÿå…ˆç”Ÿçš„è¿™ç¯‡æ–‡ç« ï¼š BusTub å…»æˆè®°ï¼šä»è¯¾ç¨‹é¡¹ç›®åˆ° SQL æ•°æ®åº“ å¯ä»¥æ›´æ¸…æ™°åœ°äº†è§£åˆ° Bustub SQL å±‚çš„è®¾è®¡è¿‡ç¨‹ã€‚\nResources https://15445.courses.cs.cmu.edu/fall2022 è¯¾ç¨‹å®˜ç½‘ https://github.com/cmu-db/bustub Bustub Github Repo https://www.gradescope.com/ è‡ªåŠ¨æµ‹è¯„ç½‘ç«™ GradeScopeï¼Œcourse entry code: PXWVR5 https://discord.gg/YF7dMCg Discord è®ºå›ï¼Œè¯¾ç¨‹äº¤æµç”¨ bilibili æœ‰æ¬è¿çš„è¯¾ç¨‹è§†é¢‘ï¼Œè‡ªå¯»ã€‚ https://15445.courses.cs.cmu.edu/fall2022/bustub/ åœ¨ä½ çš„æµè§ˆå™¨ä¸Šè¿è¡Œ Bustubï¼ è¯·ä¸è¦å°†å®ç°ä»£ç å…¬å¼€ï¼Œå°Šé‡ Andy å’Œ TAs çš„åŠ³åŠ¨æˆæœï¼\nOverview Andy åœ¨ Lecture ä¸­è¯´ï¼ŒQuery Optimization æ˜¯æ•°æ®åº“æœ€éš¾çš„éƒ¨åˆ†ï¼ŒTransaction æ˜¯ç¬¬äºŒéš¾çš„éƒ¨åˆ†ã€‚æ€»ä½“æ¥è¯´ï¼ŒProject 3 çš„éš¾åº¦ä¸ç®—å¤§ï¼Œä½†å’Œ Project 2 çš„éš¾ç‚¹æ°å¥½ç›¸åï¼šProject 2 çš„éš¾ç‚¹åœ¨äºä»é›¶å®ç° B+ æ ‘ï¼Œä¸€åˆ‡éƒ½å¾—é è‡ªå·±ã€‚Project 3 çš„éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†è§£æŸ¥è¯¢å¼•æ“çš„åŸç†ï¼Œå…·ä½“å®ç°èµ·æ¥å…¶å®æ¯”è¾ƒç®€å•ã€‚\nè¿™æ˜¯è¯¾ç¨‹å®˜ç½‘çš„ä¸€å¼ å›¾ï¼Œæ¸…æ™°åœ°ä»‹ç»äº† Bustub çš„æ•´ä½“æ¶æ„ã€‚åœ¨ Project 3 ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ç³»åˆ— Executorsï¼Œä»¥åŠä¸º Optimizer æ·»åŠ æ–°åŠŸèƒ½ã€‚\nTask1ï¼šAccess Method Executors. åŒ…å« SeqScanã€Insertã€Deleteã€IndexScan å››ä¸ªç®—å­ã€‚ Task2ï¼šAggregation and Join Executors. åŒ…å« Aggregationã€NestedLoopJoinã€NestedIndexJoin ä¸‰ä¸ªç®—å­ã€‚ Task3ï¼šSort + Limit Executors and Top-N Optimization. åŒ…å« Sortã€Limitã€TopN ä¸‰ä¸ªç®—å­ï¼Œä»¥åŠå®ç°å°† Sort + Limit ä¼˜åŒ–ä¸º TopN ç®—å­ã€‚ Leaderboard Taskï¼šä¸º Optimizer å®ç°æ–°çš„ä¼˜åŒ–è§„åˆ™ï¼ŒåŒ…æ‹¬ Hash Joinã€Join Reorderingã€Filter Push Downã€Column Pruning ç­‰ç­‰ï¼Œè®©ä¸‰æ¡è¯¡å¼‚çš„ sql è¯­å¥æ‰§è¡Œåœ°è¶Šå¿«è¶Šå¥½ã€‚ Talking Casually åœ¨æ­£å¼å¼€å§‹è®°å½• Project 3 çš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘æƒ³éšä¾¿èŠèŠ Bustub æ•´ä½“çš„ç»“æ„ä¸è¿è¡Œæµç¨‹ã€‚åœ¨è¿·è¿·ç³Šç³Šåœ°é€šè¿‡ Project 3 çš„æ‰€æœ‰ tests åï¼Œæˆ‘æ„è¯†åˆ°è¿™å…¶å®æ˜¯äº†è§£æ•°æ®åº“åˆ°åº•æ˜¯å¦‚ä½•æ‰§è¡Œ sql è¯­å¥çš„æœ€ä½³æ—¶æœºã€‚Project 1\u00262 éƒ½æ¯”è¾ƒå±€éƒ¨ï¼Œè€Œåœ¨è¿™é‡Œï¼Œä¸€ä¸ªèƒ½çœŸæ­£æ‰§è¡Œ sql è¯­å¥çš„æ•°æ®åº“å·²ç»æ„å»ºèµ·æ¥äº†ã€‚å…ˆæš‚æ—¶æŠ›å¼€ transactionï¼Œæ¥çœ‹çœ‹ä¸€æ¡ sql è¯­å¥åœ¨ Bustub ä¸­çš„æ—…è¡Œã€‚\nParser ä¸€æ¡ sql è¯­å¥ï¼Œé¦–å…ˆç»è¿‡ Parser ç”Ÿæˆä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘ ASTã€‚å…·ä½“å¦‚ä½•ç”Ÿæˆï¼Œè¯·å‚è€ƒç¼–è¯‘åŸç†ã€‚Parser ä¸æ˜¯æ•°æ®åº“çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œå› æ­¤é™¤éçƒ­çˆ±ç¼–è¯‘åŸç†ï¼Œæˆ–è€…æƒ³é€šè¿‡å®ç°ä¸€ä¸ª sql Parser å¯¹ç¼–è¯‘åŸç†è¿›è¡Œå®è·µï¼Œå¦åˆ™ä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨ç¬¬ä¸‰æ–¹åº“ã€‚Bustub ä¸­é‡‡ç”¨äº† libpg_query åº“å°† sql è¯­å¥ parse ä¸º ASTã€‚\nBinder åœ¨å¾—åˆ° AST åï¼Œè¿˜éœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š\nSELECT colA FROM table1; å…¶ä¸­ SELECT å’Œ FROM æ˜¯å…³é”®å­—ï¼ŒcolA å’Œ table1 æ˜¯æ ‡è¯†ç¬¦ã€‚Binder éå† ASTï¼Œå°†è¿™äº›è¯è¯­ç»‘å®šåˆ°ç›¸åº”çš„å®ä½“ä¸Šã€‚å®ä½“æ˜¯ Bustub å¯ä»¥ç†è§£çš„å„ç§ c++ ç±»ã€‚ç»‘å®šå®Œæˆåï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸€æ£µ Bustub å¯ä»¥ç›´æ¥ç†è§£çš„æ ‘ã€‚æŠŠå®ƒå«åš Bustub ASTã€‚\nPlanner å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š\nSELECT t1.y, t2.x FROM t1 INNER JOIN t2 ON t1.x = t2.y; å¯¹åº”çš„åŸå§‹çš„æŸ¥è¯¢è®¡åˆ’æ˜¯\næŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚\nOptimizer ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š\nRule-based. Optimizer éå†åˆæ­¥æŸ¥è¯¢è®¡åˆ’ï¼Œæ ¹æ®å·²ç»å®šä¹‰å¥½çš„ä¸€ç³»åˆ—è§„åˆ™ï¼Œå¯¹ PlanNode è¿›è¡Œä¸€ç³»åˆ—çš„ä¿®æ”¹ã€èšåˆç­‰æ“ä½œã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† Limit + Sort åˆå¹¶ä¸º TopNã€‚è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ Plan Nodeã€‚ Cost-based. è¿™ç§ Optimizer é¦–å…ˆéœ€è¦è¯»å–æ•°æ®ï¼Œåˆ©ç”¨ç»Ÿè®¡å­¦æ¨¡å‹æ¥é¢„æµ‹ä¸åŒå½¢å¼ä½†ç»“æœç­‰ä»·çš„æŸ¥è¯¢è®¡åˆ’çš„ costã€‚æœ€ç»ˆé€‰å‡º cost æœ€å°çš„æŸ¥è¯¢è®¡åˆ’ä½œä¸ºæœ€ç»ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚ Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚MIT6.830 çš„ SimpleDB åˆ™æ˜¯é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œæœ‰å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚\nå¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚\nExecutor åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š\nIterator Modelï¼Œæˆ– Pipeline Modelï¼Œæˆ–ç«å±±æ¨¡å‹ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ Init() å’Œ Next() ä¸¤ä¸ªæ–¹æ³•ã€‚Init() å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚Next() åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ Next() è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚å¯ä»¥çœ‹åˆ°ï¼Œç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ï¼Œç‰¹åˆ«æ˜¯è™šå‡½æ•°è°ƒç”¨é€ æˆ cache miss ç­‰é—®é¢˜ã€‚ Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ã€‚ä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚ Vectorization Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“éƒ½é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚ Bustub é‡‡ç”¨çš„æ˜¯ Iterator Modelã€‚\næ­¤å¤–ï¼Œç®—å­çš„æ‰§è¡Œæ–¹å‘ä¹Ÿæœ‰ä¸¤ç§ï¼š\nTop-to-Bottom. ä»æ ¹èŠ‚ç‚¹ç®—å­å¼€å§‹ï¼Œä¸æ–­åœ° pull ä¸‹å±‚ç®—å­çš„æ•°æ®ã€‚ Bottom-to-Top. ä»å¶å­èŠ‚ç‚¹ç®—å­å¼€å§‹ï¼Œå‘ä¸Šå±‚ç®—å­ push è‡ªå·±çš„æ•°æ®ã€‚ Bustub é‡‡ç”¨ Top-to-Bottomã€‚\nåœ¨æ ¹èŠ‚ç‚¹ç®—å­å¤„ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢çš„æ•°æ®ï¼Œä¸€æ¡ sql è¯­å¥å®Œæˆäº†å®ƒçš„ä½¿å‘½ã€‚\nå¦å¤–ï¼Œæˆ‘ä»¬åœ¨ Project 1 ä¸­å®ç°çš„ Buffer Pool å’Œåœ¨ Project 2 ä¸­å®ç°çš„ B+Tree Index åœ¨å“ªé‡Œï¼Ÿå®é™…ä¸Šå°±åœ¨ä¸€ç³»åˆ—ç®—å­ä¸‹ã€‚ä¾‹å¦‚ SeqScan ç®—å­ï¼Œéœ€è¦éå† tableï¼Œé¦–å…ˆé€šè¿‡æ•°æ®åº“çš„ catalog æ‰¾åˆ°å¯¹åº”çš„ tableï¼Œä¸€ä¸ª table ç”±è®¸å¤š page ç»„æˆï¼Œåœ¨è®¿é—® page æ—¶ï¼Œå°±ç”¨åˆ°äº† Buffer Poolã€‚åœ¨ Optimizer ä¸­ï¼Œå‡å¦‚å‘ç° Sort ç®—å­åœ¨å¯¹ indexed attribute æ’åºï¼Œä¼šå°† Sort ç®—å­ä¼˜åŒ–ä¸º IndexScan ç®—å­ï¼Œè¿™æ ·å°±ç”¨åˆ°äº† B+Tree Indexã€‚\nBustub Query Execution çš„å¤§è‡´ç»“æ„å°±æ˜¯è¿™æ ·ï¼Œè¿˜æœ‰å¾ˆå¤šè®¾è®¡ä¸Šçš„ç»†èŠ‚æ²¡æœ‰æåˆ°ï¼Œæ¯”å¦‚ Tupleã€Valueã€AbstractExpression ç­‰ç­‰ã€‚æ¥ä¸‹æ¥åœ¨å…·ä½“å®ç°ä¸­è¾¹çœ‹è¾¹èŠã€‚\nTask 1 Access Method Executors Task 1 åŒ…å« 4 ä¸ªç®—å­ï¼ŒSeqScanã€Insertã€Delete å’Œ IndexScanã€‚\nSeqScan è¯»å–ç»™å®š table ä¸­çš„æ‰€æœ‰ tupleï¼Œä»…ä¼šå‡ºç°åœ¨æŸ¥è¯¢è®¡åˆ’çš„å¶å­èŠ‚ç‚¹å¤„ã€‚ç›´æ¥ä½¿ç”¨å·²ç»æä¾›çš„ TableIteratorã€‚å®ç°èµ·æ¥æŒºç®€å•çš„ã€‚æ­¤å¤–ä¸»è¦æƒ³èŠèŠ Bustub ä¸­ table çš„ç»“æ„ã€‚\né¦–å…ˆï¼ŒBustub æœ‰ä¸€ä¸ª Catalogã€‚Catalog æä¾›äº†ä¸€ç³»åˆ— APIï¼Œä¾‹å¦‚ CreateTable()ã€GetTable() ç­‰ç­‰ã€‚Catalog ç»´æŠ¤äº†å‡ å¼  hashmapï¼Œä¿å­˜äº† table id å’Œ table name åˆ° table info çš„æ˜ å°„å…³ç³»ã€‚table id ç”± Catalog åœ¨æ–°å»º table æ—¶è‡ªåŠ¨åˆ†é…ï¼Œtable name åˆ™ç”±ç”¨æˆ·æŒ‡å®šã€‚\nè¿™é‡Œçš„ table info åŒ…å«äº†ä¸€å¼  table çš„ metadataï¼Œæœ‰ schemaã€nameã€id å’ŒæŒ‡å‘ table heap çš„æŒ‡é’ˆã€‚ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†æƒ³è¦è®¿é—®ä¸€å¼  table æ—¶ï¼Œå…ˆä½¿ç”¨ name æˆ– id ä» Catalog å¾—åˆ° table infoï¼Œå†è®¿é—® table info ä¸­çš„ table heapã€‚\ntable heap æ˜¯ç®¡ç† table æ•°æ®çš„ç»“æ„ï¼ŒåŒ…å« InsertTuple()ã€MarkDelete() ä¸€ç³»åˆ— table ç›¸å…³æ“ä½œã€‚table heap æœ¬èº«å¹¶ä¸ç›´æ¥å­˜å‚¨ tuple æ•°æ®ï¼Œtuple æ•°æ®éƒ½å­˜æ”¾åœ¨ table page ä¸­ã€‚table heap å¯èƒ½ç”±å¤šä¸ª table page ç»„æˆï¼Œä»…ä¿å­˜å…¶ç¬¬ä¸€ä¸ª table page çš„ page idã€‚éœ€è¦è®¿é—®æŸä¸ª table page æ—¶ï¼Œé€šè¿‡ page id ç»ç”± buffer pool è®¿é—®ã€‚\ntable page æ˜¯å®é™…å­˜å‚¨ table æ•°æ®çš„ç»“æ„ï¼Œçˆ¶ç±»æ˜¯ pageã€‚ç›¸è¾ƒäº pageï¼Œtable page å¤šäº†ä¸€äº›æ–°çš„æ–¹æ³•ã€‚table page åœ¨ data çš„å¼€å¤´å­˜æ”¾äº† next page idã€prev page id ç­‰ä¿¡æ¯ï¼Œå°†å¤šä¸ª table page è¿æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä¾¿äºæ•´å¼  table çš„éå†æ“ä½œã€‚å½“éœ€è¦æ–°å¢ tuple æ—¶ï¼Œtable heap ä¼šæ‰¾åˆ°å½“å‰å±äºè‡ªå·±çš„æœ€åä¸€å¼  table pageï¼Œå°è¯•æ’å…¥ï¼Œè‹¥æœ€åä¸€å¼  table page å·²æ»¡ï¼Œåˆ™æ–°å»ºä¸€å¼  table page æ’å…¥ tupleã€‚table page ä½åœ°å€å­˜æ”¾ headerï¼Œtuple ä»é«˜åœ°å€ä¹Ÿå°±æ˜¯ table page å°¾éƒ¨å¼€å§‹æ’å…¥ã€‚\ntuple å¯¹åº”æ•°æ®è¡¨ä¸­çš„ä¸€è¡Œæ•°æ®ã€‚æ¯ä¸ª tuple éƒ½ç”± RID å”¯ä¸€æ ‡è¯†ã€‚RID ç”± page id + slot num æ„æˆã€‚tuple ç”± value ç»„æˆï¼Œvalue çš„ä¸ªæ•°å’Œç±»å‹ç”± table info ä¸­çš„ schema æŒ‡å®šã€‚\nvalue åˆ™æ˜¯æŸä¸ªå­—æ®µå…·ä½“çš„å€¼ï¼Œvalue æœ¬èº«è¿˜ä¿å­˜äº†ç±»å‹ä¿¡æ¯ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œexecutor æœ¬èº«å¹¶ä¸ä¿å­˜æŸ¥è¯¢è®¡åˆ’çš„ä¿¡æ¯ï¼Œåº”è¯¥é€šè¿‡ executor çš„æˆå‘˜ plan æ¥å¾—çŸ¥è¯¥å¦‚ä½•è¿›è¡Œæœ¬æ¬¡è®¡ç®—ï¼Œä¾‹å¦‚ SeqScanExecutor éœ€è¦å‘ SeqScanPlanNode è¯¢é—®è‡ªå·±è¯¥æ‰«æå“ªå¼ è¡¨ã€‚\næ‰€æœ‰è¦ç”¨åˆ°çš„ç³»ç»Ÿèµ„æºï¼Œä¾‹å¦‚ Catalogï¼ŒBuffer Pool ç­‰ï¼Œéƒ½ç”± ExecutorContext æä¾›ã€‚\nInsert \u0026 Delete Insert å’Œ Delete è¿™ä¸¤ä¸ªç®—å­å®ç°èµ·æ¥åŸºæœ¬ä¸€æ ·ï¼Œä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯å”¯äºŒçš„å†™ç®—å­ã€‚æ•°æ®åº“æœ€ä¸»è¦çš„æ“ä½œå°±æ˜¯å¢æŸ¥åˆ æ”¹ã€‚Bustub sql å±‚æš‚æ—¶ä¸æ”¯æŒ UPDATEã€‚Insert å’Œ Delete ä¸€å®šæ˜¯æŸ¥è¯¢è®¡åˆ’çš„æ ¹èŠ‚ç‚¹ï¼Œä¸”ä»…éœ€è¿”å›ä¸€ä¸ªä»£è¡¨ä¿®æ”¹è¡Œæ•°çš„ tupleã€‚\nInsert å’Œ Delete æ—¶ï¼Œè®°å¾—è¦æ›´æ–°ä¸ table ç›¸å…³çš„æ‰€æœ‰ indexã€‚index ä¸ table ç±»ä¼¼ï¼ŒåŒæ ·ç”± Catalog ç®¡ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºå¯ä»¥å¯¹ä¸åŒçš„å­—æ®µå»ºç«‹ indexï¼Œä¸€ä¸ª table å¯èƒ½å¯¹åº”å¤šä¸ª indexï¼Œæ‰€æœ‰çš„ index éƒ½éœ€è¦æ›´æ–°ã€‚\nInsert æ—¶ï¼Œç›´æ¥å°† tuple è¿½åŠ è‡³ table å°¾éƒ¨ã€‚Delete æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯å°† tuple æ ‡è®°ä¸ºåˆ é™¤çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯é€»è¾‘åˆ é™¤ã€‚ï¼ˆåœ¨äº‹åŠ¡æäº¤åï¼Œå†è¿›è¡Œç‰©ç†åˆ é™¤ï¼ŒProject 3 ä¸­æ— éœ€å®ç°ï¼‰\nInsert \u0026 Delete çš„ Next() åªä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¸€ä¸ª integer value çš„ tupleï¼Œè¡¨ç¤º table ä¸­æœ‰å¤šå°‘è¡Œå—åˆ°äº†å½±å“ã€‚\nIndexScan ä½¿ç”¨æˆ‘ä»¬åœ¨ Project 2 ä¸­å®ç°çš„ B+Tree Index Iteratorï¼Œéå† B+ æ ‘å¶å­èŠ‚ç‚¹ã€‚ç”±äºæˆ‘ä»¬å®ç°çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œåœ¨å¶å­èŠ‚ç‚¹åªèƒ½è·å–åˆ° RIDï¼Œéœ€è¦æ‹¿ç€ RID å» table æŸ¥è¯¢å¯¹åº”çš„ tupleã€‚\nåœ¨å®Œæˆ Task 1 çš„å››ä¸ªç®—å­åï¼Œå¯ä»¥ç”¨å·²æä¾›çš„ sqllogictest å·¥å…·å’Œå·²æä¾›çš„ä¸€äº› sql æ¥æ£€éªŒè‡ªå·±çš„ç®—å­æ˜¯å¦å®ç°æ­£ç¡®ã€‚\nå…³äº Task 1 çš„å…·ä½“å®ç°çš„ç¡®æ²¡å¤ªå¤šå¯è¯´çš„ï¼ŒåŸºæœ¬æ˜¯æŠŠå®˜ç½‘çš„ instruction ç¿»è¯‘äº†ä¸€éã€‚åé¢å‡ ä¸ª task éš¾åº¦ä¼šç¨å¤§ä¸€ç‚¹ç‚¹ï¼Œä¹Ÿä¼šè®²è®²æ›´å…·ä½“çš„å®ç°ã€‚\nTask 2 Aggregation \u0026 Join Executors Task 2 åŒ…å«äº† 3 ä¸ªç®—å­ï¼ŒAggregationã€NestedLoopJoin å’Œ NestedIndexJoinã€‚\nAggregation Aggregation ç®—å­å°±ç¨å¾®å¤æ‚ä¸€ç‚¹äº†ã€‚å…ˆçœ‹çœ‹ AggregationExecutor çš„æˆå‘˜ï¼š\n/** The aggregation plan node */ const AggregationPlanNode *plan_; /** The child executor that produces tuples over which the aggregation is computed */ std::unique_ptr\u003cAbstractExecutor\u003e child_; /** Simple aggregation hash table */ SimpleAggregationHashTable aht_; /** Simple aggregation hash table iterator */ SimpleAggregationHashTable::Iterator aht_iterator_; ä¸»è¦è¯´è¯´è¿™ä¸ª SimpleAggregationHashTableã€‚Aggregation æ˜¯ pipeline breakerã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAggregation ç®—å­ä¼šæ‰“ç ´ iteration model çš„è§„åˆ™ã€‚åŸå› æ˜¯ï¼Œåœ¨ Aggregation çš„ Init() å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°±è¦å°†æ‰€æœ‰ç»“æœå…¨éƒ¨è®¡ç®—å‡ºæ¥ã€‚åŸå› å¾ˆç®€å•ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š\nSELECT t.x, max(t.y) FROM t GROUP BY t.x; ç»“æœçš„æ¯æ¡ tuple éƒ½æ˜¯ä¸€ä¸ª t.x çš„èšåˆï¼Œè€Œè¦å¾—åˆ°åŒä¸€ä¸ª t.x å¯¹åº”çš„ max(t.y)ï¼Œå¿…é¡»è¦éå†æ•´å¼ è¡¨ã€‚å› æ­¤ï¼ŒAggregation éœ€è¦åœ¨ Init() ä¸­ç›´æ¥è®¡ç®—å‡ºå…¨éƒ¨ç»“æœï¼Œå°†ç»“æœæš‚å­˜ï¼Œå†åœ¨ Next() ä¸­ä¸€æ¡ä¸€æ¡åœ° emitã€‚è€Œ SimpleAggregationHashTable å°±æ˜¯è®¡ç®—å¹¶ä¿å­˜ Aggregation ç»“æœçš„æ•°æ®ç»“æ„ã€‚\nSimpleAggregationHashTable ç»´æŠ¤ä¸€å¼  hashmapï¼Œé”®ä¸º AggregateKeyï¼Œå€¼ä¸º AggregateValueï¼Œå‡ä¸º std::vectorã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ InsertCombine() å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ SimpleAggregationHashTableã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š\nSELECT min(t.z), max(t.z), sum(t.z) FROM t GROUP BY t.x, t.y; group byï¼ˆAggregateKeyï¼‰ä¸º {t.x, t.y}ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º {t.z, t.z, t.z}ã€‚aggregate è§„åˆ™ä¸º {min, max, sum}ã€‚\néœ€è¦é¢å¤–æ³¨æ„çš„æ˜¯ count(column) å’Œ count(*) çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚å¦å¤–ï¼Œä¸éœ€è¦è€ƒè™‘ hashmap è¿‡å¤§çš„æƒ…å†µï¼Œå³æ•´å¼  hashmap å¯ä»¥é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œä¸éœ€è¦é€šè¿‡ Buffer Pool è°ƒç”¨ page æ¥å­˜å‚¨ã€‚\nåœ¨ Init() ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ Next() ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚Aggregation è¾“å‡ºçš„ schema å½¢å¼ä¸º group-bys + aggregatesã€‚\nNestedLoopJoin Project 3 ä¸­åªè¦æ±‚å®ç° NestedLoopJoinï¼ŒHashJoin ä¸åšå¼ºåˆ¶è¦æ±‚ï¼Œè€Œæ˜¯æ”¾åœ¨äº† Leaderboard Optional é‡Œã€‚å®é™…ä¸Šå®ç°ä¸€ä¸ª in-memory çš„ HashJoin ä¹Ÿä¸éš¾ã€‚Join åº”è¯¥æ˜¯ç»å…¸çš„æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆã€‚Andy åœ¨ Lecture é‡Œä¹Ÿè¯¦ç»†åœ°é‡åŒ–åœ°å¯¹æ¯”äº†å„ç§ Join çš„ costsï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ã€‚\nNestedLoopJoin ç®—æ³•æœ¬èº«å¹¶ä¸éš¾ï¼Œä½†æ¯”è¾ƒå®¹æ˜“æ‰è¿›å‘é‡Œã€‚ä¼ªä»£ç å¤§æ¦‚æ˜¯è¿™æ ·ï¼š\nfor outer_tuple in outer_table: for inner_tuple in inner_table: if inner_tuple matched outer_tuple: emit æœ‰äº†è¿™ä¸ªä¾‹å­ï¼Œå¾ˆå®¹æ˜“æŠŠä»£ç å†™æˆï¼š\nwhile (left_child-\u003eNext(\u0026left_tuple)){ while (right_child-\u003eNext(\u0026right_tuple)){ if (left_tuple matches right_tuple){ *tuple = ...; // assemble left \u0026 right together return true; } } } return false; ä¸€å¼€å§‹çœ‹èµ·æ¥ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ç„¶è€Œå¾ˆå¿«å¯ä»¥å‘ç°æœ‰ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œright child åœ¨ left child çš„ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œä¹‹ååªä¼šè¿”å› falseã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨ Init() é‡Œå…ˆæŠŠ right child é‡Œçš„æ‰€æœ‰ tuple å–å‡ºæ¥æš‚å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œå°±å¥½ï¼Œä¹‹åç›´æ¥è®¿é—®è¿™ä¸ªæ•°ç»„ã€‚\nwhile (left_child-\u003eNext(\u0026left_tuple)){ for (auto right_tuple : right_tuples){ if (left_tuple matches right_tuple){ *tuple = ...; // assemble left \u0026 right together return true; } } } return false; çœ‹èµ·æ¥å¥½åƒåˆæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ç„¶è€Œï¼ŒåŒä¸€åˆ—æ˜¯å¯èƒ½å­˜åœ¨ duplicate value çš„ã€‚åœ¨ä¸Šå±‚ç®—å­æ¯æ¬¡è°ƒç”¨ NestedLoopJoin çš„ Next() æ—¶ï¼ŒNestedLoopJoin éƒ½ä¼šå‘ä¸‹å±‚ç®—å­è¯·æ±‚æ–°çš„ left tupleã€‚ä½†æœ‰å¯èƒ½ä¸Šä¸€ä¸ª left tuple è¿˜æ²¡æœ‰å’Œ right child ä¸­æ‰€æœ‰èƒ½åŒ¹é…çš„ tuple åŒ¹é…å®Œï¼ˆåªåŒ¹é…äº†ç¬¬ä¸€ä¸ªï¼‰ã€‚\nä¾‹å¦‚è¿™ä¸¤å¼ è¡¨ï¼š\nt1 t2\r--------- ---------\r| x | | x |\r--------- ---------\r| 1 | | 1 |\r| 2 | | 1 |\r| 3 | | 2 |\r--------- --------- ç°åœ¨æ‰§è¡Œ\nSELECT * FROM t1 INNER JOIN t2 ON t1.x = t2.x; t1 ä¸­çš„ 1 åªä¼šå’Œ t2 çš„ç¬¬ä¸€ä¸ª 1 åŒ¹é…ï¼Œäº§ç”Ÿä¸€è¡Œè¾“å‡ºã€‚å†ä¸‹ä¸€æ¬¡è°ƒç”¨ Next() æ—¶ï¼Œå·¦è¾¹ä¼šç›´æ¥é€‰å– 2 å¼€å§‹å°è¯•åŒ¹é…ã€‚\nè§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ç®—å­é‡Œæš‚å­˜ left tupleï¼Œæ¯æ¬¡è°ƒç”¨ Next() æ—¶ï¼Œå…ˆç”¨æš‚å­˜çš„ left tuple å°è¯•åŒ¹é…ã€‚å¹¶ä¸”è¦è®°å½•ä¸Šä¸€æ¬¡å³è¡¨åŒ¹é…åˆ°çš„ä½ç½®ï¼Œä¸è¦æ¯æ¬¡éƒ½ç›´æ¥ä»å³è¡¨ç¬¬ä¸€è¡Œå¼€å§‹åŒ¹é…äº†ã€‚å³è¡¨éå†å®Œè¿˜æ²¡æœ‰åŒ¹é…ç»“æœï¼Œå†å»æ‰¾å·¦è¡¨è¦ä¸‹ä¸€ä¸ª tupleã€‚\nè¯´æ¥è¯´å»ï¼Œå®é™…ä¸Šå°±æ˜¯æ³¨æ„è¿­ä»£å™¨è¦ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚\nINNER JOIN å’Œ LEFT JOIN æŒ‰è§„åˆ™å®ç°å°±å¥½ï¼Œå·®ä¸å¤šã€‚LEFT JOIN æ³¨æ„å¤„ç†ç©ºå€¼ã€‚\nè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œæ€ä¹ˆåˆ¤æ–­ä¸¤ä¸ª tuple æ˜¯å¦åŒ¹é…ï¼Ÿè¿™é‡Œå°±è¦ç¬¬ä¸€æ¬¡é‡åˆ° Project 3 é‡Œå¦ä¸€ä¸ªé‡è¦çš„ç±» AbstractExpression äº†ã€‚\nAbstractExpression æŠ½è±¡äº† sql ä¸­çš„å„ç§è¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬ ArithmeticExpressionã€ColumnValueExpressionã€ComparisonExpressionã€ConstantValueExpression å’Œ LogicExpressionã€‚è¿™éƒ½æ˜¯ä»€ä¹ˆï¼Ÿçœ‹ä¸‹é¢è¿™æ¡ sqlï¼š\nSELECT * FROM t1 WHERE t1.x = t1.y + 1 AND t1.y \u003e 0; é‡ç‚¹å…³æ³¨ WHERE åçš„è¡¨è¾¾å¼ t1.x = t1.y + 1 AND t1.y \u003e 0ã€‚çœ‹è¿™ä¸‹é¢è¿™å¼ å›¾ï¼š\nå…¶å®å°±æ˜¯ä¸€é¢—è¡¨è¾¾å¼æ ‘ã€‚AbstractExpression å°±æ˜¯è¡¨è¾¾å¼æ ‘çš„èŠ‚ç‚¹ã€‚sql ä¸­çš„æ‰€æœ‰è¡¨è¾¾å¼éƒ½ä¼šè¢« parse ä¸ºè¡¨è¾¾å¼æ ‘ï¼Œåœ¨ Binder ä¸­è¿›è¡Œç»‘å®šã€‚ä¸Šé¢çš„ JOIN ä¸­ä¹Ÿå­˜åœ¨è¡¨è¾¾å¼ t1.x = t2.xã€‚AbstractExpression é‡Œæœ€é‡è¦çš„æ–¹æ³•å°±æ˜¯ Evaluate()ï¼Œè¿”å›å€¼æ˜¯ valueã€‚è°ƒç”¨ Evaluate()ï¼Œå‚æ•°ä¸º tuple å’Œ tuple å¯¹åº”çš„ schemaï¼Œè¿”å›ä»è¿™ä¸ª tuple ä¸­æå–æ•°æ®åä»£å…¥è¡¨è¾¾å¼è®¡ç®—å¾—åˆ°çš„ç»“æœã€‚\nåœ¨ NestedLoopJoin é‡Œï¼Œæˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯ EvaluateJoin()ï¼Œä¹Ÿå·®ä¸å¤šï¼Œåªä¸è¿‡è¾“å…¥çš„æ˜¯å·¦å³ä¸¤ä¸ª tuple å’Œ schemaã€‚è¿”å›å€¼æ˜¯è¡¨ç¤º true æˆ– false çš„ valueã€‚true åˆ™ä»£è¡¨æˆåŠŸåŒ¹é…ã€‚\nåˆ°è¿™é‡Œï¼ŒNestedLoopJoin å°±æˆåŠŸå®ç°äº†ã€‚Join è¾“å‡ºçš„ schema ä¸º left schema + right schemaã€‚\nåæ¥æˆ‘çœ‹äº†ä¸€ä¸‹ RisingLight é‡Œçš„å®ç°ï¼Œæˆ‘è¿™ä¸ª rustacean èŒæ–°çš„ç¬¬ä¸€ååº”æ˜¯æƒŠä¸ºå¤©äººã€‚å¤§è‡´æ˜¯è¿™æ ·ï¼š\npub async fn Execute(){ for left_tuple in left_table { for right_tuple in right_table { if matches { yield AssembleOutput(); } } } } è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå½“æ‰§è¡Œåˆ° yield æ—¶ï¼Œå‡½æ•°ä¼šæš‚æ—¶ä¸­æ–­ï¼Œä»ç”Ÿæˆå™¨å›åˆ°è°ƒç”¨è€…ã€‚è€Œè°ƒç”¨è€…å†æ¬¡è¿›å…¥ç”Ÿæˆå™¨æ—¶ï¼Œå¯ä»¥ç›´æ¥å›åˆ°ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ã€‚å†é…åˆ streamï¼Œå°±åˆ©ç”¨ rust çš„æ— æ ˆåç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹å®Œç¾åœ°å®ç°äº†ä¸€ä¸ª NestedLoopJoin ç®—å­ï¼Œæ¯”æ‰‹åŠ¨ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼˜é›…å¤ªå¤šäº†ã€‚\nåæ¥ä»”ç»†æƒ³æƒ³ï¼ŒGo ä¹Ÿå¯ä»¥æœ‰ç±»ä¼¼çš„å†™æ³•ï¼š\nfunc Executor(out_ch, left_ch, right_ch chan Tuple) { // fetch right tuples from right_ch right_tuples := []Tuple{} for right_tuple := range right_ch { right_tuples = append(right_tuples, right_tuple) } for left_tuple := range left_ch { for _, right_tuple := range right_tuples { if matches { out_ch \u003c- AssembleOutput(); } } } close(out_ch) } æ¯ä¸ªç®—å­éƒ½æ˜¯ä¸€ä¸ª goroutineï¼Œé€šè¿‡ channel å®ç°å¼‚æ­¥çš„è®¡ç®—ï¼Œå¥½åƒä¹Ÿä¸é”™ã€‚\nNestedIndexJoin åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚å…¶ä»–çš„å°±ä¸å†å¤šè¯´äº†ã€‚\nTask 3 Sort + Limit Executors and Top-N Optimization Task 3 ä¸­è¦å®ç° 3 ä¸ªç®—å­ï¼ŒSortã€Limit å’Œ TopNï¼Œä»¥åŠå°† Limit + Sort åœ¨ Optimizer ä¸­ä¼˜åŒ–ä¸º TopNã€‚\nSort Sort ä¹Ÿæ˜¯ pipeline breakerã€‚åœ¨ Init() ä¸­è¯»å–æ‰€æœ‰ä¸‹å±‚ç®—å­çš„ tupleï¼Œå¹¶æŒ‰ ORDER BY çš„å­—æ®µå‡åºæˆ–é™åºæ’åºã€‚Sort ç®—å­è¯´èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦éœ€è¦è‡ªå®šä¹‰ std::sort()ã€‚\nstd::sort() çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥è‡ªå®šä¹‰çš„æ¯”è¾ƒå‡½æ•°ã€‚ç›´æ¥ä¼ å…¥ä¸€ä¸ª lambda åŒ¿åå‡½æ•°ã€‚ç”±äºè¦è®¿é—®æˆå‘˜ plan_ æ¥è·å–æ’åºçš„å­—æ®µï¼Œlambda éœ€è¦æ•è· this æŒ‡é’ˆã€‚å¦å¤–ï¼Œæ’åºå­—æ®µå¯ä»¥æœ‰å¤šä¸ªï¼ŒæŒ‰å…ˆåé¡ºåºæ¯”è¾ƒã€‚ç¬¬ä¸€ä¸ªä¸ç›¸ç­‰ï¼Œç›´æ¥å¾—åˆ°ç»“æœï¼›ç›¸ç­‰ï¼Œåˆ™æ¯”è¾ƒç¬¬äºŒä¸ªã€‚ä¸ä¼šå‡ºç°æ‰€æœ‰å­—æ®µå…¨éƒ¨ç›¸ç­‰çš„æƒ…å†µã€‚\nstd::sort(sorted_tuples_.begin(), sorted_tuples_.end(), [this](const Tuple \u0026a, const Tuple \u0026b) { for (auto [order_by_type, expr] : plan_-\u003eGetOrderBy()) { // compare and return ... } UNREACHABLE(\"doesn't support duplicate key\"); }); Limit å’Œ SeqScan åŸºæœ¬ä¸€æ¨¡ä¸€æ ·ï¼Œåªä¸è¿‡åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª countï¼Œè®°å½•å·²ç» emit äº†å¤šå°‘ tupleã€‚å½“ä¸‹å±‚ç®—å­ç©ºäº†æˆ– count è¾¾åˆ°è§„å®šä¸Šé™åï¼Œä¸å†è¿”å›æ–°çš„ tupleã€‚\nTopN ä»…éœ€è¿”å›æœ€å¤§/æœ€å°çš„ n ä¸ª tupleã€‚ä¸€å¼€å§‹æƒ³ç€è¦å®ç°ä¸€ä¸ª fixed-size priority queueï¼Œå³ queue å¤§å°è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨æŠ›å¼ƒæœ€åä¸€ä¸ªå…ƒç´ ä»¥å‡å°å†…å­˜å ç”¨ï¼Œä½†åæ¥å®åœ¨ä¸æƒ³è‡ªå·±é‡å†™ä¸€éäºŒå‰å †ï¼Œå°±å¼€æ‘†äº†ã€‚ç›´æ¥ç”¨ std::priority_queue åŠ è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œç„¶ååœ¨ Init() ä¸­éå†ä¸‹å±‚ç®—å­æ‰€æœ‰ tupleï¼Œå…¨éƒ¨å¡è¿›ä¼˜å…ˆé˜Ÿåˆ—åæˆªå–å‰ n ä¸ªã€‚å† Next() é‡Œä¸€ä¸ªä¸€ä¸ªè¾“å‡ºã€‚ï¼ˆæ˜¯ä¸æ˜¯å’Œ Limit + Sort æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Ÿéƒ½æ˜¯ O(nlogn)\nSort + Limit As TopN è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ã€‚ç»ˆäºä¸æ˜¯å®ç°ç®—å­äº†ï¼Œè€Œæ˜¯åœ¨ Optimizer é‡Œå¢åŠ ä¸€æ¡è§„åˆ™ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š\nauto Optimizer::OptimizeCustom(const AbstractPlanNodeRef \u0026plan) -\u003e AbstractPlanNodeRef { auto p = plan; p = OptimizeMergeProjection(p); p = OptimizeMergeFilterNLJ(p); p = OptimizeNLJAsIndexJoin(p); p = OptimizeNLJAsHashJoin(p); // Enable this rule after you have implemented hash join. p = OptimizeOrderByAsIndexScan(p); p = OptimizeSortLimitAsTopN(p); // what we should add return p; } å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ NLJAsIndexJoinï¼š\nauto Optimizer::OptimizeNLJAsIndexJoin(const AbstractPlanNodeRef \u0026plan) -\u003e AbstractPlanNodeRef { std::vector\u003cAbstractPlanNodeRef\u003e children; for (const auto \u0026child : plan-\u003eGetChildren()) { children.emplace_back(OptimizeNLJAsIndexJoin(child)); } auto optimized_plan = plan-\u003eCloneWithChildren(std::move(children)); if (optimized_plan-\u003eGetType() == PlanType::NestedLoopJoin) { // apply the rule and return } return optimized_plan; } å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚\nå¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚\nåˆ°è¿™é‡Œï¼ŒProject 3 ä¸­å¿…åšçš„éƒ¨åˆ†å°±ç»“æŸäº†ã€‚è¿˜å‰©ä¸‹é€‰åšçš„ Leaderboard Taskã€‚æœ¬æ¥ä¹Ÿä¸æ˜¯ CMU çš„å­¦ç”Ÿï¼Œå°±ä¸åˆ†ä»€ä¹ˆå¿…åšé€‰åšäº†ï¼Œæ„Ÿå…´è¶£çš„è¯éƒ½æ¨èè¯•ä¸€è¯•ã€‚æˆ‘ä¸ªäººæ„Ÿè§‰ Leaderboard Task è¿˜æ˜¯å¾ˆå¥½ç©çš„ï¼Œå°±æ˜¯ä»£ç å†™èµ·æ¥æœ‰ç‚¹éš¾å—ï¼Œcorner case æ¯”è¾ƒå¤šã€‚\nLeaderboard Task Leaderboard Task åŒ…å«ä¸‰æ¡æå…¶è¯¡å¼‚çš„ sqlï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å¢åŠ æ–°çš„ä¼˜åŒ–è§„åˆ™ï¼Œè®©è¿™ä¸‰æ¡ sql æ‰§è¡Œåœ°è¶Šå¿«è¶Šå¥½ã€‚åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼š\nQuery 1: Whereâ€™s the Index? Query 2: Too Many Joins! Query 3: The Mad Data Scientist Query 1: Whereâ€™s the Index? é¦–å…ˆæ¥çœ‹ä¸€çœ‹éœ€è¦æˆ‘ä»¬ä¼˜åŒ–çš„ sqlï¼š\ncreate index t1x on t1_50k(x); select count(*), max(t1_50k.x), max(t1_50k.y), max(__mock_t2_100k.x), max(__mock_t2_100k.y), max(__mock_t3_1k.x), max(__mock_t3_1k.y) from ( t1_50k inner join __mock_t2_100k on t1_50k.x = __mock_t2_100k.x ) inner join __mock_t3_1k on __mock_t2_100k.y = __mock_t3_1k.y; ç¨å¾®æŠŠè¡¨åæ›¿æ¢ä¸€ä¸‹ï¼š\ncreate index t1x on t1(x); select count(*), max(t1.x), max(t1.y), max(t2.x), max(t2.y), max(t3.x), max(t3.y) from ( t1 inner join t2 on t1.x = t2.x ) inner join t3 on t2.y = t3.y; çœ‹çš„æˆ‘æœ‰ç‚¹ç²¾ç¥ææƒšï¼Œå®é™…ä¸Šå°±æ˜¯ä¸‰å¼ è¡¨ Join å† Aggregate ä¸€ä¸‹ã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘æ˜¯æŠŠ NestedLoopJoin æ›¿æ¢ä¸º HashJoinã€Join Reorder è®©å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œä»¥åŠæ­£ç¡®è¯†åˆ« t1.x ä¸Šçš„ç´¢å¼•ã€‚\nå…ˆè¯´ HashJoinã€‚å®é™…ä¸Šä»…éœ€è€ƒè™‘ in-memory æƒ…å†µæ—¶ï¼ŒHashJoin å¹¶ä¸éš¾å®ç°ã€‚ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼ŒBuild å’Œ Probeã€‚Build é˜¶æ®µåœ¨ Init() è¿›è¡Œï¼Œéå†å·¦è¡¨å»ºç«‹ hashmapã€‚Probe é˜¶æ®µåœ¨ Next() è¿›è¡Œï¼Œéå†å³è¡¨æ¢æµ‹æ˜¯å¦æœ‰ match çš„ tupleã€‚éœ€è¦æ³¨æ„ HashJoin åªèƒ½ç”¨äºä¼˜åŒ– equi-joinã€‚\nå…·ä½“å®ç°èµ·æ¥ï¼Œå¯¹äºæˆ‘è¿™ç§å¯¹ modern c++ æä¸ç†Ÿæ‚‰çš„äººæ¥è¯´ï¼Œéš¾ç‚¹åè€Œåœ¨æ€ä¹ˆæ­£ç¡®æ„é€ å‡ºè¿™ä¸ª hashmap è®©ç¼–è¯‘é€šè¿‡ã€‚hashmap çš„é”®åº”è¯¥ä¸º valueï¼Œä½† value æ²¡æœ‰é‡è½½ operator==ï¼Œä¹Ÿæ²¡æœ‰å®ç°è‡ªå®šä¹‰ hash å‡½æ•°ï¼Œä¸èƒ½ç›´æ¥ä½œä¸ºé”®ã€‚\nä¸€å¼€å§‹ï¼Œæˆ‘æƒ³ç”¨ src/include/common/util/hash_util.h é‡Œçš„ HashValue å‡½æ•°å°† value hash ä¸º hash_t ç±»å‹ï¼Œç„¶åæŠŠ hash_t ä½œä¸ºé”®ã€‚hashmap ç›´æ¥ç”¨ std::unordered_mapã€‚ä½†é‡åˆ°äº†å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼Œè¿˜æ˜¯ç»•ä¸è¿‡è¦é‡è½½ operator==ã€‚ç›´æ¥é‡è½½ value çš„ operator== æ˜¯è¡Œä¸é€šçš„ï¼Œautograder æ— æ³•è¯†åˆ«ã€‚å› æ­¤æˆ‘å®šä¹‰äº† ValueKey ç±»å‹æŠŠ value åŒ…è£¹èµ·æ¥ï¼Œä¸º ValueKey é‡è½½ == å¹¶å®ç° hash å‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥ç›´æ¥ç”¨ ValueKey ä½œä¸º hashmap çš„é”®äº†ã€‚è‡³äº operator== çš„å…·ä½“å®ç°ï¼Œéœ€è¦å…³æ³¨ä¸€ä¸‹ Value ç±»çš„ç»“æ„ï¼Œå–å‡º value çš„ raw data å¹¶ cast ä¸ºæ­£ç¡®ç±»å‹è¿›è¡Œæ¯”è¾ƒã€‚åŒæ ·ï¼Œhash å‡½æ•°ä¹Ÿæ˜¯å¯¹ raw data è¿›è¡Œ hashã€‚\nhashmap çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿæ³¨æ„ä¸æ˜¯ tupleï¼Œè€Œæ˜¯ tuple æ•°ç»„ã€‚åŒæ ·ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨ duplicateã€‚\nHashJoin çš„å®ç°å¤§è‡´å¦‚æ­¤ï¼Œæ¥ä¸‹æ¥æ˜¯ Join Reorderã€‚\nJoin Reorder å…¶å®æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è°ƒç”¨ EstimatedCardinality() æ¥ä¼°è®¡ table çš„å¤§å°ï¼Œç„¶åæ ¹æ®å¤§å°æ¥è°ƒæ•´ plan tree é‡Œè¿ç»­ join çš„é¡ºåºå³å¯ã€‚\næœ€åæ˜¯ Correctly Pick up Indexã€‚åœ¨åŸå§‹ NLJAsIndexJoin é‡Œï¼Œå§‹ç»ˆåªä¼šå°è¯•ä¸ºå³è¡¨åŒ¹é… indexï¼Œå·¦è¡¨åˆ™è¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œå¯ä»¥æ–°å»ºä¸€æ¡è§„åˆ™ï¼Œå¦‚æœå·¦è¡¨æœ‰ indexï¼Œå³è¡¨æ²¡æœ‰ï¼Œä¸”ä¸º equi-joinï¼Œåˆ™æŠŠå·¦å³é¡ºåºæ›¿æ¢ä¸€ä¸‹ï¼Œå³æœ‰ç´¢å¼•çš„å·¦è¡¨æ¢åˆ°å³è¾¹ï¼Œä¾¿äºä¹‹åæ­£ç¡®è¯†åˆ«ç´¢å¼•ã€‚ç„¶è€Œæˆ‘åœ¨å®ç°åå‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿä¼˜åŒ–ï¼ˆï¼Œå¯èƒ½å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿˜æ˜¯ HashJoin æ¯”è¾ƒé è°±ã€‚\nQuery 2: Too Many Joins! å…ˆçœ‹çœ‹ sqlï¼š\nselect count(*), max(__mock_t4_1m.x), max(__mock_t4_1m.y), max(__mock_t5_1m.x), max(__mock_t5_1m.y), max(__mock_t6_1m.x), max(__mock_t6_1m.y) from (select * from __mock_t4_1m, __mock_t5_1m where __mock_t4_1m.x = __mock_t5_1m.x), __mock_t6_1m where (__mock_t6_1m.y = __mock_t5_1m.y) and (__mock_t4_1m.y \u003e= 1000000) and (__mock_t4_1m.y \u003c 1500000) and (__mock_t6_1m.x \u003c 150000) and (__mock_t6_1m.x \u003e= 100000); æ›´ç²¾ç¥ææƒšäº†ï¼Œç®€åŒ–ä¸€ä¸‹ï¼š\nselect count(*), max(t4.x), max(t4.y), max(t5.x), max(t5.y), max(t6.x), max(t6.y) from (select * from t4, t5 where t4.x = t5.x), t6 where (t6.y = t5.y) and (t4.y \u003e= 1000000) and (t4.y \u003c 1500000) and (t6.x \u003c 150000) and (t6.x \u003e= 100000); è¿™å¤§æ¦‚æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œå¤§æ¦‚æ˜¯æ‰€æœ‰çš„ JOIN å…¨éƒ¨å†™æˆäº† FULL JOINï¼Œç„¶åæŠŠæ‰€æœ‰ Filter æ”¾åœ¨äº† plan tree çš„é¡¶ç«¯ã€‚åŸå§‹æ‰§è¡Œè®¡åˆ’æ˜¯è¿™æ ·çš„ï¼š\néœ€è¦ä¼˜åŒ–çš„å†…å®¹è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼ŒFilter Push-downï¼Œå°† Filter å°½å¯èƒ½åœ°ä¸‹æ¨è‡³æ•°æ®æºå¤„ã€‚éœ€è¦æ³¨æ„ä¸æ˜¯æ‰€æœ‰çš„ Filter éƒ½å¯ä»¥ä¸‹æ¨ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ Filter æ­£ç¡®ä¸‹æ¨è‡³ Join ç®—å­ä¸‹å°±å¯ä»¥äº†ã€‚æœ€ç»ˆäº§ç”Ÿçš„ä¼˜åŒ–æ–¹æ¡ˆå¤§è‡´æ˜¯è¿™æ ·ï¼š\næ³¨æ„è¦å°† Filter çš„ predicate è¯­å¥æ­£ç¡®åˆ†ç±»ï¼Œä¸‹æ¨è‡³æ­£ç¡®çš„åˆ†æ”¯ã€‚\nåœ¨å®ç° Filter Push-down æ—¶ï¼Œä¸€å¼€å§‹æˆ‘å’Œä¹‹å‰ä¸€æ ·ï¼Œè¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°æ”¹å†™ï¼Œä½†æ˜¯å‘ç°è¿™æ ·ä¼¼ä¹ä¸èƒ½å°† Filter å®Œå…¨åœ°ä¸‹æ¨ï¼Œå› ä¸ºä¸€ä¸ª Filter è¢«ä¸‹æ¨ä¸€æ¬¡åï¼Œå°±æ— æ³•è¢«å†æ¬¡è®¿é—®åˆ°äº†ï¼Œåªèƒ½è¢«ä¸‹æ¨ä¸€æ¬¡ã€‚å› æ­¤è¿™æ¬¡æˆ‘æ”¹ç”¨äº†å…ˆåºéå†ï¼Œè‡ªé¡¶å‘ä¸‹åœ°æ”¹å†™ã€‚å½“ä¸‹æ¨ä¸€ä¸ª Filter åï¼Œç”±äºæ˜¯å‘ä¸‹éå†ï¼ŒFilter è¿˜èƒ½è¢«å†æ¬¡è®¿é—®åˆ°ï¼Œå¯ä»¥è¢«ç»§ç»­ä¸‹æ¨ã€‚\néœ€è¦æ³¨æ„çš„æ—¶ï¼Œæˆ‘ä»¬ä¸‹æ¨çš„ä¸æ˜¯æ•´ä¸ª Filter èŠ‚ç‚¹ï¼Œå®é™…ä¸Šæ˜¯èŠ‚ç‚¹ä¸­çš„ predicateã€‚æˆ‘çš„åšæ³•æ˜¯éå†è¡¨è¾¾å¼æ ‘ï¼Œæå– predicate ä¸­çš„æ‰€æœ‰ comparisonï¼Œåˆ¤æ–­è¡¨è¾¾å¼çš„ä¸¤è¾¹æ˜¯å¦ä¸€ä¸ªæ˜¯ column valueï¼Œä¸€ä¸ªæ˜¯ const valueï¼Œåªæœ‰è¿™æ ·çš„ predicate å¯ä»¥è¢«ä¸‹æ¨ï¼ˆä¹Ÿå­˜åœ¨å…¶ä»–å½¢å¼çš„å¯ä»¥ä¸‹æ¨çš„ predicateï¼Œç”±äºåœ¨è¿™é‡Œåªæ˜¯å¯¹ optimizer çš„ä½“éªŒï¼Œä¹Ÿåªç”¨ä¼˜åŒ–é¢„å…ˆç»™å‡ºçš„ sqlï¼Œå¯ä»¥ç¨å¾®ç®€åŒ–ä¸€ä¸‹ç®—æ³•ï¼Œä¸ç”¨è€ƒè™‘å¤ªå¤šçš„ corner caseï¼‰ï¼Œå†å°†æ‰€æœ‰çš„ predicate é‡æ–°ç»„åˆä¸º logic expressionï¼Œç”Ÿæˆæ–°çš„ Filterï¼Œæ ¹æ® column value çš„ idx æ¥é€‰æ‹©ä¸‹æ¨çš„åˆ†æ”¯ã€‚\nä¸¤è¾¹éƒ½ä¸º column value ä¸”åˆ†åˆ«ä»£è¡¨å·¦å³ä¸¤ä¸ªä¸‹å±‚ç®—å­çš„æŸä¸€åˆ—çš„ Filter å¯ä»¥è¢«ç»“åˆåˆ° Join èŠ‚ç‚¹ä¸­ä½œä¸º Join æ¡ä»¶ã€‚è¿™ä¸€æ­¥çš„è§„åˆ™å·²ç»è¢«å®ç°å¥½äº†ï¼Œå› æ­¤è¿™ç§ Filter æˆ‘ä»¬è®©å…¶åœç•™åœ¨åŸåœ°å³å¯ã€‚\nQuery 3: The Mad Data Scientist çœ‹çœ‹ sqlï¼š\nselect v, d1, d2 from ( select v, max(v1) as d1, max(v1) + max(v1) + max(v2) as d2, min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2), min(v1), max(v2), min(v2), max(v1) + min(v1), max(v2) + min(v2) from __mock_t7 left join (select v4 from __mock_t8 where 1 == 2) on v \u003c v4 group by v ) å¾ˆæ€€ç–‘è¿Ÿå…ˆç”Ÿåœ¨å†™è¿™æ¡ sql æ—¶çš„ç²¾ç¥çŠ¶æ€ã€‚\nå®é™…ä¸Šï¼Œæˆ‘ä»¬åªç”¨ SELECT v, d1, d2ï¼Œå…¶ä½™çš„æ•°æ®éƒ½æ˜¯å¤šä½™çš„ï¼Œæ— éœ€è®¡ç®—ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å®ç° Column Pruning ä¼˜åŒ–ã€‚\næˆ‘å®ç°çš„ Column Pruning åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š\né‡åˆ°è¿ç»­çš„ä¸¤ä¸ª Projectionï¼Œåˆå¹¶ä¸º 1 ä¸ªï¼Œåªå–ä¸Šå±‚ Projection æ‰€éœ€åˆ—ã€‚ é‡åˆ° Projection + Aggregationï¼Œæ”¹å†™ aggregatesï¼Œæˆªå– Projection ä¸­éœ€è¦çš„é¡¹ç›®ï¼Œå…¶ä½™ç›´æ¥æŠ›å¼ƒã€‚ åŒæ ·åœ°ï¼Œæˆ‘ä¸ªäººè®¤ä¸º Column Pruning ä¹Ÿæ˜¯è‡ªé¡¶å‘ä¸‹åœ°æ”¹å†™æ¯”è¾ƒæ–¹ä¾¿ã€‚å…·ä½“å®ç°æ˜¯æ”¶é›† Projection é‡Œçš„æ‰€æœ‰ columnï¼Œç„¶åæ”¹å†™ä¸‹å±‚èŠ‚ç‚¹ï¼Œä»…ä¿ç•™ä¸Šå±‚éœ€è¦ project çš„ columnã€‚è¿™é‡Œçš„ column ä¸ä¸€å®šæ˜¯è¡¨ä¸­çš„ columnï¼Œè€Œæ˜¯ä¸€ç§å¹¿ä¹‰çš„ columnï¼Œä¾‹å¦‚ SELECT t1.x + t1.y FROM t1 ä¸­çš„ t1.x + t1.yã€‚\nå¦å¤–ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™æ¡ sql é‡Œæœ‰ä¸€ä¸ªæ°¸ä¸ºå‡çš„ predicate where 1 == 2ã€‚å¯¹äºè¿™ç§ Filterï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¼˜åŒ–ä¸º DummyScanï¼Œå³ç¬¬ä¸€æ¬¡è°ƒç”¨ Next() å°±è¿”å› falseã€‚å¯ä»¥ç”¨ä¸€ä¸ªç©ºçš„ Value ç®—å­å®ç°ã€‚\nSummary è‡³æ­¤ï¼ŒProject 3 å°±å…¨éƒ¨å®Œæˆäº†ã€‚æ€»çš„æ¥è¯´ä½“éªŒè¿˜æ˜¯å¾ˆå¥½çš„ï¼Œå®ç°äº†ä¸€ç³»åˆ—ç®—å­ï¼Œä¹Ÿå®ç°äº†ä¸€ç³»åˆ—çš„ä¼˜åŒ–è§„åˆ™ï¼Œå¯¹æŸ¥è¯¢å¼•æ“æœ‰äº†æ›´æ¸…æ™°çš„è®¤è¯†ã€‚\nåŒæ ·åœ°ï¼Œæœ‰å¾ˆå¤šå®ç°ä¸Šå…·ä½“çš„ç»†èŠ‚ä¹Ÿå¿½ç•¥æ‰äº†ï¼Œæ¯”å¦‚å¦‚ä½•è£…é…ä¸€ä¸ªä¸­é—´ tupleï¼Œç±»å‹ç³»ç»Ÿçš„è®¾è®¡ï¼Œtable page çš„è®¾è®¡ç­‰ç­‰ã€‚è¿™äº›éƒ½ä¸ä¸»çº¿å…³ç³»ä¸å¤§ï¼Œä¹Ÿå°±ä¸å†å” å¨äº†ã€‚\nå¦å¤–ï¼Œåœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ„å¤–å‘ç° Bustub çš„ OR è¯­å¥æ— æ³•æ­£ç¡®æ‰§è¡Œï¼Œä¸€è·¯æ‰¾ bug æ‰¾ä¸Šå»å‘ç°æ˜¯ Binder ä¸­çš„ä¸€ä¸ªå° typoï¼Œå‘ Bustub æäº† PRï¼Œä¹Ÿè¢« merge äº†ã€‚ç®—æ˜¯ä¸ºå¼€æºè¯¾ç¨‹åšäº†ä¸€ç‚¹å¾®å¾®å¾®å°çš„è´¡çŒ®å§ã€‚\n",
  "wordCount" : "2108",
  "inLanguage": "en",
  "image":"http://localhost:1313/%3Cimage%20path/url%3E","datePublished": "2022-11-26T22:57:31+08:00",
  "dateModified": "2022-11-26T22:57:31+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/cmu15-445-project3-query-execution/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">Home</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="â±archives">
                    <span>â±archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ”Search">
                    <span>ğŸ”Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ”–Tags">
                    <span>ğŸ”–Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title">
      CMU15-445 Project3 Query Execution
    </h1>
    <div class="post-description">
      Building the Query Execution Engine for Bustub.
    </div>
    <div class="post-meta">&lt;span title=&#39;2022-11-26 22:57:31 &#43;0800 CST&#39;&gt;2022-11-26&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;10 min&amp;nbsp;Â·&amp;nbsp;2108 words&amp;nbsp;Â·&amp;nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/el-even-11/blog/content/posts/CMU15-445-Project3-Query-Execution.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#resources">Resources</a></li>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#talking-casually">Talking Casually</a>
      <ul>
        <li><a href="#parser">Parser</a></li>
        <li><a href="#binder">Binder</a></li>
        <li><a href="#planner">Planner</a></li>
        <li><a href="#optimizer">Optimizer</a></li>
        <li><a href="#executor">Executor</a></li>
      </ul>
    </li>
    <li><a href="#task-1-access-method-executors">Task 1 Access Method Executors</a>
      <ul>
        <li><a href="#seqscan">SeqScan</a></li>
        <li><a href="#insert--delete">Insert &amp; Delete</a></li>
        <li><a href="#indexscan">IndexScan</a></li>
      </ul>
    </li>
    <li><a href="#task-2-aggregation--join-executors">Task 2 Aggregation &amp; Join Executors</a>
      <ul>
        <li><a href="#aggregation">Aggregation</a></li>
        <li><a href="#nestedloopjoin">NestedLoopJoin</a></li>
        <li><a href="#nestedindexjoin">NestedIndexJoin</a></li>
      </ul>
    </li>
    <li><a href="#task-3-sort--limit-executors-and-top-n-optimization">Task 3 Sort + Limit Executors and Top-N Optimization</a>
      <ul>
        <li><a href="#sort">Sort</a></li>
        <li><a href="#limit">Limit</a></li>
        <li><a href="#topn">TopN</a></li>
        <li><a href="#sort--limit-as-topn">Sort + Limit As TopN</a></li>
      </ul>
    </li>
    <li><a href="#leaderboard-task">Leaderboard Task</a>
      <ul>
        <li><a href="#query-1-wheres-the-index">Query 1: Where&rsquo;s the Index?</a></li>
        <li><a href="#query-2-too-many-joins">Query 2: Too Many Joins!</a></li>
        <li><a href="#query-3-the-mad-data-scientist">Query 3: The Mad Data Scientist</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><p>æ¥è®°å½•ä¸€ä¸‹ Bustub Query Execution çš„å®ç°è¿‡ç¨‹ã€‚</p>
<p>åœ¨é˜…è¯»æœ¬æ–‡å‰ï¼Œå¢™è£‚æ¨èé˜…è¯» Project 3 å¼€å‘è€…è¿Ÿå…ˆç”Ÿçš„è¿™ç¯‡æ–‡ç« ï¼š
<a href="https://zhuanlan.zhihu.com/p/570917775">BusTub å…»æˆè®°ï¼šä»è¯¾ç¨‹é¡¹ç›®åˆ° SQL æ•°æ®åº“</a>
å¯ä»¥æ›´æ¸…æ™°åœ°äº†è§£åˆ° Bustub SQL å±‚çš„è®¾è®¡è¿‡ç¨‹ã€‚</p>
<h2 id="resources">Resources<a hidden class="anchor" aria-hidden="true" href="#resources">#</a></h2>
<ul>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022">https://15445.courses.cs.cmu.edu/fall2022</a> è¯¾ç¨‹å®˜ç½‘</li>
<li><a href="https://github.com/cmu-db/bustub">https://github.com/cmu-db/bustub</a> Bustub Github Repo</li>
<li><a href="https://www.gradescope.com/">https://www.gradescope.com/</a> è‡ªåŠ¨æµ‹è¯„ç½‘ç«™ GradeScopeï¼Œcourse entry code: PXWVR5</li>
<li><a href="https://discord.gg/YF7dMCg">https://discord.gg/YF7dMCg</a> Discord è®ºå›ï¼Œè¯¾ç¨‹äº¤æµç”¨</li>
<li>bilibili æœ‰æ¬è¿çš„è¯¾ç¨‹è§†é¢‘ï¼Œè‡ªå¯»ã€‚</li>
<li><a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">https://15445.courses.cs.cmu.edu/fall2022/bustub/</a> åœ¨ä½ çš„æµè§ˆå™¨ä¸Šè¿è¡Œ Bustubï¼</li>
</ul>
<p><strong>è¯·ä¸è¦å°†å®ç°ä»£ç å…¬å¼€ï¼Œå°Šé‡ Andy å’Œ TAs çš„åŠ³åŠ¨æˆæœï¼</strong></p>
<h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<p>Andy åœ¨ Lecture ä¸­è¯´ï¼ŒQuery Optimization æ˜¯æ•°æ®åº“æœ€éš¾çš„éƒ¨åˆ†ï¼ŒTransaction æ˜¯ç¬¬äºŒéš¾çš„éƒ¨åˆ†ã€‚æ€»ä½“æ¥è¯´ï¼ŒProject 3 çš„éš¾åº¦ä¸ç®—å¤§ï¼Œä½†å’Œ Project 2 çš„éš¾ç‚¹æ°å¥½ç›¸åï¼šProject 2 çš„éš¾ç‚¹åœ¨äºä»é›¶å®ç° B+ æ ‘ï¼Œä¸€åˆ‡éƒ½å¾—é è‡ªå·±ã€‚Project 3 çš„éš¾ç‚¹åœ¨äºè¯»ä»£ç ï¼Œç†è§£æŸ¥è¯¢å¼•æ“çš„åŸç†ï¼Œå…·ä½“å®ç°èµ·æ¥å…¶å®æ¯”è¾ƒç®€å•ã€‚</p>
<p><img loading="lazy" src="../../imgs/15-445-3-1.svg" alt=""  />
</p>
<p>è¿™æ˜¯è¯¾ç¨‹å®˜ç½‘çš„ä¸€å¼ å›¾ï¼Œæ¸…æ™°åœ°ä»‹ç»äº† Bustub çš„æ•´ä½“æ¶æ„ã€‚åœ¨ Project 3 ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ç³»åˆ— Executorsï¼Œä»¥åŠä¸º Optimizer æ·»åŠ æ–°åŠŸèƒ½ã€‚</p>
<ul>
<li>Task1ï¼šAccess Method Executors. åŒ…å« SeqScanã€Insertã€Deleteã€IndexScan å››ä¸ªç®—å­ã€‚</li>
<li>Task2ï¼šAggregation and Join Executors. åŒ…å« Aggregationã€NestedLoopJoinã€NestedIndexJoin ä¸‰ä¸ªç®—å­ã€‚</li>
<li>Task3ï¼šSort + Limit Executors and Top-N Optimization. åŒ…å« Sortã€Limitã€TopN ä¸‰ä¸ªç®—å­ï¼Œä»¥åŠå®ç°å°† Sort + Limit ä¼˜åŒ–ä¸º TopN ç®—å­ã€‚</li>
<li>Leaderboard Taskï¼šä¸º Optimizer å®ç°æ–°çš„ä¼˜åŒ–è§„åˆ™ï¼ŒåŒ…æ‹¬ Hash Joinã€Join Reorderingã€Filter Push Downã€Column Pruning ç­‰ç­‰ï¼Œè®©ä¸‰æ¡è¯¡å¼‚çš„ sql è¯­å¥æ‰§è¡Œåœ°è¶Šå¿«è¶Šå¥½ã€‚</li>
</ul>
<h2 id="talking-casually">Talking Casually<a hidden class="anchor" aria-hidden="true" href="#talking-casually">#</a></h2>
<p>åœ¨æ­£å¼å¼€å§‹è®°å½• Project 3 çš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘æƒ³éšä¾¿èŠèŠ Bustub æ•´ä½“çš„ç»“æ„ä¸è¿è¡Œæµç¨‹ã€‚åœ¨è¿·è¿·ç³Šç³Šåœ°é€šè¿‡ Project 3 çš„æ‰€æœ‰ tests åï¼Œæˆ‘æ„è¯†åˆ°è¿™å…¶å®æ˜¯äº†è§£æ•°æ®åº“åˆ°åº•æ˜¯å¦‚ä½•æ‰§è¡Œ sql è¯­å¥çš„æœ€ä½³æ—¶æœºã€‚Project 1&amp;2 éƒ½æ¯”è¾ƒå±€éƒ¨ï¼Œè€Œåœ¨è¿™é‡Œï¼Œä¸€ä¸ªèƒ½çœŸæ­£æ‰§è¡Œ sql è¯­å¥çš„æ•°æ®åº“å·²ç»æ„å»ºèµ·æ¥äº†ã€‚å…ˆæš‚æ—¶æŠ›å¼€ transactionï¼Œæ¥çœ‹çœ‹ä¸€æ¡ sql è¯­å¥åœ¨ Bustub ä¸­çš„æ—…è¡Œã€‚</p>
<p><img loading="lazy" src="../../imgs/15-445-3-2.png" alt=""  />
</p>
<h3 id="parser">Parser<a hidden class="anchor" aria-hidden="true" href="#parser">#</a></h3>
<p>ä¸€æ¡ sql è¯­å¥ï¼Œé¦–å…ˆç»è¿‡ Parser ç”Ÿæˆä¸€æ£µæŠ½è±¡è¯­æ³•æ ‘ ASTã€‚å…·ä½“å¦‚ä½•ç”Ÿæˆï¼Œè¯·å‚è€ƒç¼–è¯‘åŸç†ã€‚Parser ä¸æ˜¯æ•°æ®åº“çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œå› æ­¤é™¤éçƒ­çˆ±ç¼–è¯‘åŸç†ï¼Œæˆ–è€…æƒ³é€šè¿‡å®ç°ä¸€ä¸ª sql Parser å¯¹ç¼–è¯‘åŸç†è¿›è¡Œå®è·µï¼Œå¦åˆ™ä¸€èˆ¬éƒ½ä¼šé‡‡ç”¨ç¬¬ä¸‰æ–¹åº“ã€‚Bustub ä¸­é‡‡ç”¨äº† libpg_query åº“å°† sql è¯­å¥ parse ä¸º ASTã€‚</p>
<h3 id="binder">Binder<a hidden class="anchor" aria-hidden="true" href="#binder">#</a></h3>
<p>åœ¨å¾—åˆ° AST åï¼Œè¿˜éœ€è¦å°†è¿™äº›è¯è¯­ç»‘å®šåˆ°æ•°æ®åº“å®ä½“ä¸Šï¼Œè¿™å°±æ˜¯ Binder çš„å·¥ä½œã€‚ä¾‹å¦‚æœ‰è¿™æ ·ä¸€æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">colA</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">table1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>å…¶ä¸­ <code>SELECT</code> å’Œ <code>FROM</code> æ˜¯å…³é”®å­—ï¼Œ<code>colA</code> å’Œ <code>table1</code> æ˜¯æ ‡è¯†ç¬¦ã€‚Binder éå† ASTï¼Œå°†è¿™äº›è¯è¯­ç»‘å®šåˆ°ç›¸åº”çš„å®ä½“ä¸Šã€‚å®ä½“æ˜¯ Bustub å¯ä»¥ç†è§£çš„å„ç§ c++ ç±»ã€‚ç»‘å®šå®Œæˆåï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ä¸€æ£µ Bustub å¯ä»¥ç›´æ¥ç†è§£çš„æ ‘ã€‚æŠŠå®ƒå«åš Bustub ASTã€‚</p>
<h3 id="planner">Planner<a hidden class="anchor" aria-hidden="true" href="#planner">#</a></h3>
<p>å¾—åˆ° Bustub AST åï¼ŒPlanner éå†è¿™æ£µæ ‘ï¼Œç”Ÿæˆåˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’ã€‚æŸ¥è¯¢è®¡åˆ’ä¹Ÿæ˜¯ä¸€æ£µæ ‘çš„å½¢å¼ã€‚ä¾‹å¦‚è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>å¯¹åº”çš„åŸå§‹çš„æŸ¥è¯¢è®¡åˆ’æ˜¯</p>
<p><img loading="lazy" src="../../imgs/15-445-3-3.png" alt=""  />
</p>
<p>æŸ¥è¯¢è®¡åˆ’è§„å®šäº†æ•°æ®çš„æµå‘ã€‚æ•°æ®ä»æ ‘å¶æµå‘æ ‘æ ¹ï¼Œè‡ªåº•å‘ä¸Šåœ°æµåŠ¨ï¼Œåœ¨æ ¹èŠ‚ç‚¹è¾“å‡ºç»“æœã€‚</p>
<h3 id="optimizer">Optimizer<a hidden class="anchor" aria-hidden="true" href="#optimizer">#</a></h3>
<p>ç”± Planner å¾—åˆ°åˆæ­¥çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå†å°†æŸ¥è¯¢è®¡åˆ’äº¤ç»™ Optimizer è¿›è¡Œä¿®æ”¹ä¼˜åŒ–ï¼Œç”Ÿæˆä¼˜åŒ–è¿‡åçš„æœ€ç»ˆæŸ¥è¯¢è®¡åˆ’ã€‚Optimizer ä¸»è¦æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼š</p>
<ol>
<li>Rule-based. Optimizer éå†åˆæ­¥æŸ¥è¯¢è®¡åˆ’ï¼Œæ ¹æ®å·²ç»å®šä¹‰å¥½çš„ä¸€ç³»åˆ—è§„åˆ™ï¼Œå¯¹ PlanNode è¿›è¡Œä¸€ç³»åˆ—çš„ä¿®æ”¹ã€èšåˆç­‰æ“ä½œã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨ Task 3 ä¸­å°†è¦å®ç°çš„ï¼Œå°† Limit + Sort åˆå¹¶ä¸º TopNã€‚è¿™ç§ Optimizer ä¸éœ€è¦çŸ¥é“æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œä»…æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„è§„åˆ™ä¿®æ”¹ Plan Nodeã€‚</li>
<li>Cost-based. è¿™ç§ Optimizer é¦–å…ˆéœ€è¦è¯»å–æ•°æ®ï¼Œåˆ©ç”¨ç»Ÿè®¡å­¦æ¨¡å‹æ¥é¢„æµ‹ä¸åŒå½¢å¼ä½†ç»“æœç­‰ä»·çš„æŸ¥è¯¢è®¡åˆ’çš„ costã€‚æœ€ç»ˆé€‰å‡º cost æœ€å°çš„æŸ¥è¯¢è®¡åˆ’ä½œä¸ºæœ€ç»ˆçš„æŸ¥è¯¢è®¡åˆ’ã€‚</li>
</ol>
<p>Bustub çš„ Optimizer é‡‡ç”¨ç¬¬ä¸€ç§å®ç°æ–¹å¼ã€‚MIT6.830 çš„ SimpleDB åˆ™æ˜¯é‡‡ç”¨ç¬¬äºŒç§æ–¹å¼ï¼Œæœ‰å…´è¶£ä¹Ÿå¯ä»¥çœ‹çœ‹ã€‚</p>
<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒPlanner ç”Ÿæˆçš„æ˜¯ Logical Plan Nodeï¼Œä»£è¡¨æŠ½è±¡çš„ Planã€‚Optimizer åˆ™ç”Ÿæˆ Physical Plan Nodeï¼Œä»£è¡¨å…·ä½“æ‰§è¡Œçš„ Planã€‚ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯ Joinã€‚åœ¨ Planner ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin å°±æ˜¯ Joinã€‚åœ¨ Optimizer ç”Ÿæˆçš„æŸ¥è¯¢è®¡åˆ’ä¸­ï¼ŒJoin ä¼šè¢«ä¼˜åŒ–æˆå…·ä½“çš„ HashJoin æˆ– NestedIndexJoin ç­‰ç­‰ã€‚åœ¨ Bustub ä¸­ï¼Œå¹¶ä¸åŒºåˆ† Logical Plan Node å’Œ Physical Plan Nodeã€‚Planner ä¼šç›´æ¥ç”Ÿæˆ Physical Plan Nodeã€‚</p>
<h3 id="executor">Executor<a hidden class="anchor" aria-hidden="true" href="#executor">#</a></h3>
<p>åœ¨æ‹¿åˆ° Optimizer ç”Ÿæˆçš„å…·ä½“çš„æŸ¥è¯¢è®¡åˆ’åï¼Œå°±å¯ä»¥ç”ŸæˆçœŸæ­£æ‰§è¡ŒæŸ¥è¯¢è®¡åˆ’çš„ä¸€ç³»åˆ—ç®—å­äº†ã€‚ç®—å­ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ Project 3 ä¸­éœ€è¦å®ç°çš„ä¸»è¦å†…å®¹ã€‚ç”Ÿæˆç®—å­çš„æ­¥éª¤å¾ˆç®€å•ï¼Œéå†æŸ¥è¯¢è®¡åˆ’æ ‘ï¼Œå°†æ ‘ä¸Šçš„ PlanNode æ›¿æ¢æˆå¯¹åº”çš„ Executorã€‚ç®—å­çš„æ‰§è¡Œæ¨¡å‹ä¹Ÿå¤§è‡´åˆ†ä¸ºä¸‰ç§ï¼š</p>
<ol>
<li>Iterator Modelï¼Œæˆ– Pipeline Modelï¼Œæˆ–ç«å±±æ¨¡å‹ã€‚æ¯ä¸ªç®—å­éƒ½æœ‰ <code>Init()</code> å’Œ <code>Next()</code> ä¸¤ä¸ªæ–¹æ³•ã€‚<code>Init()</code> å¯¹ç®—å­è¿›è¡Œåˆå§‹åŒ–å·¥ä½œã€‚<code>Next()</code> åˆ™æ˜¯å‘ä¸‹å±‚ç®—å­è¯·æ±‚ä¸‹ä¸€æ¡æ•°æ®ã€‚å½“ <code>Next()</code> è¿”å› false æ—¶ï¼Œåˆ™ä»£è¡¨ä¸‹å±‚ç®—å­å·²ç»æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œè¿­ä»£ç»“æŸã€‚å¯ä»¥çœ‹åˆ°ï¼Œç«å±±æ¨¡å‹ä¸€æ¬¡è°ƒç”¨è¯·æ±‚ä¸€æ¡æ•°æ®ï¼Œå ç”¨å†…å­˜è¾ƒå°ï¼Œä½†å‡½æ•°è°ƒç”¨å¼€é”€å¤§ï¼Œç‰¹åˆ«æ˜¯è™šå‡½æ•°è°ƒç”¨é€ æˆ cache miss ç­‰é—®é¢˜ã€‚</li>
<li>Materialization Model. æ‰€æœ‰ç®—å­ç«‹å³è®¡ç®—å‡ºæ‰€æœ‰ç»“æœå¹¶è¿”å›ã€‚å’Œ Iterator Model ç›¸åã€‚è¿™ç§æ¨¡å‹çš„å¼Šç«¯æ˜¾è€Œæ˜“è§ï¼Œå½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆé«˜ã€‚ä½†å‡å°‘äº†å‡½æ•°è°ƒç”¨çš„å¼€é”€ã€‚æ¯”è¾ƒé€‚åˆæŸ¥è¯¢æ•°æ®é‡è¾ƒå°çš„ OLTP workloadsã€‚</li>
<li>Vectorization Model. å¯¹ä¸Šé¢ä¸¤ç§æ¨¡å‹çš„ä¸­å’Œï¼Œä¸€æ¬¡è°ƒç”¨è¿”å›ä¸€æ‰¹æ•°æ®ã€‚åˆ©äº SIMD åŠ é€Ÿã€‚ç›®å‰æ¯”è¾ƒå…ˆè¿›çš„ OLAP æ•°æ®åº“éƒ½é‡‡ç”¨è¿™ç§æ¨¡å‹ã€‚</li>
</ol>
<p>Bustub é‡‡ç”¨çš„æ˜¯ Iterator Modelã€‚</p>
<p>æ­¤å¤–ï¼Œç®—å­çš„æ‰§è¡Œæ–¹å‘ä¹Ÿæœ‰ä¸¤ç§ï¼š</p>
<ol>
<li>Top-to-Bottom. ä»æ ¹èŠ‚ç‚¹ç®—å­å¼€å§‹ï¼Œä¸æ–­åœ° pull ä¸‹å±‚ç®—å­çš„æ•°æ®ã€‚</li>
<li>Bottom-to-Top. ä»å¶å­èŠ‚ç‚¹ç®—å­å¼€å§‹ï¼Œå‘ä¸Šå±‚ç®—å­ push è‡ªå·±çš„æ•°æ®ã€‚</li>
</ol>
<p>Bustub é‡‡ç”¨ Top-to-Bottomã€‚</p>
<p>åœ¨æ ¹èŠ‚ç‚¹ç®—å­å¤„ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢çš„æ•°æ®ï¼Œä¸€æ¡ sql è¯­å¥å®Œæˆäº†å®ƒçš„ä½¿å‘½ã€‚</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬åœ¨ Project 1 ä¸­å®ç°çš„ Buffer Pool å’Œåœ¨ Project 2 ä¸­å®ç°çš„ B+Tree Index åœ¨å“ªé‡Œï¼Ÿå®é™…ä¸Šå°±åœ¨ä¸€ç³»åˆ—ç®—å­ä¸‹ã€‚ä¾‹å¦‚ SeqScan ç®—å­ï¼Œéœ€è¦éå† tableï¼Œé¦–å…ˆé€šè¿‡æ•°æ®åº“çš„ catalog æ‰¾åˆ°å¯¹åº”çš„ tableï¼Œä¸€ä¸ª table ç”±è®¸å¤š page ç»„æˆï¼Œåœ¨è®¿é—® page æ—¶ï¼Œå°±ç”¨åˆ°äº† Buffer Poolã€‚åœ¨ Optimizer ä¸­ï¼Œå‡å¦‚å‘ç° Sort ç®—å­åœ¨å¯¹ indexed attribute æ’åºï¼Œä¼šå°† Sort ç®—å­ä¼˜åŒ–ä¸º IndexScan ç®—å­ï¼Œè¿™æ ·å°±ç”¨åˆ°äº† B+Tree Indexã€‚</p>
<p>Bustub Query Execution çš„å¤§è‡´ç»“æ„å°±æ˜¯è¿™æ ·ï¼Œè¿˜æœ‰å¾ˆå¤šè®¾è®¡ä¸Šçš„ç»†èŠ‚æ²¡æœ‰æåˆ°ï¼Œæ¯”å¦‚ Tupleã€Valueã€AbstractExpression ç­‰ç­‰ã€‚æ¥ä¸‹æ¥åœ¨å…·ä½“å®ç°ä¸­è¾¹çœ‹è¾¹èŠã€‚</p>
<h2 id="task-1-access-method-executors">Task 1 Access Method Executors<a hidden class="anchor" aria-hidden="true" href="#task-1-access-method-executors">#</a></h2>
<p>Task 1 åŒ…å« 4 ä¸ªç®—å­ï¼ŒSeqScanã€Insertã€Delete å’Œ IndexScanã€‚</p>
<h3 id="seqscan">SeqScan<a hidden class="anchor" aria-hidden="true" href="#seqscan">#</a></h3>
<p>è¯»å–ç»™å®š table ä¸­çš„æ‰€æœ‰ tupleï¼Œä»…ä¼šå‡ºç°åœ¨æŸ¥è¯¢è®¡åˆ’çš„å¶å­èŠ‚ç‚¹å¤„ã€‚ç›´æ¥ä½¿ç”¨å·²ç»æä¾›çš„ <code>TableIterator</code>ã€‚å®ç°èµ·æ¥æŒºç®€å•çš„ã€‚æ­¤å¤–ä¸»è¦æƒ³èŠèŠ Bustub ä¸­ table çš„ç»“æ„ã€‚</p>
<p><img loading="lazy" src="../../imgs/15-445-3-4.png" alt=""  />
</p>
<p>é¦–å…ˆï¼ŒBustub æœ‰ä¸€ä¸ª Catalogã€‚Catalog æä¾›äº†ä¸€ç³»åˆ— APIï¼Œä¾‹å¦‚ <code>CreateTable()</code>ã€<code>GetTable()</code> ç­‰ç­‰ã€‚Catalog ç»´æŠ¤äº†å‡ å¼  hashmapï¼Œä¿å­˜äº† table id å’Œ table name åˆ° table info çš„æ˜ å°„å…³ç³»ã€‚table id ç”± Catalog åœ¨æ–°å»º table æ—¶è‡ªåŠ¨åˆ†é…ï¼Œtable name åˆ™ç”±ç”¨æˆ·æŒ‡å®šã€‚</p>
<p>è¿™é‡Œçš„ table info åŒ…å«äº†ä¸€å¼  table çš„ metadataï¼Œæœ‰ schemaã€nameã€id å’ŒæŒ‡å‘ table heap çš„æŒ‡é’ˆã€‚ç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†æƒ³è¦è®¿é—®ä¸€å¼  table æ—¶ï¼Œå…ˆä½¿ç”¨ name æˆ– id ä» Catalog å¾—åˆ° table infoï¼Œå†è®¿é—® table info ä¸­çš„ table heapã€‚</p>
<p>table heap æ˜¯ç®¡ç† table æ•°æ®çš„ç»“æ„ï¼ŒåŒ…å« <code>InsertTuple()</code>ã€<code>MarkDelete()</code> ä¸€ç³»åˆ— table ç›¸å…³æ“ä½œã€‚table heap æœ¬èº«å¹¶ä¸ç›´æ¥å­˜å‚¨ tuple æ•°æ®ï¼Œtuple æ•°æ®éƒ½å­˜æ”¾åœ¨ table page ä¸­ã€‚table heap å¯èƒ½ç”±å¤šä¸ª table page ç»„æˆï¼Œä»…ä¿å­˜å…¶ç¬¬ä¸€ä¸ª table page çš„ page idã€‚éœ€è¦è®¿é—®æŸä¸ª table page æ—¶ï¼Œé€šè¿‡ page id ç»ç”± buffer pool è®¿é—®ã€‚</p>
<p>table page æ˜¯å®é™…å­˜å‚¨ table æ•°æ®çš„ç»“æ„ï¼Œçˆ¶ç±»æ˜¯ pageã€‚ç›¸è¾ƒäº pageï¼Œtable page å¤šäº†ä¸€äº›æ–°çš„æ–¹æ³•ã€‚table page åœ¨ data çš„å¼€å¤´å­˜æ”¾äº† next page idã€prev page id ç­‰ä¿¡æ¯ï¼Œå°†å¤šä¸ª table page è¿æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œä¾¿äºæ•´å¼  table çš„éå†æ“ä½œã€‚å½“éœ€è¦æ–°å¢ tuple æ—¶ï¼Œtable heap ä¼šæ‰¾åˆ°å½“å‰å±äºè‡ªå·±çš„æœ€åä¸€å¼  table pageï¼Œå°è¯•æ’å…¥ï¼Œè‹¥æœ€åä¸€å¼  table page å·²æ»¡ï¼Œåˆ™æ–°å»ºä¸€å¼  table page æ’å…¥ tupleã€‚table page ä½åœ°å€å­˜æ”¾ headerï¼Œtuple ä»é«˜åœ°å€ä¹Ÿå°±æ˜¯ table page å°¾éƒ¨å¼€å§‹æ’å…¥ã€‚</p>
<p>tuple å¯¹åº”æ•°æ®è¡¨ä¸­çš„ä¸€è¡Œæ•°æ®ã€‚æ¯ä¸ª tuple éƒ½ç”± RID å”¯ä¸€æ ‡è¯†ã€‚RID ç”± page id + slot num æ„æˆã€‚tuple ç”± value ç»„æˆï¼Œvalue çš„ä¸ªæ•°å’Œç±»å‹ç”± table info ä¸­çš„ schema æŒ‡å®šã€‚</p>
<p>value åˆ™æ˜¯æŸä¸ªå­—æ®µå…·ä½“çš„å€¼ï¼Œvalue æœ¬èº«è¿˜ä¿å­˜äº†ç±»å‹ä¿¡æ¯ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œexecutor æœ¬èº«å¹¶ä¸ä¿å­˜æŸ¥è¯¢è®¡åˆ’çš„ä¿¡æ¯ï¼Œåº”è¯¥é€šè¿‡ executor çš„æˆå‘˜ plan æ¥å¾—çŸ¥è¯¥å¦‚ä½•è¿›è¡Œæœ¬æ¬¡è®¡ç®—ï¼Œä¾‹å¦‚ SeqScanExecutor éœ€è¦å‘ SeqScanPlanNode è¯¢é—®è‡ªå·±è¯¥æ‰«æå“ªå¼ è¡¨ã€‚</p>
<p>æ‰€æœ‰è¦ç”¨åˆ°çš„ç³»ç»Ÿèµ„æºï¼Œä¾‹å¦‚ Catalogï¼ŒBuffer Pool ç­‰ï¼Œéƒ½ç”± <code>ExecutorContext</code> æä¾›ã€‚</p>
<h3 id="insert--delete">Insert &amp; Delete<a hidden class="anchor" aria-hidden="true" href="#insert--delete">#</a></h3>
<p>Insert å’Œ Delete è¿™ä¸¤ä¸ªç®—å­å®ç°èµ·æ¥åŸºæœ¬ä¸€æ ·ï¼Œä¹Ÿæ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯å”¯äºŒçš„å†™ç®—å­ã€‚æ•°æ®åº“æœ€ä¸»è¦çš„æ“ä½œå°±æ˜¯å¢æŸ¥åˆ æ”¹ã€‚Bustub sql å±‚æš‚æ—¶ä¸æ”¯æŒ UPDATEã€‚Insert å’Œ Delete ä¸€å®šæ˜¯æŸ¥è¯¢è®¡åˆ’çš„æ ¹èŠ‚ç‚¹ï¼Œä¸”ä»…éœ€è¿”å›ä¸€ä¸ªä»£è¡¨ä¿®æ”¹è¡Œæ•°çš„ tupleã€‚</p>
<p>Insert å’Œ Delete æ—¶ï¼Œè®°å¾—è¦æ›´æ–°ä¸ table ç›¸å…³çš„æ‰€æœ‰ indexã€‚index ä¸ table ç±»ä¼¼ï¼ŒåŒæ ·ç”± Catalog ç®¡ç†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºå¯ä»¥å¯¹ä¸åŒçš„å­—æ®µå»ºç«‹ indexï¼Œä¸€ä¸ª table å¯èƒ½å¯¹åº”å¤šä¸ª indexï¼Œæ‰€æœ‰çš„ index éƒ½éœ€è¦æ›´æ–°ã€‚</p>
<p>Insert æ—¶ï¼Œç›´æ¥å°† tuple è¿½åŠ è‡³ table å°¾éƒ¨ã€‚Delete æ—¶ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Œè€Œæ˜¯å°† tuple æ ‡è®°ä¸ºåˆ é™¤çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯é€»è¾‘åˆ é™¤ã€‚ï¼ˆåœ¨äº‹åŠ¡æäº¤åï¼Œå†è¿›è¡Œç‰©ç†åˆ é™¤ï¼ŒProject 3 ä¸­æ— éœ€å®ç°ï¼‰</p>
<p>Insert &amp; Delete çš„ <code>Next()</code> åªä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä¸€ä¸ª integer value çš„ tupleï¼Œè¡¨ç¤º table ä¸­æœ‰å¤šå°‘è¡Œå—åˆ°äº†å½±å“ã€‚</p>
<h3 id="indexscan">IndexScan<a hidden class="anchor" aria-hidden="true" href="#indexscan">#</a></h3>
<p>ä½¿ç”¨æˆ‘ä»¬åœ¨ Project 2 ä¸­å®ç°çš„ B+Tree Index Iteratorï¼Œéå† B+ æ ‘å¶å­èŠ‚ç‚¹ã€‚ç”±äºæˆ‘ä»¬å®ç°çš„æ˜¯éèšç°‡ç´¢å¼•ï¼Œåœ¨å¶å­èŠ‚ç‚¹åªèƒ½è·å–åˆ° RIDï¼Œéœ€è¦æ‹¿ç€ RID å» table æŸ¥è¯¢å¯¹åº”çš„ tupleã€‚</p>
<p>åœ¨å®Œæˆ Task 1 çš„å››ä¸ªç®—å­åï¼Œå¯ä»¥ç”¨å·²æä¾›çš„ sqllogictest å·¥å…·å’Œå·²æä¾›çš„ä¸€äº› sql æ¥æ£€éªŒè‡ªå·±çš„ç®—å­æ˜¯å¦å®ç°æ­£ç¡®ã€‚</p>
<p>å…³äº Task 1 çš„å…·ä½“å®ç°çš„ç¡®æ²¡å¤ªå¤šå¯è¯´çš„ï¼ŒåŸºæœ¬æ˜¯æŠŠå®˜ç½‘çš„ instruction ç¿»è¯‘äº†ä¸€éã€‚åé¢å‡ ä¸ª task éš¾åº¦ä¼šç¨å¤§ä¸€ç‚¹ç‚¹ï¼Œä¹Ÿä¼šè®²è®²æ›´å…·ä½“çš„å®ç°ã€‚</p>
<h2 id="task-2-aggregation--join-executors">Task 2 Aggregation &amp; Join Executors<a hidden class="anchor" aria-hidden="true" href="#task-2-aggregation--join-executors">#</a></h2>
<p>Task 2 åŒ…å«äº† 3 ä¸ªç®—å­ï¼ŒAggregationã€NestedLoopJoin å’Œ NestedIndexJoinã€‚</p>
<h3 id="aggregation">Aggregation<a hidden class="anchor" aria-hidden="true" href="#aggregation">#</a></h3>
<p>Aggregation ç®—å­å°±ç¨å¾®å¤æ‚ä¸€ç‚¹äº†ã€‚å…ˆçœ‹çœ‹ <code>AggregationExecutor</code> çš„æˆå‘˜ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/** The aggregation plan node */</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="n">AggregationPlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** The child executor that produces tuples over which the aggregation is computed */</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">child_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** Simple aggregation hash table */</span>
</span></span><span class="line"><span class="cl"><span class="n">SimpleAggregationHashTable</span> <span class="n">aht_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** Simple aggregation hash table iterator */</span>
</span></span><span class="line"><span class="cl"><span class="n">SimpleAggregationHashTable</span><span class="o">::</span><span class="n">Iterator</span> <span class="n">aht_iterator_</span><span class="p">;</span>
</span></span></code></pre></div><p>ä¸»è¦è¯´è¯´è¿™ä¸ª <code>SimpleAggregationHashTable</code>ã€‚Aggregation æ˜¯ pipeline breakerã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒAggregation ç®—å­ä¼šæ‰“ç ´ iteration model çš„è§„åˆ™ã€‚åŸå› æ˜¯ï¼Œåœ¨ Aggregation çš„ <code>Init()</code> å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å°±è¦å°†æ‰€æœ‰ç»“æœå…¨éƒ¨è®¡ç®—å‡ºæ¥ã€‚åŸå› å¾ˆç®€å•ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ç»“æœçš„æ¯æ¡ tuple éƒ½æ˜¯ä¸€ä¸ª <code>t.x</code> çš„èšåˆï¼Œè€Œè¦å¾—åˆ°åŒä¸€ä¸ª <code>t.x</code> å¯¹åº”çš„ <code>max(t.y)</code>ï¼Œå¿…é¡»è¦éå†æ•´å¼ è¡¨ã€‚å› æ­¤ï¼ŒAggregation éœ€è¦åœ¨ <code>Init()</code> ä¸­ç›´æ¥è®¡ç®—å‡ºå…¨éƒ¨ç»“æœï¼Œå°†ç»“æœæš‚å­˜ï¼Œå†åœ¨ <code>Next()</code> ä¸­ä¸€æ¡ä¸€æ¡åœ° emitã€‚è€Œ <code>SimpleAggregationHashTable</code> å°±æ˜¯è®¡ç®—å¹¶ä¿å­˜ Aggregation ç»“æœçš„æ•°æ®ç»“æ„ã€‚</p>
<p><code>SimpleAggregationHashTable</code> ç»´æŠ¤ä¸€å¼  hashmapï¼Œé”®ä¸º <code>AggregateKey</code>ï¼Œå€¼ä¸º <code>AggregateValue</code>ï¼Œå‡ä¸º <code>std::vector&lt;Value&gt;</code>ã€‚key ä»£è¡¨ group by çš„å­—æ®µçš„æ•°ç»„ï¼Œvalue åˆ™æ˜¯éœ€è¦ aggregate çš„å­—æ®µçš„æ•°ç»„ã€‚åœ¨ä¸‹å±‚ç®—å­ä¼ æ¥ä¸€ä¸ª tuple æ—¶ï¼Œå°† tuple çš„ group by å­—æ®µå’Œ aggregate å­—æ®µåˆ†åˆ«æå–å‡ºæ¥ï¼Œè°ƒç”¨ <code>InsertCombine()</code> å°† group by å’Œ aggregate çš„æ˜ å°„å…³ç³»å­˜å…¥ <code>SimpleAggregationHashTable</code>ã€‚è‹¥å½“å‰ hashmap ä¸­æ²¡æœ‰ group by çš„è®°å½•ï¼Œåˆ™åˆ›å»ºåˆå€¼ï¼›è‹¥å·²æœ‰è®°å½•ï¼Œåˆ™æŒ‰ aggregate è§„åˆ™é€ä¸€æ›´æ–°æ‰€æœ‰çš„ aggregate å­—æ®µï¼Œä¾‹å¦‚å– max/minï¼Œæ±‚ sum ç­‰ç­‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">),</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>group byï¼ˆAggregateKeyï¼‰ä¸º <code>{t.x, t.y}</code>ï¼Œaggregateï¼ˆAggregateValueï¼‰ä¸º <code>{t.z, t.z, t.z}</code>ã€‚aggregate è§„åˆ™ä¸º <code>{min, max, sum}</code>ã€‚</p>
<p>éœ€è¦é¢å¤–æ³¨æ„çš„æ˜¯ <code>count(column)</code> å’Œ <code>count(*)</code> çš„åŒºåˆ«ï¼Œä»¥åŠå¯¹ç©ºå€¼çš„å¤„ç†ã€‚å¦å¤–ï¼Œä¸éœ€è¦è€ƒè™‘ hashmap è¿‡å¤§çš„æƒ…å†µï¼Œå³æ•´å¼  hashmap å¯ä»¥é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œä¸éœ€è¦é€šè¿‡ Buffer Pool è°ƒç”¨ page æ¥å­˜å‚¨ã€‚</p>
<p>åœ¨ <code>Init()</code> ä¸­è®¡ç®—å‡ºæ•´å¼  hashmap åï¼Œåœ¨ <code>Next()</code> ä¸­ç›´æ¥åˆ©ç”¨ hashmap iterator å°†ç»“æœä¾æ¬¡å–å‡ºã€‚Aggregation è¾“å‡ºçš„ schema å½¢å¼ä¸º group-bys + aggregatesã€‚</p>
<h3 id="nestedloopjoin">NestedLoopJoin<a hidden class="anchor" aria-hidden="true" href="#nestedloopjoin">#</a></h3>
<p>Project 3 ä¸­åªè¦æ±‚å®ç° NestedLoopJoinï¼ŒHashJoin ä¸åšå¼ºåˆ¶è¦æ±‚ï¼Œè€Œæ˜¯æ”¾åœ¨äº† Leaderboard Optional é‡Œã€‚å®é™…ä¸Šå®ç°ä¸€ä¸ª in-memory çš„ HashJoin ä¹Ÿä¸éš¾ã€‚Join åº”è¯¥æ˜¯ç»å…¸çš„æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆã€‚Andy åœ¨ Lecture é‡Œä¹Ÿè¯¦ç»†åœ°é‡åŒ–åœ°å¯¹æ¯”äº†å„ç§ Join çš„ costsï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ã€‚</p>
<p>NestedLoopJoin ç®—æ³•æœ¬èº«å¹¶ä¸éš¾ï¼Œä½†æ¯”è¾ƒå®¹æ˜“æ‰è¿›å‘é‡Œã€‚ä¼ªä»£ç å¤§æ¦‚æ˜¯è¿™æ ·ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">outer_tuple</span> <span class="n">in</span> <span class="nl">outer_table</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">inner_tuple</span> <span class="n">in</span> <span class="nl">inner_table</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">inner_tuple</span> <span class="n">matched</span> <span class="nl">outer_tuple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">emit</span>
</span></span></code></pre></div><p>æœ‰äº†è¿™ä¸ªä¾‹å­ï¼Œå¾ˆå®¹æ˜“æŠŠä»£ç å†™æˆï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">left_child</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">right_child</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">left_tuple</span> <span class="n">matches</span> <span class="n">right_tuple</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="p">...;</span>   <span class="c1">// assemble left &amp; right together
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span></code></pre></div><p>ä¸€å¼€å§‹çœ‹èµ·æ¥ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ç„¶è€Œå¾ˆå¿«å¯ä»¥å‘ç°æœ‰ä¸€ä¸ªä¸¥é‡çš„é”™è¯¯ï¼Œright child åœ¨ left child çš„ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­å°±è¢«æ¶ˆè€—å®Œäº†ï¼Œä¹‹ååªä¼šè¿”å› falseã€‚è§£å†³æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨ <code>Init()</code> é‡Œå…ˆæŠŠ right child é‡Œçš„æ‰€æœ‰ tuple å–å‡ºæ¥æš‚å­˜åœ¨ä¸€ä¸ªæ•°ç»„é‡Œå°±å¥½ï¼Œä¹‹åç›´æ¥è®¿é—®è¿™ä¸ªæ•°ç»„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="n">left_child</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">right_tuple</span> <span class="p">:</span> <span class="n">right_tuples</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">left_tuple</span> <span class="n">matches</span> <span class="n">right_tuple</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="p">...;</span>   <span class="c1">// assemble left &amp; right together
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span></code></pre></div><p>çœ‹èµ·æ¥å¥½åƒåˆæ²¡ä»€ä¹ˆé—®é¢˜ã€‚ç„¶è€Œï¼ŒåŒä¸€åˆ—æ˜¯å¯èƒ½å­˜åœ¨ duplicate value çš„ã€‚åœ¨ä¸Šå±‚ç®—å­æ¯æ¬¡è°ƒç”¨ NestedLoopJoin çš„ <code>Next()</code> æ—¶ï¼ŒNestedLoopJoin éƒ½ä¼šå‘ä¸‹å±‚ç®—å­è¯·æ±‚æ–°çš„ left tupleã€‚ä½†æœ‰å¯èƒ½ä¸Šä¸€ä¸ª left tuple è¿˜æ²¡æœ‰å’Œ right child ä¸­æ‰€æœ‰èƒ½åŒ¹é…çš„ tuple åŒ¹é…å®Œï¼ˆåªåŒ¹é…äº†ç¬¬ä¸€ä¸ªï¼‰ã€‚</p>
<p>ä¾‹å¦‚è¿™ä¸¤å¼ è¡¨ï¼š</p>
<pre tabindex="0"><code>   t1          t2
---------   ---------
|   x   |   |   x   |
---------   ---------
|   1   |   |   1   |
|   2   |   |   1   |
|   3   |   |   2   |
---------   ---------
</code></pre><p>ç°åœ¨æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">INNER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">x</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>t1 ä¸­çš„ 1 åªä¼šå’Œ t2 çš„ç¬¬ä¸€ä¸ª 1 åŒ¹é…ï¼Œäº§ç”Ÿä¸€è¡Œè¾“å‡ºã€‚å†ä¸‹ä¸€æ¬¡è°ƒç”¨ <code>Next()</code> æ—¶ï¼Œå·¦è¾¹ä¼šç›´æ¥é€‰å– 2 å¼€å§‹å°è¯•åŒ¹é…ã€‚</p>
<p>è§£å†³æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨ç®—å­é‡Œæš‚å­˜ left tupleï¼Œæ¯æ¬¡è°ƒç”¨ <code>Next()</code> æ—¶ï¼Œå…ˆç”¨æš‚å­˜çš„ left tuple å°è¯•åŒ¹é…ã€‚å¹¶ä¸”è¦è®°å½•ä¸Šä¸€æ¬¡å³è¡¨åŒ¹é…åˆ°çš„ä½ç½®ï¼Œä¸è¦æ¯æ¬¡éƒ½ç›´æ¥ä»å³è¡¨ç¬¬ä¸€è¡Œå¼€å§‹åŒ¹é…äº†ã€‚å³è¡¨éå†å®Œè¿˜æ²¡æœ‰åŒ¹é…ç»“æœï¼Œå†å»æ‰¾å·¦è¡¨è¦ä¸‹ä¸€ä¸ª tupleã€‚</p>
<p>è¯´æ¥è¯´å»ï¼Œå®é™…ä¸Šå°±æ˜¯æ³¨æ„è¿­ä»£å™¨è¦ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<p>INNER JOIN å’Œ LEFT JOIN æŒ‰è§„åˆ™å®ç°å°±å¥½ï¼Œå·®ä¸å¤šã€‚LEFT JOIN æ³¨æ„å¤„ç†ç©ºå€¼ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜ï¼Œæ€ä¹ˆåˆ¤æ–­ä¸¤ä¸ª tuple æ˜¯å¦åŒ¹é…ï¼Ÿè¿™é‡Œå°±è¦ç¬¬ä¸€æ¬¡é‡åˆ° Project 3 é‡Œå¦ä¸€ä¸ªé‡è¦çš„ç±» <code>AbstractExpression</code> äº†ã€‚</p>
<p><code>AbstractExpression</code> æŠ½è±¡äº† sql ä¸­çš„å„ç§è¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬ <code>ArithmeticExpression</code>ã€<code>ColumnValueExpression</code>ã€<code>ComparisonExpression</code>ã€<code>ConstantValueExpression</code> å’Œ <code>LogicExpression</code>ã€‚è¿™éƒ½æ˜¯ä»€ä¹ˆï¼Ÿçœ‹ä¸‹é¢è¿™æ¡ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>é‡ç‚¹å…³æ³¨ <code>WHERE</code> åçš„è¡¨è¾¾å¼ <code>t1.x = t1.y + 1 AND t1.y &gt; 0</code>ã€‚çœ‹è¿™ä¸‹é¢è¿™å¼ å›¾ï¼š</p>
<p><img loading="lazy" src="../../imgs/15-445-3-5.png" alt=""  />
</p>
<p>å…¶å®å°±æ˜¯ä¸€é¢—è¡¨è¾¾å¼æ ‘ã€‚<code>AbstractExpression</code> å°±æ˜¯è¡¨è¾¾å¼æ ‘çš„èŠ‚ç‚¹ã€‚sql ä¸­çš„æ‰€æœ‰è¡¨è¾¾å¼éƒ½ä¼šè¢« parse ä¸ºè¡¨è¾¾å¼æ ‘ï¼Œåœ¨ Binder ä¸­è¿›è¡Œç»‘å®šã€‚ä¸Šé¢çš„ JOIN ä¸­ä¹Ÿå­˜åœ¨è¡¨è¾¾å¼ <code>t1.x = t2.x</code>ã€‚<code>AbstractExpression</code> é‡Œæœ€é‡è¦çš„æ–¹æ³•å°±æ˜¯ <code>Evaluate()</code>ï¼Œè¿”å›å€¼æ˜¯ valueã€‚è°ƒç”¨ <code>Evaluate()</code>ï¼Œå‚æ•°ä¸º tuple å’Œ tuple å¯¹åº”çš„ schemaï¼Œè¿”å›ä»è¿™ä¸ª tuple ä¸­æå–æ•°æ®åä»£å…¥è¡¨è¾¾å¼è®¡ç®—å¾—åˆ°çš„ç»“æœã€‚</p>
<p>åœ¨ NestedLoopJoin é‡Œï¼Œæˆ‘ä»¬è¦ç”¨åˆ°çš„æ˜¯ <code>EvaluateJoin()</code>ï¼Œä¹Ÿå·®ä¸å¤šï¼Œåªä¸è¿‡è¾“å…¥çš„æ˜¯å·¦å³ä¸¤ä¸ª tuple å’Œ schemaã€‚è¿”å›å€¼æ˜¯è¡¨ç¤º true æˆ– false çš„ valueã€‚true åˆ™ä»£è¡¨æˆåŠŸåŒ¹é…ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒNestedLoopJoin å°±æˆåŠŸå®ç°äº†ã€‚Join è¾“å‡ºçš„ schema ä¸º left schema + right schemaã€‚</p>
<p>åæ¥æˆ‘çœ‹äº†ä¸€ä¸‹ <a href="https://github.com/risinglightdb/risinglight/blob/main/src/executor_v2/nested_loop_join.rs">RisingLight</a> é‡Œçš„å®ç°ï¼Œæˆ‘è¿™ä¸ª rustacean èŒæ–°çš„ç¬¬ä¸€ååº”æ˜¯æƒŠä¸ºå¤©äººã€‚å¤§è‡´æ˜¯è¿™æ ·ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">Execute</span><span class="p">(){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">left_tuple</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">left_table</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">right_tuple</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">right_table</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">matches</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kr">yield</span><span class="w"> </span><span class="n">AssembleOutput</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå½“æ‰§è¡Œåˆ° yield æ—¶ï¼Œå‡½æ•°ä¼šæš‚æ—¶ä¸­æ–­ï¼Œä»ç”Ÿæˆå™¨å›åˆ°è°ƒç”¨è€…ã€‚è€Œè°ƒç”¨è€…å†æ¬¡è¿›å…¥ç”Ÿæˆå™¨æ—¶ï¼Œå¯ä»¥ç›´æ¥å›åˆ°ä¸Šæ¬¡ä¸­æ–­çš„åœ°æ–¹ã€‚å†é…åˆ streamï¼Œå°±åˆ©ç”¨ rust çš„æ— æ ˆåç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹å®Œç¾åœ°å®ç°äº†ä¸€ä¸ª NestedLoopJoin ç®—å­ï¼Œæ¯”æ‰‹åŠ¨ä¿å­˜ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼˜é›…å¤ªå¤šäº†ã€‚</p>
<p>åæ¥ä»”ç»†æƒ³æƒ³ï¼ŒGo ä¹Ÿå¯ä»¥æœ‰ç±»ä¼¼çš„å†™æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Executor</span><span class="p">(</span><span class="nx">out_ch</span><span class="p">,</span> <span class="nx">left_ch</span><span class="p">,</span> <span class="nx">right_ch</span> <span class="kd">chan</span> <span class="nx">Tuple</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// fetch right tuples from right_ch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">right_tuples</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">Tuple</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">right_tuple</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">right_ch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">right_tuples</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">right_tuples</span><span class="p">,</span> <span class="nx">right_tuple</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">left_tuple</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">left_ch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">right_tuple</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">right_tuples</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">matches</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">out_ch</span> <span class="o">&lt;-</span> <span class="nf">AssembleOutput</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">close</span><span class="p">(</span><span class="nx">out_ch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ¯ä¸ªç®—å­éƒ½æ˜¯ä¸€ä¸ª goroutineï¼Œé€šè¿‡ channel å®ç°å¼‚æ­¥çš„è®¡ç®—ï¼Œå¥½åƒä¹Ÿä¸é”™ã€‚</p>
<h3 id="nestedindexjoin">NestedIndexJoin<a hidden class="anchor" aria-hidden="true" href="#nestedindexjoin">#</a></h3>
<p>åœ¨è¿›è¡Œ equi-join æ—¶ï¼Œå¦‚æœå‘ç° JOIN ON å³è¾¹çš„å­—æ®µä¸Šå»ºäº† indexï¼Œåˆ™ Optimizer ä¼šå°† NestedLoopJoin ä¼˜åŒ–ä¸º NestedIndexJoinã€‚å…·ä½“å®ç°å’Œ NestedLoopJoin å·®ä¸å¤šï¼Œåªæ˜¯åœ¨å°è¯•åŒ¹é…å³è¡¨ tuple æ—¶ï¼Œä¼šæ‹¿ join key å» B+Tree Index é‡Œè¿›è¡ŒæŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ‹¿ç€æŸ¥åˆ°çš„ RID å»å³è¡¨è·å– tuple ç„¶åè£…é…æˆç»“æœè¾“å‡ºã€‚å…¶ä»–çš„å°±ä¸å†å¤šè¯´äº†ã€‚</p>
<h2 id="task-3-sort--limit-executors-and-top-n-optimization">Task 3 Sort + Limit Executors and Top-N Optimization<a hidden class="anchor" aria-hidden="true" href="#task-3-sort--limit-executors-and-top-n-optimization">#</a></h2>
<p>Task 3 ä¸­è¦å®ç° 3 ä¸ªç®—å­ï¼ŒSortã€Limit å’Œ TopNï¼Œä»¥åŠå°† Limit + Sort åœ¨ Optimizer ä¸­ä¼˜åŒ–ä¸º TopNã€‚</p>
<h3 id="sort">Sort<a hidden class="anchor" aria-hidden="true" href="#sort">#</a></h3>
<p>Sort ä¹Ÿæ˜¯ pipeline breakerã€‚åœ¨ <code>Init()</code> ä¸­è¯»å–æ‰€æœ‰ä¸‹å±‚ç®—å­çš„ tupleï¼Œå¹¶æŒ‰ ORDER BY çš„å­—æ®µå‡åºæˆ–é™åºæ’åºã€‚Sort ç®—å­è¯´èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦éœ€è¦è‡ªå®šä¹‰ <code>std::sort()</code>ã€‚</p>
<p><code>std::sort()</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥è‡ªå®šä¹‰çš„æ¯”è¾ƒå‡½æ•°ã€‚ç›´æ¥ä¼ å…¥ä¸€ä¸ª lambda åŒ¿åå‡½æ•°ã€‚ç”±äºè¦è®¿é—®æˆå‘˜ <code>plan_</code> æ¥è·å–æ’åºçš„å­—æ®µï¼Œlambda éœ€è¦æ•è· this æŒ‡é’ˆã€‚å¦å¤–ï¼Œæ’åºå­—æ®µå¯ä»¥æœ‰å¤šä¸ªï¼ŒæŒ‰å…ˆåé¡ºåºæ¯”è¾ƒã€‚ç¬¬ä¸€ä¸ªä¸ç›¸ç­‰ï¼Œç›´æ¥å¾—åˆ°ç»“æœï¼›ç›¸ç­‰ï¼Œåˆ™æ¯”è¾ƒç¬¬äºŒä¸ªã€‚ä¸ä¼šå‡ºç°æ‰€æœ‰å­—æ®µå…¨éƒ¨ç›¸ç­‰çš„æƒ…å†µã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">sorted_tuples_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">sorted_tuples_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="p">[</span><span class="n">order_by_type</span><span class="p">,</span> <span class="n">expr</span><span class="p">]</span> <span class="o">:</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetOrderBy</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// compare and return ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">UNREACHABLE</span><span class="p">(</span><span class="s">&#34;doesn&#39;t support duplicate key&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><h3 id="limit">Limit<a hidden class="anchor" aria-hidden="true" href="#limit">#</a></h3>
<p>å’Œ SeqScan åŸºæœ¬ä¸€æ¨¡ä¸€æ ·ï¼Œåªä¸è¿‡åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª countï¼Œè®°å½•å·²ç» emit äº†å¤šå°‘ tupleã€‚å½“ä¸‹å±‚ç®—å­ç©ºäº†æˆ– count è¾¾åˆ°è§„å®šä¸Šé™åï¼Œä¸å†è¿”å›æ–°çš„ tupleã€‚</p>
<h3 id="topn">TopN<a hidden class="anchor" aria-hidden="true" href="#topn">#</a></h3>
<p>ä»…éœ€è¿”å›æœ€å¤§/æœ€å°çš„ n ä¸ª tupleã€‚ä¸€å¼€å§‹æƒ³ç€è¦å®ç°ä¸€ä¸ª fixed-size priority queueï¼Œå³ queue å¤§å°è¶…è¿‡é™åˆ¶æ—¶è‡ªåŠ¨æŠ›å¼ƒæœ€åä¸€ä¸ªå…ƒç´ ä»¥å‡å°å†…å­˜å ç”¨ï¼Œä½†åæ¥å®åœ¨ä¸æƒ³è‡ªå·±é‡å†™ä¸€éäºŒå‰å †ï¼Œå°±å¼€æ‘†äº†ã€‚ç›´æ¥ç”¨ <code>std::priority_queue</code> åŠ è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œç„¶ååœ¨ <code>Init()</code> ä¸­éå†ä¸‹å±‚ç®—å­æ‰€æœ‰ tupleï¼Œå…¨éƒ¨å¡è¿›ä¼˜å…ˆé˜Ÿåˆ—åæˆªå–å‰ n ä¸ªã€‚å† <code>Next()</code> é‡Œä¸€ä¸ªä¸€ä¸ªè¾“å‡ºã€‚ï¼ˆæ˜¯ä¸æ˜¯å’Œ Limit + Sort æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Ÿéƒ½æ˜¯ O(nlogn)</p>
<h3 id="sort--limit-as-topn">Sort + Limit As TopN<a hidden class="anchor" aria-hidden="true" href="#sort--limit-as-topn">#</a></h3>
<p>è¿™æ˜¯ Project 3 é‡Œæœ€åä¸€ä¸ªå¿…åšçš„å°é—®ã€‚ç»ˆäºä¸æ˜¯å®ç°ç®—å­äº†ï¼Œè€Œæ˜¯åœ¨ Optimizer é‡Œå¢åŠ ä¸€æ¡è§„åˆ™ï¼Œå°† Sort + Limit ä¼˜åŒ–ä¸º TopNã€‚å…ˆçœ‹çœ‹ Optimizer æ˜¯å¦‚ä½•æ‰§è¡Œä¼˜åŒ–è§„åˆ™çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeCustom</span><span class="p">(</span><span class="k">const</span> <span class="n">AbstractPlanNodeRef</span> <span class="o">&amp;</span><span class="n">plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractPlanNodeRef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeMergeProjection</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeMergeFilterNLJ</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeNLJAsIndexJoin</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeNLJAsHashJoin</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>  <span class="c1">// Enable this rule after you have implemented hash join.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeOrderByAsIndexScan</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">p</span> <span class="o">=</span> <span class="n">OptimizeSortLimitAsTopN</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>  <span class="c1">// what we should add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè®©æœªç»ä¼˜åŒ–çš„åŸå§‹ plan æ ‘ä¾æ¬¡ç»å†å¤šæ¡è§„åˆ™ï¼Œæ¥ç”Ÿæˆä¼˜åŒ–è¿‡çš„ planã€‚æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯æ–°å¢ä¸€æ¡è§„åˆ™ã€‚çœ‹çœ‹å…¶ä»–è§„åˆ™æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œä¾‹å¦‚ <code>NLJAsIndexJoin</code>ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeNLJAsIndexJoin</span><span class="p">(</span><span class="k">const</span> <span class="n">AbstractPlanNodeRef</span> <span class="o">&amp;</span><span class="n">plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractPlanNodeRef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractPlanNodeRef</span><span class="o">&gt;</span> <span class="n">children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">child</span> <span class="p">:</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetChildren</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">children</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">OptimizeNLJAsIndexJoin</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">optimized_plan</span> <span class="o">=</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">CloneWithChildren</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">children</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">GetType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PlanType</span><span class="o">::</span><span class="n">NestedLoopJoin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// apply the rule and return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">optimized_plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ plan tree è¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°é€‚ç”¨è§„åˆ™ï¼Œæ”¹å†™èŠ‚ç‚¹ã€‚éå†åˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ if è¯­å¥æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„ç±»å‹æ˜¯å¦ç¬¦åˆæˆ‘ä»¬è¦ä¼˜åŒ–çš„ç±»å‹ï¼Œè‹¥ç¬¦åˆåˆ™è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>å¤§è‡´äº†è§£å¦‚ä½•å¯¹ plan è¿›è¡Œä¼˜åŒ–åï¼Œå°±å¯ä»¥å¼€å§‹å†™æˆ‘ä»¬çš„ä¼˜åŒ–è§„åˆ™äº†ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œèƒ½ä¼˜åŒ–ä¸ºä¸€ä¸ª TopN ç®—å­çš„å½¢å¼æ˜¯ï¼Œä¸Šå±‚èŠ‚ç‚¹ä¸º Limitï¼Œä¸‹å±‚èŠ‚ç‚¹ä¸º Sortï¼Œä¸èƒ½åè¿‡æ¥ã€‚åŒæ ·ï¼Œæˆ‘ä»¬å¯¹ plan tree è¿›è¡Œåç»­éå†ï¼Œåœ¨é‡åˆ° Limit æ—¶ï¼Œåˆ¤æ–­å…¶ä¸‹å±‚èŠ‚ç‚¹æ˜¯å¦ä¸º Sortï¼Œè‹¥ä¸º Sortï¼Œåˆ™å°†è¿™ä¸¤ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºä¸€ä¸ª TopNã€‚è¿˜æ˜¯æ¯”è¾ƒå¥½å®ç°çš„ï¼Œåªæ˜¯ä»£ç çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¤æ‚ã€‚</p>
<p>åˆ°è¿™é‡Œï¼ŒProject 3 ä¸­å¿…åšçš„éƒ¨åˆ†å°±ç»“æŸäº†ã€‚è¿˜å‰©ä¸‹é€‰åšçš„ Leaderboard Taskã€‚æœ¬æ¥ä¹Ÿä¸æ˜¯ CMU çš„å­¦ç”Ÿï¼Œå°±ä¸åˆ†ä»€ä¹ˆå¿…åšé€‰åšäº†ï¼Œæ„Ÿå…´è¶£çš„è¯éƒ½æ¨èè¯•ä¸€è¯•ã€‚æˆ‘ä¸ªäººæ„Ÿè§‰ Leaderboard Task è¿˜æ˜¯å¾ˆå¥½ç©çš„ï¼Œå°±æ˜¯ä»£ç å†™èµ·æ¥æœ‰ç‚¹éš¾å—ï¼Œcorner case æ¯”è¾ƒå¤šã€‚</p>
<h2 id="leaderboard-task">Leaderboard Task<a hidden class="anchor" aria-hidden="true" href="#leaderboard-task">#</a></h2>
<p>Leaderboard Task åŒ…å«ä¸‰æ¡æå…¶è¯¡å¼‚çš„ sqlï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å¢åŠ æ–°çš„ä¼˜åŒ–è§„åˆ™ï¼Œè®©è¿™ä¸‰æ¡ sql æ‰§è¡Œåœ°è¶Šå¿«è¶Šå¥½ã€‚åˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>Query 1: Where&rsquo;s the Index?</li>
<li>Query 2: Too Many Joins!</li>
<li>Query 3: The Mad Data Scientist</li>
</ul>
<h3 id="query-1-wheres-the-index">Query 1: Where&rsquo;s the Index?<a hidden class="anchor" aria-hidden="true" href="#query-1-wheres-the-index">#</a></h3>
<p>é¦–å…ˆæ¥çœ‹ä¸€çœ‹éœ€è¦æˆ‘ä»¬ä¼˜åŒ–çš„ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">t1x</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t1_50k</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t1_50k</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t1_50k</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t2_100k</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t2_100k</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t3_1k</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t3_1k</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">t1_50k</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">__mock_t2_100k</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t1_50k</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mock_t2_100k</span><span class="p">.</span><span class="n">x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">__mock_t3_1k</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">__mock_t2_100k</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mock_t3_1k</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>ç¨å¾®æŠŠè¡¨åæ›¿æ¢ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">t1x</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t1</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t1</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t3</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t3</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">t1</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">x</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">t3</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t3</span><span class="p">.</span><span class="n">y</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>çœ‹çš„æˆ‘æœ‰ç‚¹ç²¾ç¥ææƒšï¼Œå®é™…ä¸Šå°±æ˜¯ä¸‰å¼ è¡¨ Join å† Aggregate ä¸€ä¸‹ã€‚ä¸»è¦ä¼˜åŒ–æ–¹å‘æ˜¯æŠŠ NestedLoopJoin æ›¿æ¢ä¸º HashJoinã€Join Reorder è®©å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œä»¥åŠæ­£ç¡®è¯†åˆ« t1.x ä¸Šçš„ç´¢å¼•ã€‚</p>
<p>å…ˆè¯´ HashJoinã€‚å®é™…ä¸Šä»…éœ€è€ƒè™‘ in-memory æƒ…å†µæ—¶ï¼ŒHashJoin å¹¶ä¸éš¾å®ç°ã€‚ä¸»è¦åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼ŒBuild å’Œ Probeã€‚Build é˜¶æ®µåœ¨ <code>Init()</code> è¿›è¡Œï¼Œéå†å·¦è¡¨å»ºç«‹ hashmapã€‚Probe é˜¶æ®µåœ¨ <code>Next()</code> è¿›è¡Œï¼Œéå†å³è¡¨æ¢æµ‹æ˜¯å¦æœ‰ match çš„ tupleã€‚éœ€è¦æ³¨æ„ HashJoin åªèƒ½ç”¨äºä¼˜åŒ– equi-joinã€‚</p>
<p>å…·ä½“å®ç°èµ·æ¥ï¼Œå¯¹äºæˆ‘è¿™ç§å¯¹ modern c++ æä¸ç†Ÿæ‚‰çš„äººæ¥è¯´ï¼Œéš¾ç‚¹åè€Œåœ¨æ€ä¹ˆæ­£ç¡®æ„é€ å‡ºè¿™ä¸ª hashmap è®©ç¼–è¯‘é€šè¿‡ã€‚hashmap çš„é”®åº”è¯¥ä¸º valueï¼Œä½† value æ²¡æœ‰é‡è½½ <code>operator==</code>ï¼Œä¹Ÿæ²¡æœ‰å®ç°è‡ªå®šä¹‰ hash å‡½æ•°ï¼Œä¸èƒ½ç›´æ¥ä½œä¸ºé”®ã€‚</p>
<p>ä¸€å¼€å§‹ï¼Œæˆ‘æƒ³ç”¨ <code>src/include/common/util/hash_util.h</code> é‡Œçš„ <code>HashValue</code> å‡½æ•°å°† value hash ä¸º <code>hash_t</code> ç±»å‹ï¼Œç„¶åæŠŠ <code>hash_t</code> ä½œä¸ºé”®ã€‚hashmap ç›´æ¥ç”¨ <code>std::unordered_map</code>ã€‚ä½†é‡åˆ°äº†å“ˆå¸Œå†²çªçš„é—®é¢˜ï¼Œè¿˜æ˜¯ç»•ä¸è¿‡è¦é‡è½½ <code>operator==</code>ã€‚ç›´æ¥é‡è½½ value çš„ <code>operator==</code> æ˜¯è¡Œä¸é€šçš„ï¼Œautograder æ— æ³•è¯†åˆ«ã€‚å› æ­¤æˆ‘å®šä¹‰äº† <code>ValueKey</code> ç±»å‹æŠŠ value åŒ…è£¹èµ·æ¥ï¼Œä¸º <code>ValueKey</code> é‡è½½ == å¹¶å®ç° hash å‡½æ•°ã€‚è¿™æ ·å°±å¯ä»¥ç›´æ¥ç”¨ ValueKey ä½œä¸º hashmap çš„é”®äº†ã€‚è‡³äº <code>operator==</code> çš„å…·ä½“å®ç°ï¼Œéœ€è¦å…³æ³¨ä¸€ä¸‹ <code>Value</code> ç±»çš„ç»“æ„ï¼Œå–å‡º value çš„ raw data å¹¶ cast ä¸ºæ­£ç¡®ç±»å‹è¿›è¡Œæ¯”è¾ƒã€‚åŒæ ·ï¼Œhash å‡½æ•°ä¹Ÿæ˜¯å¯¹ raw data è¿›è¡Œ hashã€‚</p>
<p>hashmap çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿæ³¨æ„ä¸æ˜¯ tupleï¼Œè€Œæ˜¯ tuple æ•°ç»„ã€‚åŒæ ·ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨ duplicateã€‚</p>
<p>HashJoin çš„å®ç°å¤§è‡´å¦‚æ­¤ï¼Œæ¥ä¸‹æ¥æ˜¯ Join Reorderã€‚</p>
<p>Join Reorder å…¶å®æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è°ƒç”¨ <code>EstimatedCardinality()</code> æ¥ä¼°è®¡ table çš„å¤§å°ï¼Œç„¶åæ ¹æ®å¤§å°æ¥è°ƒæ•´ plan tree é‡Œè¿ç»­ join çš„é¡ºåºå³å¯ã€‚</p>
<p>æœ€åæ˜¯ Correctly Pick up Indexã€‚åœ¨åŸå§‹ NLJAsIndexJoin é‡Œï¼Œå§‹ç»ˆåªä¼šå°è¯•ä¸ºå³è¡¨åŒ¹é… indexï¼Œå·¦è¡¨åˆ™è¢«å¿½ç•¥ã€‚å› æ­¤ï¼Œå¯ä»¥æ–°å»ºä¸€æ¡è§„åˆ™ï¼Œå¦‚æœå·¦è¡¨æœ‰ indexï¼Œå³è¡¨æ²¡æœ‰ï¼Œä¸”ä¸º equi-joinï¼Œåˆ™æŠŠå·¦å³é¡ºåºæ›¿æ¢ä¸€ä¸‹ï¼Œå³æœ‰ç´¢å¼•çš„å·¦è¡¨æ¢åˆ°å³è¾¹ï¼Œä¾¿äºä¹‹åæ­£ç¡®è¯†åˆ«ç´¢å¼•ã€‚ç„¶è€Œæˆ‘åœ¨å®ç°åå‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿä¼˜åŒ–ï¼ˆï¼Œå¯èƒ½å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿˜æ˜¯ HashJoin æ¯”è¾ƒé è°±ã€‚</p>
<h3 id="query-2-too-many-joins">Query 2: Too Many Joins!<a hidden class="anchor" aria-hidden="true" href="#query-2-too-many-joins">#</a></h3>
<p>å…ˆçœ‹çœ‹ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t4_1m</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t4_1m</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t5_1m</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t5_1m</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t6_1m</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">__mock_t6_1m</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">__mock_t4_1m</span><span class="p">,</span><span class="w"> </span><span class="n">__mock_t5_1m</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">__mock_t4_1m</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mock_t5_1m</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">__mock_t6_1m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">__mock_t6_1m</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__mock_t5_1m</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">__mock_t4_1m</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">__mock_t4_1m</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1500000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">__mock_t6_1m</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">150000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">__mock_t6_1m</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100000</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>æ›´ç²¾ç¥ææƒšäº†ï¼Œç®€åŒ–ä¸€ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t4</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t4</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t5</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t5</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t6</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">t6</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t4</span><span class="p">,</span><span class="w"> </span><span class="n">t5</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">t4</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t5</span><span class="p">.</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">t6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">t6</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t5</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">t4</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">t4</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1500000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">t6</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">150000</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">t6</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100000</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>è¿™å¤§æ¦‚æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Œå¤§æ¦‚æ˜¯æ‰€æœ‰çš„ JOIN å…¨éƒ¨å†™æˆäº† FULL JOINï¼Œç„¶åæŠŠæ‰€æœ‰ Filter æ”¾åœ¨äº† plan tree çš„é¡¶ç«¯ã€‚åŸå§‹æ‰§è¡Œè®¡åˆ’æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img loading="lazy" src="../../imgs/15-445-3-6.png" alt=""  />
</p>
<p>éœ€è¦ä¼˜åŒ–çš„å†…å®¹è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼ŒFilter Push-downï¼Œå°† Filter å°½å¯èƒ½åœ°ä¸‹æ¨è‡³æ•°æ®æºå¤„ã€‚éœ€è¦æ³¨æ„ä¸æ˜¯æ‰€æœ‰çš„ Filter éƒ½å¯ä»¥ä¸‹æ¨ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠ Filter æ­£ç¡®ä¸‹æ¨è‡³ Join ç®—å­ä¸‹å°±å¯ä»¥äº†ã€‚æœ€ç»ˆäº§ç”Ÿçš„ä¼˜åŒ–æ–¹æ¡ˆå¤§è‡´æ˜¯è¿™æ ·ï¼š</p>
<p><img loading="lazy" src="../../imgs/15-445-3-7.png" alt=""  />
</p>
<p>æ³¨æ„è¦å°† Filter çš„ predicate è¯­å¥æ­£ç¡®åˆ†ç±»ï¼Œä¸‹æ¨è‡³æ­£ç¡®çš„åˆ†æ”¯ã€‚</p>
<p>åœ¨å®ç° Filter Push-down æ—¶ï¼Œä¸€å¼€å§‹æˆ‘å’Œä¹‹å‰ä¸€æ ·ï¼Œè¿›è¡Œååºéå†ï¼Œè‡ªåº•å‘ä¸Šåœ°æ”¹å†™ï¼Œä½†æ˜¯å‘ç°è¿™æ ·ä¼¼ä¹ä¸èƒ½å°† Filter å®Œå…¨åœ°ä¸‹æ¨ï¼Œå› ä¸ºä¸€ä¸ª Filter è¢«ä¸‹æ¨ä¸€æ¬¡åï¼Œå°±æ— æ³•è¢«å†æ¬¡è®¿é—®åˆ°äº†ï¼Œåªèƒ½è¢«ä¸‹æ¨ä¸€æ¬¡ã€‚å› æ­¤è¿™æ¬¡æˆ‘æ”¹ç”¨äº†å…ˆåºéå†ï¼Œè‡ªé¡¶å‘ä¸‹åœ°æ”¹å†™ã€‚å½“ä¸‹æ¨ä¸€ä¸ª Filter åï¼Œç”±äºæ˜¯å‘ä¸‹éå†ï¼ŒFilter è¿˜èƒ½è¢«å†æ¬¡è®¿é—®åˆ°ï¼Œå¯ä»¥è¢«ç»§ç»­ä¸‹æ¨ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ—¶ï¼Œæˆ‘ä»¬ä¸‹æ¨çš„ä¸æ˜¯æ•´ä¸ª Filter èŠ‚ç‚¹ï¼Œå®é™…ä¸Šæ˜¯èŠ‚ç‚¹ä¸­çš„ predicateã€‚æˆ‘çš„åšæ³•æ˜¯éå†è¡¨è¾¾å¼æ ‘ï¼Œæå– predicate ä¸­çš„æ‰€æœ‰ comparisonï¼Œåˆ¤æ–­è¡¨è¾¾å¼çš„ä¸¤è¾¹æ˜¯å¦ä¸€ä¸ªæ˜¯ column valueï¼Œä¸€ä¸ªæ˜¯ const valueï¼Œåªæœ‰è¿™æ ·çš„ predicate å¯ä»¥è¢«ä¸‹æ¨ï¼ˆä¹Ÿå­˜åœ¨å…¶ä»–å½¢å¼çš„å¯ä»¥ä¸‹æ¨çš„ predicateï¼Œç”±äºåœ¨è¿™é‡Œåªæ˜¯å¯¹ optimizer çš„ä½“éªŒï¼Œä¹Ÿåªç”¨ä¼˜åŒ–é¢„å…ˆç»™å‡ºçš„ sqlï¼Œå¯ä»¥ç¨å¾®ç®€åŒ–ä¸€ä¸‹ç®—æ³•ï¼Œä¸ç”¨è€ƒè™‘å¤ªå¤šçš„ corner caseï¼‰ï¼Œå†å°†æ‰€æœ‰çš„ predicate é‡æ–°ç»„åˆä¸º logic expressionï¼Œç”Ÿæˆæ–°çš„ Filterï¼Œæ ¹æ® column value çš„ idx æ¥é€‰æ‹©ä¸‹æ¨çš„åˆ†æ”¯ã€‚</p>
<p>ä¸¤è¾¹éƒ½ä¸º column value ä¸”åˆ†åˆ«ä»£è¡¨å·¦å³ä¸¤ä¸ªä¸‹å±‚ç®—å­çš„æŸä¸€åˆ—çš„ Filter å¯ä»¥è¢«ç»“åˆåˆ° Join èŠ‚ç‚¹ä¸­ä½œä¸º Join æ¡ä»¶ã€‚è¿™ä¸€æ­¥çš„è§„åˆ™å·²ç»è¢«å®ç°å¥½äº†ï¼Œå› æ­¤è¿™ç§ Filter æˆ‘ä»¬è®©å…¶åœç•™åœ¨åŸåœ°å³å¯ã€‚</p>
<h3 id="query-3-the-mad-data-scientist">Query 3: The Mad Data Scientist<a hidden class="anchor" aria-hidden="true" href="#query-3-the-mad-data-scientist">#</a></h3>
<p>çœ‹çœ‹ sqlï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="n">d2</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">d1</span><span class="p">,</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">d2</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v1</span><span class="p">),</span><span class="w"> </span><span class="k">max</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">min</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">from</span><span class="w"> </span><span class="n">__mock_t7</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">__mock_t8</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v4</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">v</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>å¾ˆæ€€ç–‘è¿Ÿå…ˆç”Ÿåœ¨å†™è¿™æ¡ sql æ—¶çš„ç²¾ç¥çŠ¶æ€ã€‚</p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬åªç”¨ <code>SELECT v, d1, d2</code>ï¼Œå…¶ä½™çš„æ•°æ®éƒ½æ˜¯å¤šä½™çš„ï¼Œæ— éœ€è®¡ç®—ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å®ç° Column Pruning ä¼˜åŒ–ã€‚</p>
<p>æˆ‘å®ç°çš„ Column Pruning åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>é‡åˆ°è¿ç»­çš„ä¸¤ä¸ª Projectionï¼Œåˆå¹¶ä¸º 1 ä¸ªï¼Œåªå–ä¸Šå±‚ Projection æ‰€éœ€åˆ—ã€‚</li>
<li>é‡åˆ° Projection + Aggregationï¼Œæ”¹å†™ aggregatesï¼Œæˆªå– Projection ä¸­éœ€è¦çš„é¡¹ç›®ï¼Œå…¶ä½™ç›´æ¥æŠ›å¼ƒã€‚</li>
</ol>
<p>åŒæ ·åœ°ï¼Œæˆ‘ä¸ªäººè®¤ä¸º Column Pruning ä¹Ÿæ˜¯è‡ªé¡¶å‘ä¸‹åœ°æ”¹å†™æ¯”è¾ƒæ–¹ä¾¿ã€‚å…·ä½“å®ç°æ˜¯æ”¶é›† Projection é‡Œçš„æ‰€æœ‰ columnï¼Œç„¶åæ”¹å†™ä¸‹å±‚èŠ‚ç‚¹ï¼Œä»…ä¿ç•™ä¸Šå±‚éœ€è¦ project çš„ columnã€‚è¿™é‡Œçš„ column ä¸ä¸€å®šæ˜¯è¡¨ä¸­çš„ columnï¼Œè€Œæ˜¯ä¸€ç§å¹¿ä¹‰çš„ columnï¼Œä¾‹å¦‚ <code>SELECT t1.x + t1.y FROM t1</code> ä¸­çš„ <code>t1.x + t1.y</code>ã€‚</p>
<p>å¦å¤–ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°è¿™æ¡ sql é‡Œæœ‰ä¸€ä¸ªæ°¸ä¸ºå‡çš„ predicate <code>where 1 == 2</code>ã€‚å¯¹äºè¿™ç§ Filterï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¼˜åŒ–ä¸º DummyScanï¼Œå³ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>Next()</code> å°±è¿”å› falseã€‚å¯ä»¥ç”¨ä¸€ä¸ªç©ºçš„ Value ç®—å­å®ç°ã€‚</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>è‡³æ­¤ï¼ŒProject 3 å°±å…¨éƒ¨å®Œæˆäº†ã€‚æ€»çš„æ¥è¯´ä½“éªŒè¿˜æ˜¯å¾ˆå¥½çš„ï¼Œå®ç°äº†ä¸€ç³»åˆ—ç®—å­ï¼Œä¹Ÿå®ç°äº†ä¸€ç³»åˆ—çš„ä¼˜åŒ–è§„åˆ™ï¼Œå¯¹æŸ¥è¯¢å¼•æ“æœ‰äº†æ›´æ¸…æ™°çš„è®¤è¯†ã€‚</p>
<p>åŒæ ·åœ°ï¼Œæœ‰å¾ˆå¤šå®ç°ä¸Šå…·ä½“çš„ç»†èŠ‚ä¹Ÿå¿½ç•¥æ‰äº†ï¼Œæ¯”å¦‚å¦‚ä½•è£…é…ä¸€ä¸ªä¸­é—´ tupleï¼Œç±»å‹ç³»ç»Ÿçš„è®¾è®¡ï¼Œtable page çš„è®¾è®¡ç­‰ç­‰ã€‚è¿™äº›éƒ½ä¸ä¸»çº¿å…³ç³»ä¸å¤§ï¼Œä¹Ÿå°±ä¸å†å” å¨äº†ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œæ„å¤–å‘ç° Bustub çš„ OR è¯­å¥æ— æ³•æ­£ç¡®æ‰§è¡Œï¼Œä¸€è·¯æ‰¾ bug æ‰¾ä¸Šå»å‘ç°æ˜¯ Binder ä¸­çš„ä¸€ä¸ªå° typoï¼Œå‘ Bustub æäº† PRï¼Œä¹Ÿè¢« merge äº†ã€‚ç®—æ˜¯ä¸ºå¼€æºè¯¾ç¨‹åšäº†ä¸€ç‚¹å¾®å¾®å¾®å°çš„è´¡çŒ®å§ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/database/">Database</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/cmu15-445-project4-concurrency-control/">
    <span class="title">Â« Prev</span>
    <br>
    <span>CMU15-445 Project4 Concurrency Control</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/cmu15-445-project2-b&#43;tree-index/">
    <span class="title">Next Â»</span>
    <br>
    <span>CMU15-445 Project2 B&#43;Tree Index</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Cookie&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
