<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>bustub project2 | Cookie's Blog</title>
<meta name=keywords content="bustub"><meta name=description content="Desc Text."><meta name=author content="Me"><link rel=canonical href=https://canonical.url/to/page><link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2eadbb982468c11a433a3e291f01326f2ba43f065e256bf792dbd79640a92316.js integrity="sha256-Lq27mCRowRpDOj4pHwEybyukPwZeJWv3ktvXlkCpIxY=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://dueplay.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://dueplay.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://dueplay.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://dueplay.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://dueplay.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://dueplay.github.io/posts/bustub-project2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-4XHWHM02GB"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4XHWHM02GB")}</script><meta property="og:title" content="bustub project2"><meta property="og:description" content="Desc Text."><meta property="og:type" content="article"><meta property="og:url" content="https://dueplay.github.io/posts/bustub-project2/"><meta property="og:image" content="https://dueplay.github.io/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-12-10T18:12:01+08:00"><meta property="article:modified_time" content="2023-12-10T18:12:01+08:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dueplay.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="bustub project2"><meta name=twitter:description content="Desc Text."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://dueplay.github.io/posts/"},{"@type":"ListItem","position":2,"name":"bustub project2","item":"https://dueplay.github.io/posts/bustub-project2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"bustub project2","name":"bustub project2","description":"Desc Text.","keywords":["bustub"],"articleBody":"å®éªŒä¸­ç»™å‡ºçš„ B+ æ ‘æ¥å£éå¸¸ç®€å•ï¼ŒåŸºæœ¬åªæœ‰æŸ¥è¯¢ã€æ’å…¥å’Œåˆ é™¤ä¸‰ä¸ªæ¥å£ï¼Œå†…éƒ¨åŸºæœ¬æ²¡æœ‰ç»™å‡ºåˆ«çš„è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥è®©æˆ‘ä»¬è‡ªç”±å‘æŒ¥ï¼ˆæ— ä»ä¸‹æ‰‹ï¼‰ã€‚å› æ­¤ï¼Œä»»ä½•åˆæ³•çš„ B+ æ ‘å®ç°éƒ½æ˜¯å…è®¸çš„ã€‚\nB+ æ ‘ç´¢å¼•åœ¨ Bustub ä¸­çš„ä½ç½®å¦‚å›¾æ‰€ç¤º:\nB+æ ‘ç§éœ€è¦çš„pageéƒ½éœ€è¦ä½¿ç”¨åœ¨ Project 1 ä¸­å®ç°çš„ buffer pool manager æ¥è·å–ã€‚\nCheckpoint1 Single Thread B+Tree Checkpoint1 åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š\nTask1: B+Tree pagesï¼ŒB+æ ‘ä¸­çš„å„ç§ pageã€‚åœ¨ Bustub ç´¢å¼• B+ æ ‘ä¸­ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª pageã€‚åŒ…å« leaf pageï¼Œinternal page ï¼Œå’Œå®ƒä»¬çš„çˆ¶ç±» tree pageã€‚ Task2ï¼šB+Tree Data Structure (Insertion, Deletion, Point Search)ã€‚Checkpoint1 çš„é‡ç‚¹ï¼Œå³ B+æ ‘çš„æ’å…¥ã€åˆ é™¤å’Œå•ç‚¹æŸ¥è¯¢ã€‚ Task1 B+Tree Pages task1 ä¸»è¦å®ç°leaf pageå’Œinternal pageè¿™ä¸¤ä¸ªç±»ï¼Œéƒ½ç»§æ‰¿è‡ªBPlusTreePageè¿™ä¸ªçˆ¶ç±»ï¼Œå®ç°ä¸€äº›Getterå’ŒSetteræ–¹æ³•ã€‚\né¦–å…ˆä»‹ç»ä¸€ä¸‹pageçš„å†…å­˜å¸ƒå±€\nå…¶ä¸­ï¼Œdata_ æ˜¯å®é™…å­˜æ”¾ page æ•°æ®çš„åœ°æ–¹ï¼Œå¤§å°ä¸º BUSTUB_PAGE_SIZEï¼Œä¸º 4KBã€‚å…¶ä»–çš„æˆå‘˜æ˜¯ page çš„ metadataã€‚\nB+æ ‘ä¸­çš„ tree page æ•°æ®å‡å­˜æ”¾åœ¨ page çš„ data æˆå‘˜ä¸­ï¼Œä¹Ÿå°±æ˜¯B+æ ‘ä¸­çš„èŠ‚ç‚¹æ˜¯Pageçš„dataæ•°æ®æˆå‘˜ã€‚\nB_PLUS_TREE_PAGE\nheaderåŒ…æ‹¬ä»¥ä¸‹æ•°æ®\nIndexPageType page_type_; // leaf or internal. 4 Byte lsn_t lsn_ // temporarily unused. 4 Byte int size_; // tree page data size(not in byte, in count). 4 Byte int max_size_; // tree page data max size(not in byte, in count). 4 Byte page_id_t parent_page_id_; // 4 Byte page_id_t page_id_; // 4 Byte // 24 Byte in total page data çš„ 4KB ä¸­ï¼Œ24Byte ç”¨äºå­˜æ”¾ headerï¼Œå‰©ä¸‹çš„åˆ™ç”¨äºå­˜æ”¾ tree page çš„æ•°æ®ï¼Œå³ KV å¯¹ã€‚\nB_PLUS_TREE_INTERNAL_PAGE\nå¯¹åº” B+ æ ‘ä¸­çš„å†…éƒ¨èŠ‚ç‚¹ã€‚\nMappingType array_[1]; internal page ä¸­æ²¡æœ‰æ–°çš„ metadataï¼Œheader å¤§å°ä»ä¸º 24Bã€‚å®ƒå”¯ä¸€çš„æˆå‘˜æ˜¯ä¸€ä¸ªå¤§å°ä¸º 1 çš„æ•°ç»„ã€‚å¤§å°ä¸º 1 æ˜¾ç„¶ä¸åˆç†ï¼Œä»£è¡¨åªèƒ½å­˜æ”¾ä¸€ä¸ª KV å¯¹ã€‚ä½†åˆæ²¡æ³•æ”¹å˜å®ƒçš„å¤§å°ï¼Œéš¾é“è¦ç”¨ undefined behavior æ¥è¶Šç•Œè®¿é—®å…¶åçš„åœ°å€ï¼Ÿå®é™…ä¸Šå·®ä¸å¤šå°±æ˜¯è¿™ä¸ªæ„æ€ã€‚ä½†è¿™ä¸æ˜¯ undefined behaviorï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å†™æ³•ï¼Œå«åš flexible arrayã€‚\nç®€å•æ¥è¯´å°±æ˜¯ï¼Œå½“ä½ æœ‰ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªæˆå‘˜ä¸ºæ•°ç»„ã€‚åœ¨ç”¨è¿™ä¸ªç±»åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä½ ä¸èƒ½ç¡®å®šè¯¥å°†è¿™ä¸ªæ•°ç»„çš„å¤§å°è®¾ç½®ä¸ºå¤šå°‘ï¼Œä½†çŸ¥é“è¿™æ•´ä¸ªå¯¹è±¡çš„å¤§å°æ˜¯å¤šå°‘ byteï¼Œä½ å°±å¯ä»¥ç”¨åˆ° flexible arrayã€‚flexible array å¿…é¡»æ˜¯ç±»ä¸­çš„æœ€åä¸€ä¸ªæˆå‘˜ï¼Œå¹¶ä¸”ä»…èƒ½æœ‰ä¸€ä¸ªã€‚åœ¨ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œflexible array ä¼šè‡ªåŠ¨å¡«å……ï¼Œå ç”¨æœªè¢«å…¶ä»–å˜é‡ä½¿ç”¨çš„å†…å­˜ã€‚è¿™æ ·å°±å¯ä»¥ç¡®å®šè‡ªå·±çš„é•¿åº¦äº†ã€‚\nä¾‹å¦‚æœ‰ä¸€ä¸ªç±» Cï¼š\nclass C { int a; // 4 byte int array[1]; // unknown size }; ç°åœ¨åˆå§‹åŒ–ä¸€ä¸ª C çš„å¯¹è±¡ï¼Œå¹¶ä¸ºå…¶åˆ†é…äº† 24 byte çš„å†…å­˜ã€‚a å äº† 4 byte å†…å­˜ï¼Œé‚£ä¹ˆ array ä¼šå°è¯•å¡«å……å‰©ä¸‹çš„å†…å­˜ï¼Œå¤§å°å˜ä¸º 5ã€‚\nå®é™…ä¸Šè¿™å°±æ˜¯ C++ å¯¹è±¡å†…å­˜å¸ƒå±€çš„ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å› æ­¤ flexible array ä¸ºä»€ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªä¸”å¿…é¡»æ”¾åœ¨æœ€åä¸€ä¸ªå°±å¾ˆæ˜æ˜¾äº†ï¼Œå› ä¸ºéœ€è¦å‘åå°è¯•å¡«å……ã€‚\nè¿™ä¸ªå¤§å°ä¸º 1 çš„æ•°ç»„çš„ä½œç”¨å°±æ¯”è¾ƒæ¸…æ¥šäº†ã€‚åˆ©ç”¨ flexible array çš„ç‰¹æ€§æ¥è‡ªåŠ¨å¡«å…… page data 4KB å‡æ‰ header 24byte åå‰©ä½™çš„å†…å­˜ã€‚å‰©ä¸‹çš„è¿™äº›å†…å­˜ç”¨æ¥å­˜æ”¾ KV å¯¹ã€‚\ninternal page ä¸­ï¼ŒKV å¯¹çš„ K æ˜¯èƒ½å¤Ÿæ¯”è¾ƒå¤§å°çš„ç´¢å¼•ï¼ŒV æ˜¯ page idï¼Œç”¨æ¥æŒ‡å‘ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚Project ä¸­è¦æ±‚ï¼Œç¬¬ä¸€ä¸ª Key ä¸ºç©ºã€‚ä¸»è¦æ˜¯å› ä¸ºåœ¨ internal page ä¸­ï¼Œn ä¸ª key å¯ä»¥å°†æ•°è½´åˆ’åˆ†ä¸º n+1 ä¸ªåŒºåŸŸï¼Œä¹Ÿå°±å¯¹åº”ç€ n+1 ä¸ª valueã€‚å®é™…ä¸Šä½ ä¹Ÿå¯ä»¥æŠŠæœ€åä¸€ä¸ª key å½“ä½œæ˜¯ç©ºçš„ã€‚\né€šè¿‡æ¯”è¾ƒ key çš„å¤§å°é€‰ä¸­ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚å®é™…ä¸Šç­‰å·çš„ä½ç½®ä¹Ÿå¯ä»¥æ”¹å˜ï¼Œæ€»ä¹‹ï¼Œåªè¦æ˜¯åˆæ³•çš„ B+ æ ‘ï¼Œå³èŠ‚ç‚¹å¤§å°éœ€è¦æ»¡è¶³æœ€å¤§æœ€å°å€¼çš„é™åˆ¶ï¼Œå„ç§å®ç°ç»†èŠ‚éƒ½æ˜¯è‡ªç”±çš„ã€‚\nå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œinternal page ä¸­çš„ key å¹¶ä¸ä»£è¡¨å®é™…ä¸Šçš„ç´¢å¼•å€¼ï¼Œå®é™…çš„KVåœ¨B+æ ‘ä¸­éƒ½å­˜åœ¨leaf pageä¸­ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªå‘å¯¼ï¼Œå¼•å¯¼éœ€è¦æ’å…¥/åˆ é™¤/æŸ¥è¯¢çš„ key æ‰¾åˆ°è¿™ä¸ª key çœŸæ­£æ‰€åœ¨çš„ leaf pageã€‚\nB_PLUS_TREE_LEAF_PAGE\nleaf page å’Œ internal page çš„å†…å­˜å¸ƒå±€åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯ leaf page å¤šäº†ä¸€ä¸ªæˆå‘˜å˜é‡ next_page_idï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ª leaf pageï¼ˆç”¨äº range scanï¼‰ã€‚å› æ­¤ leaf page çš„ header å¤§å°ä¸º 28 Byteã€‚\nleaf page çš„ KV å¯¹ä¸­ï¼ŒK æ˜¯å®é™…çš„ç´¢å¼•ï¼ŒV æ˜¯ record idã€‚record id (table_id + slot_id)ç”¨äºæ ‡è¯†è¡¨ä¸­çš„æŸä¸€æ¡æ•°æ®ã€‚leaf page çš„ KV å¯¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸åƒ internal page çš„ä¸€ä¸ªkeyå¯ä»¥æœ‰å¤šä¸ª value ã€‚è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ Bustub æ‰€æœ‰çš„ B+ æ ‘ç´¢å¼•ï¼Œæ— è®ºæ˜¯ä¸»é”®ç´¢å¼•è¿˜æ˜¯äºŒçº§ç´¢å¼•éƒ½æ˜¯éèšç°‡ç´¢å¼•ã€‚\nè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹èšç°‡ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼Œä¸»é”®ç´¢å¼•ã€äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„åŒºåˆ«ã€‚ åœ¨èšç°‡ç´¢å¼•é‡Œï¼Œleaf page çš„ value ä¸ºè¡¨ä¸­ä¸€æ¡æ•°æ®çš„æŸå‡ ä¸ªå­—æ®µæˆ–æ‰€æœ‰å­—æ®µï¼Œä¸€å®šåŒ…å«ä¸»é”®å­—æ®µã€‚è€Œéèšç°‡ç´¢å¼• leaf page çš„ value æ˜¯ record idï¼Œå³æŒ‡å‘ä¸€æ¡æ•°æ®çš„æŒ‡é’ˆã€‚ åœ¨ä½¿ç”¨èšç°‡ç´¢å¼•æ—¶ï¼Œä¸»é”®ç´¢å¼•çš„ leaf page åŒ…å«æ‰€æœ‰å­—æ®µï¼ŒäºŒçº§ç´¢å¼•çš„ leaf page åŒ…å«ä¸»é”®å’Œç´¢å¼•å­—æ®µã€‚å½“ä½¿ç”¨ä¸»é”®æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢åˆ° leaf page å³å¯è·å¾—æ•´æ¡æ•°æ®ã€‚å½“ä½¿ç”¨äºŒçº§ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œè‹¥æŸ¥è¯¢å­—æ®µåŒ…å«åœ¨ç´¢å¼•å†…ï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ç»“æœï¼Œä½†å¦‚æœæŸ¥è¯¢å­—æ®µä¸åŒ…å«åœ¨ç´¢å¼•å†…ï¼Œåˆ™éœ€ä½¿ç”¨å¾—åˆ°çš„ä¸»é”®å­—æ®µåœ¨ä¸»é”®ç´¢å¼•ä¸­å†æ¬¡æŸ¥è¯¢ï¼Œä»¥å¾—åˆ°æ‰€æœ‰çš„å­—æ®µï¼Œè¿›è€Œå¾—åˆ°éœ€è¦æŸ¥è¯¢çš„å­—æ®µï¼Œè¿™å°±æ˜¯å›è¡¨çš„è¿‡ç¨‹ã€‚ åœ¨ä½¿ç”¨éèšç°‡ç´¢å¼•æ—¶ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ä¸»é”®æŸ¥è¯¢è¿˜æ˜¯äºŒçº§ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœéƒ½æ˜¯ record idï¼Œéœ€è¦ä½¿ç”¨ record id å»æŸ¥è¯¢çœŸæ­£å¯¹åº”çš„æ•´æ¡è®°å½•ã€‚ èšç°‡ç´¢å¼•çš„ä¼˜ç‚¹æ˜¯ï¼Œæ•´æ¡è®°å½•ç›´æ¥å­˜æ”¾åœ¨ leaf pageï¼Œæ— éœ€äºŒæ¬¡æŸ¥è¯¢ï¼Œä¸”ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼Œåœ¨ä½¿ç”¨ä¸»é”®æŸ¥è¯¢æ—¶æ€§èƒ½æ¯”è¾ƒå¥½ã€‚ç¼ºç‚¹åˆ™æ˜¯äºŒçº§ç´¢å¼•å¯èƒ½éœ€è¦å›è¡¨ï¼Œä¸”ç”±äºæ•´æ¡æ•°æ®å­˜æ”¾åœ¨ leaf pageï¼Œæ›´æ–°ç´¢å¼•çš„ä»£ä»·å¾ˆé«˜ï¼Œé¡µåˆ†è£‚ã€åˆå¹¶ç­‰æƒ…å†µå¼€é”€æ¯”è¾ƒå¤§ã€‚ éèšç°‡ç´¢å¼•çš„ä¼˜ç‚¹æ˜¯ï¼Œç”±äº leaf page ä»…å­˜æ”¾ record idï¼Œæ›´æ–°çš„ä»£ä»·è¾ƒä½ï¼ŒäºŒçº§ç´¢å¼•çš„æ€§èƒ½å’Œä¸»é”®ç´¢å¼•å‡ ä¹ç›¸åŒã€‚ç¼ºç‚¹æ˜¯æŸ¥è¯¢æ—¶å‡éœ€ä½¿ç”¨ record id è¿›è¡ŒäºŒæ¬¡æŸ¥è¯¢ã€‚\nTask2 B+Tree Data Structure (Insertion, Deletion, Point Search) Search\nB+ æ ‘çš„èŠ‚ç‚¹åˆ†ä¸º internal page å’Œ leaf pageï¼Œæ¯ä¸ª page ä¸Šçš„ key æœ‰åºæ’åˆ—ã€‚å½“æ‹¿åˆ°ä¸€ä¸ª key éœ€è¦æŸ¥æ‰¾å¯¹åº”çš„ value æ—¶ï¼Œé¦–å…ˆéœ€è¦ç»ç”± internal page é€’å½’åœ°å‘ä¸‹æŸ¥æ‰¾ï¼Œæœ€ç»ˆæ‰¾åˆ° key æ‰€åœ¨çš„ leaf pageã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªå‡½æ•° FindLeafPage()ã€‚\nFindLeafPage() ä» root page å¼€å§‹ä¸€å±‚ä¸€å±‚çš„æŸ¥æ‰¾ã€‚åœ¨æŸ¥æ‰¾åˆ° leaf page æ—¶ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ ¹æ® key åœ¨å½“å‰ internal page ä¸­æ‰¾åˆ°å¯¹åº”çš„ child page idï¼Œå†åœ¨child page ä¸­æŸ¥æ‰¾ã€‚ç”±äº key æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥ç›´æ¥è¿›è¡ŒäºŒåˆ†æœç´¢ã€‚\ninternal page ä¸­å‚¨å­˜ key å’Œ child page idï¼Œé‚£ä¹ˆåœ¨æ‹¿åˆ° page id åå¦‚ä½•è·å¾—å¯¹åº”çš„ page æŒ‡é’ˆï¼Ÿç”¨ Project 1 ä¸­å®ç°çš„ buffer poolã€‚\nPage *page = buffer_pool_manager_-\u003eFetchPage(page_id); åœ¨è·å–åˆ°ä¸€ä¸ª page åï¼Œå¦‚ä½•ä½¿ç”¨è¿™ä¸ª page æ¥å­˜å‚¨æ•°æ®ï¼Ÿä¹‹å‰å·²ç»æåˆ°è¿‡ï¼Œpage çš„ data_ å­—æ®µæ˜¯å®é™…ç”¨äºå­˜å‚¨æ•°æ®çš„ 4KB å¤§å°çš„å­—èŠ‚æ•°ç»„ã€‚é€šè¿‡ reinterpret_cast å°†è¿™ä¸ªå­—èŠ‚æ•°ç»„å¼ºåˆ¶è½¬æ¢ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨çš„ç±»å‹ï¼Œä¾‹å¦‚ leaf pageï¼š\nauto leaf_page = reinterpret_cast\u003cB_PLUS_TREE_LEAF_PAGE_TYPE *\u003e(page-\u003eGetData()) reinterpret_cast ç”¨äºæ— å…³ç±»å‹çš„å¼ºåˆ¶è½¬æ¢ï¼Œè½¬æ¢æ–¹æ³•å¾ˆç®€å•ï¼ŒåŸå§‹ bits ä¸å˜ï¼Œåªæ˜¯å¯¹è¿™äº› bits ç”¨æ–°ç±»å‹è¿›è¡Œäº†é‡æ–°çš„è§£è¯»ã€‚å¯æƒ³è€ŒçŸ¥è¿™ç§è½¬æ¢éå¸¸ä¸å®‰å…¨ï¼Œéœ€è¦ç¡®ä¿è½¬æ¢åçš„å†…å­˜å¸ƒå±€ä»æ˜¯åˆæ³•çš„ã€‚åœ¨è¿™é‡ŒåŸç±»å‹æ˜¯ byte æ•°ç»„ï¼Œæ–°ç±»å‹æ˜¯æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ tree pageã€‚\næˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢ä¸¤éƒ¨å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ ¹æ®page_idè·å–BPlusTreePageåŸå§‹çš„pageå’Œpage.dataã€‚æ³¨æ„è¿™é‡Œreinterpret_castè¿”å›çš„æ˜¯BPlusTreePageï¼Œåç»­è¿˜éœ€è¦è½¬æˆå…¶å­ç±»leafå’Œinteral pageã€‚ã€‚\nINDEX_TEMPLATE_ARGUMENTS auto BPLUSTREE_TYPE::FetchBPlusTreePage(page_id_t page_id) -\u003e std::pair\u003cPage *, BPlusTreePage *\u003e { Page *page = buffer_pool_manager_-\u003eFetchPage(page_id); BUSTUB_ASSERT(page != nullptr, \"FetchBPlusTreePage(): page != nullptr\"); return {page, reinterpret_cast\u003cBPlusTreePage *\u003e(page-\u003eGetData())}; } æ‰¾åˆ° leaf page åï¼ŒåŒæ ·æ˜¯äºŒåˆ†æŸ¥æ‰¾ keyï¼Œæ‰¾åˆ°å¯¹åº”çš„ record idã€‚æ³¨æ„åœ¨leaf pageä¸­äºŒåˆ†æŸ¥æ‰¾å·¦è¾¹ç•Œæ˜¯0ï¼Œåœ¨internal pageä¸­äºŒåˆ†æŸ¥æ‰¾å·¦è¾¹ç•Œæ˜¯1ã€‚\nåœ¨æŸ¥æ‰¾çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦ä¸”å¤æ‚çš„ç»†èŠ‚ï¼Œå°±æ˜¯ page unpin çš„é—®é¢˜ã€‚\næˆ‘ä»¬åœ¨æ‹¿åˆ° page id åï¼Œè°ƒç”¨ buffer pool çš„ FetchPage() å‡½æ•°æ¥è·å–å¯¹åº”çš„ page æŒ‡é’ˆã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨å®Œ page ä¹‹åï¼Œéœ€è¦å°† page unpin æ‰ï¼Œå¦åˆ™æœ€ç»ˆä¼šå¯¼è‡´ buffer pool ä¸­çš„æ‰€æœ‰ page éƒ½è¢« pin ä½ï¼Œbuffer pool æ»¡æ— æ³•è¿›è¡Œæ¢å…¥æ¢å‡ºï¼Œæ— æ³•ä» disk è¯»å–å…¶ä»–çš„ pageã€‚\næ¯”è¾ƒåˆé€‚çš„åšæ³•æ˜¯ï¼Œåœ¨æœ¬æ¬¡æ“ä½œä¸­ï¼Œæ‰¾å‡º page æœ€åä¸€æ¬¡è¢«ä½¿ç”¨çš„åœ°æ–¹ï¼Œå¹¶åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨å unpinã€‚\nInsert\nä¸ Search ç›¸åŒï¼Œç¬¬ä¸€æ­¥æ˜¯æ ¹æ® key æ‰¾åˆ°éœ€è¦æ’å…¥çš„ leaf pageã€‚åŒæ ·æ˜¯è°ƒç”¨ FindLeafPage()ã€‚å¾—åˆ° leaf page åï¼Œå°† key æ’å…¥ leaf pageã€‚å½“B+æ ‘ä¸ºç©ºæ—¶ï¼Œæ–°å»ºä¸€ä¸ªleaf pageä½œä¸ºroot pageå°†å…¶æ’å…¥ã€‚è¦æ³¨æ„çš„æ˜¯ï¼š1.æ’å…¥æ—¶ä»éœ€ä¿è¯ key çš„æœ‰åºæ€§ï¼ŒåŒæ ·å¯ä»¥äºŒåˆ†æœç´¢æ‰¾åˆ°åˆé€‚çš„ä½ç½®æ’å…¥ã€‚2.æ˜¯ä¸å…è®¸æœ‰é‡å¤çš„keyçš„ï¼Œå½“æ’å…¥é‡å¤çš„keyè¿”å›falseã€‚\nåœ¨æ’å…¥åï¼Œéœ€è¦æ£€æŸ¥å½“å‰ leaf page size æ˜¯å¦ç­‰äº max sizeã€‚è‹¥ç›¸ç­‰ï¼Œåˆ™è¦è¿›è¡Œä¸€æ¬¡ leaf page åˆ†è£‚æ“ä½œã€‚å…·ä½“æ­¥éª¤ä¸ºï¼š\næ–°å»ºä¸€ä¸ªç©ºçš„ pageï¼Œ å°†åŸ page çš„ä¸€åŠè½¬ç§»åˆ°æ–° page ä¸­ï¼Œï¼ˆå‡å¦‚é€‰æ‹©å°†æ–° page æ”¾åœ¨åŸ page å³ä¾§ï¼Œåˆ™è½¬ç§»åŸ page çš„å³åŠéƒ¨åˆ†ï¼‰ æ›´æ–°åŸ page å’Œæ–° page çš„ next page idï¼Œ è·å– parent pageï¼Œå°†ç”¨äºåŒºåˆ†åŸ page å’Œæ–° page çš„ key æ’å…¥ parent page ä¸­ï¼Œ æ›´æ–° parent page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚ éœ€è¦ç»™ parent page æ’å…¥ä¸€ä¸ªæ–° key çš„åŸå› æ˜¯ï¼Œå¤šäº†ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè‡ªç„¶éœ€è¦å¤šä¸€ä¸ª key æ¥åŒºåˆ†ï¼Œè¿™ä¸ªkeyæ˜¯å³è¾¹èŠ‚ç‚¹çš„key0ã€‚å…¶ä¸­ç¬¬ 4 æ­¥æ˜¯é‡ç‚¹ã€‚è·å– parent page å¹¶ä¸æ˜¯ç®€å•åœ°é€šè¿‡å½“å‰ page çš„ parent id æ¥è·å–ï¼Œå› ä¸º parent page ä¹Ÿå¯èƒ½å‘ç”Ÿåˆ†è£‚ã€‚\nå‡å¦‚æˆ‘ä»¬æœ‰ä¸€æ£µ 5 é˜¶çš„ B+ æ ‘ã€‚5 é˜¶åªæ˜¯ä¸€ç§å¸¸ç”¨çš„è¯´æ³•ï¼Œä»£è¡¨ B+ æ ‘èŠ‚ç‚¹æœ€å¤šèƒ½å®¹çº³äº”ä¸ª KV å¯¹ã€‚å¯¹äº leaf page æ¥è¯´ï¼Œå½“ B+ æ ‘å¤„äºç¨³å®šçŠ¶æ€æ—¶ï¼ˆæ’å…¥ã€åˆ é™¤ç­‰æ“ä½œå·²ç»å®Œå…¨ç»“æŸï¼‰ï¼Œæœ€å¤šåªèƒ½æœ‰ 4 ä¸ª KV å¯¹ã€‚å¯¹äº internal pageï¼Œæœ€å¤šæœ‰ 4 ä¸ª keyï¼Œ5 ä¸ª valueï¼Œå¯ä»¥çœ‹æˆæ˜¯æœ‰ 5 ä¸ª KV å¯¹ã€‚\nå› æ­¤ï¼Œinstruction ä¸­æœ‰è¿™ä¹ˆä¸€å¥è¯ï¼š\nYou should correctly perform splits if insertion triggers the splitting condition (number of key/value pairs AFTER insertion equals to max_size for leaf nodes, number of children BEFORE insertion equals to max_size for internal nodes.).\nåœ¨æ’å…¥åæ£€æµ‹ leaf page æ˜¯å¦éœ€è¦åˆ†è£‚ï¼Œå› ä¸º leaf page ç¨³å®šæ—¶åªæœ‰ 4 ä¸ª KV å¯¹ï¼Œæ’å…¥åæœ‰ 5 ä¸ªï¼Œä»èƒ½å®¹çº³ã€‚åœ¨æ’å…¥å‰æ£€æµ‹ internal pageï¼Œå› ä¸º internal page ç¨³å®šæ—¶å°±æœ‰ 5 ä¸ª KV å¯¹ï¼Œè‹¥æ’å…¥åå†æ£€æµ‹ï¼Œæ’å…¥çš„ç¬¬ 6 ä¸ª KV å¯¹ä¼šé€ æˆè¶Šç•Œã€‚\nå®é™…ä¸Šè¿™ä¹Ÿåªæ˜¯ä¸€ç§çº¦å®šï¼Œå¹¶ä¸æ˜¯å¼ºåˆ¶çš„è§„åˆ™ã€‚\nç¬¬ 4 æ­¥å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š 1. æ ¹æ®leaf pageçš„ parent page id æ‹¿åˆ° parent pageï¼Œ 2. åˆ¤æ–­ parent page size æ˜¯å¦ç­‰äº max sizeï¼Œï¼ˆæ’å…¥å‰æ£€æŸ¥ï¼‰ 3. è‹¥å°äºï¼Œç›´æ¥è¿”å› parent pageï¼Œ 4. å¦åˆ™ï¼Œåˆ†è£‚å½“å‰ internal pageã€‚å¹¶æ ¹æ®æ­¤åéœ€è¦æ’å…¥çš„ key é€‰æ‹©åˆ†è£‚åçš„ä¸¤ä¸ª page ä¹‹ä¸€ä½œä¸º parent page è¿”å›ã€‚\nåˆ†è£‚ internal page çš„æ­¥éª¤ä¸ºï¼š 1. æ–°å»ºä¸€ä¸ªç©ºçš„ InternalPageï¼Œ 2. å°†åŸ page çš„ä¸€åŠè½¬ç§»åˆ°æ–° page ä¸­ï¼Œéœ€è¦æ³¨æ„åŸ page å’Œæ–° page çš„ç¬¬ä¸€ä¸ª key éƒ½æ˜¯æ— æ•ˆçš„ï¼Œ 3. æ›´æ–°æ–° page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆï¼ŒæŒ‡å‘æ–° pageï¼Œ 4. è·å– parent pageï¼Œ 5. å°†ç”¨äºåŒºåˆ†åŸ page å’Œæ–° page çš„ key æ’å…¥ parent page ä¸­ï¼Œ 6. æ›´æ–° parent page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚\nè¿™é‡Œå‘ç”Ÿäº†å‘ä¸Šçš„é€’å½’ï¼Œç›´åˆ°é‡åˆ°å®‰å…¨çš„çˆ¶èŠ‚ç‚¹æˆ–è€…é‡åˆ°æ ¹èŠ‚ç‚¹ã€‚åœ¨é‡åˆ°æ ¹èŠ‚ç‚¹æ—¶ï¼Œè‹¥æ ¹èŠ‚ç‚¹ä¹Ÿéœ€è¦åˆ†è£‚ï¼Œåˆ™é™¤äº†éœ€è¦æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥å®¹çº³åŸæ ¹èŠ‚ç‚¹ä¸€åŠçš„ KV å¯¹ï¼Œè¿˜éœ€è¦æ–°å»ºä¸€ä¸ªæ–°çš„æ ¹èŠ‚ç‚¹ã€‚\nå‡å¦‚æœ‰ä¸€æ£µ 4 é˜¶çš„ B+ æ ‘ï¼š\nDelete\nåŒæ ·åœ°ï¼Œå…ˆæ‰¾åˆ° leaf pageã€‚åˆ é™¤ leaf page ä¸­ key å¯¹åº”çš„ KV å¯¹åï¼Œæ£€æŸ¥ size æ˜¯å¦å°äº min sizeã€‚å¦‚æœå°äºçš„è¯ï¼Œé¦–å…ˆå°è¯•ä»ä¸¤ä¾§çš„å…„å¼ŸèŠ‚ç‚¹ä¸­å·ä¸€ä¸ª KV å¯¹ã€‚æ³¨æ„åªèƒ½ä»å…„å¼ŸèŠ‚ç‚¹ï¼Œå³çˆ¶èŠ‚ç‚¹ç›¸åŒçš„èŠ‚ç‚¹ä¸­é€‰å–ã€‚å‡å¦‚å­˜åœ¨ä¸€ä¾§èŠ‚ç‚¹æœ‰å¯Œä½™çš„ KV å¯¹ï¼Œåˆ™æˆåŠŸå·å–ï¼Œç»“æŸæ“ä½œã€‚è‹¥ä¸¤ä¾§éƒ½æ²¡æœ‰å¯Œä½™çš„ KV å¯¹ï¼Œåˆ™é€‰æ‹©ä¸€ä¾§èŠ‚ç‚¹ä¸å…¶åˆå¹¶ã€‚\nå·å–çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œä»å·¦ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå·¦ä¾§èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹ç¬¬ä¸€ä¸ª KV å¯¹ï¼Œä»å³ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå³ä¾§èŠ‚ç‚¹çš„ KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹ã€‚leaf page å’Œ internal page çš„å·å–è¿‡ç¨‹åŸºæœ¬ç›¸åŒï¼Œä»…éœ€æ³¨æ„ internal page å·å–åæ›´æ–°å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚\nç¨éš¾çš„æ˜¯åˆå¹¶çš„è¿‡ç¨‹ã€‚åŒæ ·ï¼Œä»»é€‰å·¦å³ä¾§ä¸€å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œåˆå¹¶ã€‚å°†ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ KV å¯¹è½¬ç§»è‡³å¦ä¸€èŠ‚ç‚¹ã€‚è‹¥åˆå¹¶çš„æ˜¯ leaf pageï¼Œè®°å¾—æ›´æ–° next page idã€‚è‹¥åˆå¹¶çš„æ˜¯ internal pageï¼Œè®°å¾—æ›´æ–°åˆå¹¶å page çš„å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚ç„¶åï¼Œåˆ é™¤ parent èŠ‚ç‚¹ä¸­å¯¹åº”çš„ keyã€‚åˆ é™¤åï¼Œå†æ¬¡æ£€æŸ¥ size æ˜¯å¦å°äº min sizeï¼Œå½¢æˆå‘ä¸Šé€’å½’ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œroot page å¹¶ä¸å— min size çš„é™åˆ¶ã€‚ä½†å¦‚æœ root page è¢«åˆ åˆ° size åªå‰© 1ï¼Œå³åªæœ‰ä¸€ä¸ª child page çš„æ—¶å€™ï¼Œåº”å°†æ­¤ child page è®¾ç½®ä¸ºæ–°çš„ root pageã€‚\nå¦å¤–ï¼Œåœ¨åˆå¹¶æ—¶ï¼Œä¸¤ä¸ª page åˆå¹¶æˆä¸€ä¸ª pageï¼Œå¦ä¸€ä¸ª page åº”è¯¥åˆ é™¤ï¼Œé‡Šæ”¾èµ„æºã€‚åˆ é™¤ page æ—¶ï¼Œä»æ˜¯è°ƒç”¨ buffer pool çš„ DeletePage() å‡½æ•°ã€‚\nå’Œ Insert ç±»ä¼¼ï¼ŒDelete è¿‡ç¨‹ä¹Ÿæ˜¯å…ˆå‘ä¸‹é€’å½’æŸ¥è¯¢ leaf pageï¼Œä¸æ»¡è¶³ min size åå…ˆå°è¯•å·å–ï¼Œæ— æ³•å·å–åˆ™åˆå¹¶ï¼Œå¹¶å‘ä¸Šé€’å½’åœ°æ£€æŸ¥æ˜¯å¦æ»¡è¶³ min sizeã€‚\n","wordCount":"913","inLanguage":"en","image":"https://dueplay.github.io/%3Cimage%20path/url%3E","datePublished":"2023-12-10T18:12:01+08:00","dateModified":"2023-12-10T18:12:01+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://dueplay.github.io/posts/bustub-project2/"},"publisher":{"@type":"Organization","name":"Cookie's Blog","logo":{"@type":"ImageObject","url":"https://dueplay.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dueplay.github.io/ accesskey=h title="Home (Alt + H)">Home</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://dueplay.github.io/archives/ title=â±archives><span>â±archives</span></a></li><li><a href=https://dueplay.github.io/search/ title=ğŸ”Search><span>ğŸ”Search</span></a></li><li><a href=https://dueplay.github.io/tags/ title=ğŸ”–Tags><span>ğŸ”–Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dueplay.github.io/>Home</a>&nbsp;Â»&nbsp;<a href=https://dueplay.github.io/posts/>Posts</a></div><h1 class=post-title>bustub project2</h1><div class=post-description>Desc Text.</div><div class=post-meta>&lt;span title='2023-12-10 18:12:01 +0800 +0800'>2023-12-10&lt;/span>&amp;nbsp;Â·&amp;nbsp;5 min&amp;nbsp;Â·&amp;nbsp;913 words&amp;nbsp;Â·&amp;nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/Dueplay/blog/content/posts/bustub%20project2.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#checkpoint1-single-thread-btree>Checkpoint1 Single Thread B+Tree</a><ul><li><a href=#task1-btree-pages>Task1 B+Tree Pages</a></li><li><a href=#task2-btree-data-structure-insertion-deletion-point-search>Task2 B+Tree Data Structure (Insertion, Deletion, Point Search)</a></li></ul></li></ul></nav></div></details></div><div class=post-content><p>å®éªŒä¸­ç»™å‡ºçš„ B+ æ ‘æ¥å£éå¸¸ç®€å•ï¼ŒåŸºæœ¬åªæœ‰æŸ¥è¯¢ã€æ’å…¥å’Œåˆ é™¤ä¸‰ä¸ªæ¥å£ï¼Œå†…éƒ¨åŸºæœ¬æ²¡æœ‰ç»™å‡ºåˆ«çš„è¾…åŠ©å‡½æ•°ï¼Œå¯ä»¥è®©æˆ‘ä»¬è‡ªç”±å‘æŒ¥ï¼ˆæ— ä»ä¸‹æ‰‹ï¼‰ã€‚å› æ­¤ï¼Œä»»ä½•åˆæ³•çš„ B+ æ ‘å®ç°éƒ½æ˜¯å…è®¸çš„ã€‚</p><p>B+ æ ‘ç´¢å¼•åœ¨ Bustub ä¸­çš„ä½ç½®å¦‚å›¾æ‰€ç¤º:</p><p><img loading=lazy src=../imgs/image-20231210192752111.png alt=image-20231210192752111></p><p>B+æ ‘ç§éœ€è¦çš„pageéƒ½éœ€è¦ä½¿ç”¨åœ¨ Project 1 ä¸­å®ç°çš„ buffer pool manager æ¥è·å–ã€‚</p><h2 id=checkpoint1-single-thread-btree>Checkpoint1 Single Thread B+Tree<a hidden class=anchor aria-hidden=true href=#checkpoint1-single-thread-btree>#</a></h2><p>Checkpoint1 åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>Task1: B+Tree pagesï¼ŒB+æ ‘ä¸­çš„å„ç§ pageã€‚åœ¨ Bustub ç´¢å¼• B+ æ ‘ä¸­ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ª pageã€‚åŒ…å« leaf pageï¼Œinternal page ï¼Œå’Œå®ƒä»¬çš„çˆ¶ç±» tree pageã€‚</li><li>Task2ï¼šB+Tree Data Structure (Insertion, Deletion, Point Search)ã€‚Checkpoint1 çš„é‡ç‚¹ï¼Œå³ B+æ ‘çš„æ’å…¥ã€åˆ é™¤å’Œå•ç‚¹æŸ¥è¯¢ã€‚</li></ul><h3 id=task1-btree-pages>Task1 B+Tree Pages<a hidden class=anchor aria-hidden=true href=#task1-btree-pages>#</a></h3><p>task1 ä¸»è¦å®ç°leaf pageå’Œinternal pageè¿™ä¸¤ä¸ªç±»ï¼Œéƒ½ç»§æ‰¿è‡ªBPlusTreePageè¿™ä¸ªçˆ¶ç±»ï¼Œå®ç°ä¸€äº›Getterå’ŒSetteræ–¹æ³•ã€‚</p><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹pageçš„å†…å­˜å¸ƒå±€</p><p><img loading=lazy src=../imgs/image-20231210193702035.png alt=image-20231210193702035></p><p>å…¶ä¸­ï¼Œ<code>data_</code> æ˜¯å®é™…å­˜æ”¾ page æ•°æ®çš„åœ°æ–¹ï¼Œå¤§å°ä¸º <code>BUSTUB_PAGE_SIZE</code>ï¼Œä¸º 4KBã€‚å…¶ä»–çš„æˆå‘˜æ˜¯ page çš„ metadataã€‚</p><p>B+æ ‘ä¸­çš„ tree page æ•°æ®å‡å­˜æ”¾åœ¨ page çš„ data æˆå‘˜ä¸­ï¼Œä¹Ÿå°±æ˜¯B+æ ‘ä¸­çš„èŠ‚ç‚¹æ˜¯Pageçš„dataæ•°æ®æˆå‘˜ã€‚</p><p><strong>B_PLUS_TREE_PAGE</strong></p><p>headeråŒ…æ‹¬ä»¥ä¸‹æ•°æ®</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>IndexPageType</span> <span class=n>page_type_</span><span class=p>;</span>   <span class=c1>// leaf or internal. 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>lsn_t</span> <span class=n>lsn_</span>  <span class=c1>// temporarily unused. 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>size_</span><span class=p>;</span>  <span class=c1>// tree page data size(not in byte, in count). 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=n>max_size_</span><span class=p>;</span>  <span class=c1>// tree page data max size(not in byte, in count). 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>page_id_t</span> <span class=n>parent_page_id_</span><span class=p>;</span> <span class=c1>// 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>page_id_t</span> <span class=n>page_id_</span><span class=p>;</span> <span class=c1>// 4 Byte
</span></span></span><span class=line><span class=cl><span class=c1>// 24 Byte in total
</span></span></span></code></pre></div><p><img loading=lazy src=../imgs/image-20231210194157821.png alt=image-20231210194157821></p><p>page data çš„ 4KB ä¸­ï¼Œ24Byte ç”¨äºå­˜æ”¾ headerï¼Œå‰©ä¸‹çš„åˆ™ç”¨äºå­˜æ”¾ tree page çš„æ•°æ®ï¼Œå³ KV å¯¹ã€‚</p><p><strong>B_PLUS_TREE_INTERNAL_PAGE</strong></p><p>å¯¹åº” B+ æ ‘ä¸­çš„å†…éƒ¨èŠ‚ç‚¹ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>MappingType</span> <span class=n>array_</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span></code></pre></div><p>internal page ä¸­æ²¡æœ‰æ–°çš„ metadataï¼Œheader å¤§å°ä»ä¸º 24Bã€‚å®ƒå”¯ä¸€çš„æˆå‘˜æ˜¯ä¸€ä¸ªå¤§å°ä¸º 1 çš„æ•°ç»„ã€‚å¤§å°ä¸º 1 æ˜¾ç„¶ä¸åˆç†ï¼Œä»£è¡¨åªèƒ½å­˜æ”¾ä¸€ä¸ª KV å¯¹ã€‚ä½†åˆæ²¡æ³•æ”¹å˜å®ƒçš„å¤§å°ï¼Œéš¾é“è¦ç”¨ undefined behavior æ¥è¶Šç•Œè®¿é—®å…¶åçš„åœ°å€ï¼Ÿå®é™…ä¸Šå·®ä¸å¤šå°±æ˜¯è¿™ä¸ªæ„æ€ã€‚ä½†è¿™ä¸æ˜¯ undefined behaviorï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„å†™æ³•ï¼Œå«åš flexible arrayã€‚</p><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼Œå½“ä½ æœ‰ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªæˆå‘˜ä¸ºæ•°ç»„ã€‚åœ¨ç”¨è¿™ä¸ªç±»åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä½ ä¸èƒ½ç¡®å®šè¯¥å°†è¿™ä¸ªæ•°ç»„çš„å¤§å°è®¾ç½®ä¸ºå¤šå°‘ï¼Œä½†çŸ¥é“è¿™æ•´ä¸ªå¯¹è±¡çš„å¤§å°æ˜¯å¤šå°‘ byteï¼Œä½ å°±å¯ä»¥ç”¨åˆ° flexible arrayã€‚flexible array å¿…é¡»æ˜¯ç±»ä¸­çš„æœ€åä¸€ä¸ªæˆå‘˜ï¼Œå¹¶ä¸”ä»…èƒ½æœ‰ä¸€ä¸ªã€‚åœ¨ä¸ºå¯¹è±¡åˆ†é…å†…å­˜æ—¶ï¼Œflexible array ä¼šè‡ªåŠ¨å¡«å……ï¼Œå ç”¨æœªè¢«å…¶ä»–å˜é‡ä½¿ç”¨çš„å†…å­˜ã€‚è¿™æ ·å°±å¯ä»¥ç¡®å®šè‡ªå·±çš„é•¿åº¦äº†ã€‚</p><p>ä¾‹å¦‚æœ‰ä¸€ä¸ªç±» Cï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>class</span> <span class=nc>C</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>a</span><span class=p>;</span> <span class=c1>// 4 byte
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>array</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span> <span class=c1>// unknown size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></div><p>ç°åœ¨åˆå§‹åŒ–ä¸€ä¸ª C çš„å¯¹è±¡ï¼Œå¹¶ä¸ºå…¶åˆ†é…äº† 24 byte çš„å†…å­˜ã€‚<code>a</code> å äº† 4 byte å†…å­˜ï¼Œé‚£ä¹ˆ <code>array</code> ä¼šå°è¯•å¡«å……å‰©ä¸‹çš„å†…å­˜ï¼Œå¤§å°å˜ä¸º 5ã€‚</p><p>å®é™…ä¸Šè¿™å°±æ˜¯ C++ å¯¹è±¡å†…å­˜å¸ƒå±€çš„ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å› æ­¤ flexible array ä¸ºä»€ä¹ˆåªèƒ½æœ‰ä¸€ä¸ªä¸”å¿…é¡»æ”¾åœ¨æœ€åä¸€ä¸ªå°±å¾ˆæ˜æ˜¾äº†ï¼Œå› ä¸ºéœ€è¦å‘åå°è¯•å¡«å……ã€‚</p><p>è¿™ä¸ªå¤§å°ä¸º 1 çš„æ•°ç»„çš„ä½œç”¨å°±æ¯”è¾ƒæ¸…æ¥šäº†ã€‚åˆ©ç”¨ flexible array çš„ç‰¹æ€§æ¥è‡ªåŠ¨å¡«å…… page data 4KB å‡æ‰ header 24byte åå‰©ä½™çš„å†…å­˜ã€‚å‰©ä¸‹çš„è¿™äº›å†…å­˜ç”¨æ¥å­˜æ”¾ KV å¯¹ã€‚</p><p><img loading=lazy src=../imgs/image-20231210195129528.png alt=image-20231210195129528></p><p>internal page ä¸­ï¼ŒKV å¯¹çš„ K æ˜¯èƒ½å¤Ÿæ¯”è¾ƒå¤§å°çš„ç´¢å¼•ï¼ŒV æ˜¯ page idï¼Œç”¨æ¥æŒ‡å‘ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚Project ä¸­è¦æ±‚ï¼Œç¬¬ä¸€ä¸ª Key ä¸ºç©ºã€‚ä¸»è¦æ˜¯å› ä¸ºåœ¨ internal page ä¸­ï¼Œn ä¸ª key å¯ä»¥å°†æ•°è½´åˆ’åˆ†ä¸º n+1 ä¸ªåŒºåŸŸï¼Œä¹Ÿå°±å¯¹åº”ç€ n+1 ä¸ª valueã€‚å®é™…ä¸Šä½ ä¹Ÿå¯ä»¥æŠŠæœ€åä¸€ä¸ª key å½“ä½œæ˜¯ç©ºçš„ã€‚</p><p><img loading=lazy src=../imgs/image-20231210200025382.png alt=image-20231210200025382></p><p>é€šè¿‡æ¯”è¾ƒ key çš„å¤§å°é€‰ä¸­ä¸‹ä¸€å±‚çš„èŠ‚ç‚¹ã€‚å®é™…ä¸Šç­‰å·çš„ä½ç½®ä¹Ÿå¯ä»¥æ”¹å˜ï¼Œæ€»ä¹‹ï¼Œåªè¦æ˜¯åˆæ³•çš„ B+ æ ‘ï¼Œå³èŠ‚ç‚¹å¤§å°éœ€è¦æ»¡è¶³æœ€å¤§æœ€å°å€¼çš„é™åˆ¶ï¼Œå„ç§å®ç°ç»†èŠ‚éƒ½æ˜¯è‡ªç”±çš„ã€‚</p><p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œinternal page ä¸­çš„ key å¹¶ä¸ä»£è¡¨å®é™…ä¸Šçš„ç´¢å¼•å€¼ï¼Œå®é™…çš„KVåœ¨B+æ ‘ä¸­éƒ½å­˜åœ¨leaf pageä¸­ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä½œä¸ºä¸€ä¸ªå‘å¯¼ï¼Œå¼•å¯¼éœ€è¦æ’å…¥/åˆ é™¤/æŸ¥è¯¢çš„ key æ‰¾åˆ°è¿™ä¸ª key çœŸæ­£æ‰€åœ¨çš„ leaf pageã€‚</p><p><strong>B_PLUS_TREE_LEAF_PAGE</strong></p><p>leaf page å’Œ internal page çš„å†…å­˜å¸ƒå±€åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯ leaf page å¤šäº†ä¸€ä¸ªæˆå‘˜å˜é‡ <code>next_page_id</code>ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ª leaf pageï¼ˆç”¨äº range scanï¼‰ã€‚å› æ­¤ leaf page çš„ header å¤§å°ä¸º 28 Byteã€‚</p><p>leaf page çš„ KV å¯¹ä¸­ï¼ŒK æ˜¯å®é™…çš„ç´¢å¼•ï¼ŒV æ˜¯ record idã€‚record id (table_id + slot_id)ç”¨äºæ ‡è¯†è¡¨ä¸­çš„æŸä¸€æ¡æ•°æ®ã€‚leaf page çš„ KV å¯¹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸åƒ internal page çš„ä¸€ä¸ªkeyå¯ä»¥æœ‰å¤šä¸ª value ã€‚è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ Bustub æ‰€æœ‰çš„ B+ æ ‘ç´¢å¼•ï¼Œæ— è®ºæ˜¯ä¸»é”®ç´¢å¼•è¿˜æ˜¯äºŒçº§ç´¢å¼•éƒ½æ˜¯éèšç°‡ç´¢å¼•ã€‚</p><p>è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹èšç°‡ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼Œä¸»é”®ç´¢å¼•ã€äºŒçº§ç´¢å¼•ï¼ˆéä¸»é”®ç´¢å¼•ï¼‰çš„åŒºåˆ«ã€‚ åœ¨èšç°‡ç´¢å¼•é‡Œï¼Œleaf page çš„ value ä¸ºè¡¨ä¸­ä¸€æ¡æ•°æ®çš„æŸå‡ ä¸ªå­—æ®µæˆ–æ‰€æœ‰å­—æ®µï¼Œä¸€å®šåŒ…å«ä¸»é”®å­—æ®µã€‚è€Œéèšç°‡ç´¢å¼• leaf page çš„ value æ˜¯ record idï¼Œå³æŒ‡å‘ä¸€æ¡æ•°æ®çš„æŒ‡é’ˆã€‚ åœ¨ä½¿ç”¨èšç°‡ç´¢å¼•æ—¶ï¼Œä¸»é”®ç´¢å¼•çš„ leaf page åŒ…å«æ‰€æœ‰å­—æ®µï¼ŒäºŒçº§ç´¢å¼•çš„ leaf page åŒ…å«ä¸»é”®å’Œç´¢å¼•å­—æ®µã€‚å½“ä½¿ç”¨ä¸»é”®æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢åˆ° leaf page å³å¯è·å¾—æ•´æ¡æ•°æ®ã€‚å½“ä½¿ç”¨äºŒçº§ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œè‹¥æŸ¥è¯¢å­—æ®µåŒ…å«åœ¨ç´¢å¼•å†…ï¼Œå¯ä»¥ç›´æ¥å¾—åˆ°ç»“æœï¼Œä½†å¦‚æœæŸ¥è¯¢å­—æ®µä¸åŒ…å«åœ¨ç´¢å¼•å†…ï¼Œåˆ™éœ€ä½¿ç”¨å¾—åˆ°çš„ä¸»é”®å­—æ®µåœ¨ä¸»é”®ç´¢å¼•ä¸­å†æ¬¡æŸ¥è¯¢ï¼Œä»¥å¾—åˆ°æ‰€æœ‰çš„å­—æ®µï¼Œè¿›è€Œå¾—åˆ°éœ€è¦æŸ¥è¯¢çš„å­—æ®µï¼Œè¿™å°±æ˜¯å›è¡¨çš„è¿‡ç¨‹ã€‚ åœ¨ä½¿ç”¨éèšç°‡ç´¢å¼•æ—¶ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ä¸»é”®æŸ¥è¯¢è¿˜æ˜¯äºŒçº§ç´¢å¼•æŸ¥è¯¢ï¼Œæœ€ç»ˆå¾—åˆ°çš„ç»“æœéƒ½æ˜¯ record idï¼Œéœ€è¦ä½¿ç”¨ record id å»æŸ¥è¯¢çœŸæ­£å¯¹åº”çš„æ•´æ¡è®°å½•ã€‚ èšç°‡ç´¢å¼•çš„ä¼˜ç‚¹æ˜¯ï¼Œæ•´æ¡è®°å½•ç›´æ¥å­˜æ”¾åœ¨ leaf pageï¼Œæ— éœ€äºŒæ¬¡æŸ¥è¯¢ï¼Œä¸”ç¼“å­˜å‘½ä¸­ç‡é«˜ï¼Œåœ¨ä½¿ç”¨ä¸»é”®æŸ¥è¯¢æ—¶æ€§èƒ½æ¯”è¾ƒå¥½ã€‚ç¼ºç‚¹åˆ™æ˜¯äºŒçº§ç´¢å¼•å¯èƒ½éœ€è¦å›è¡¨ï¼Œä¸”ç”±äºæ•´æ¡æ•°æ®å­˜æ”¾åœ¨ leaf pageï¼Œæ›´æ–°ç´¢å¼•çš„ä»£ä»·å¾ˆé«˜ï¼Œé¡µåˆ†è£‚ã€åˆå¹¶ç­‰æƒ…å†µå¼€é”€æ¯”è¾ƒå¤§ã€‚ éèšç°‡ç´¢å¼•çš„ä¼˜ç‚¹æ˜¯ï¼Œç”±äº leaf page ä»…å­˜æ”¾ record idï¼Œæ›´æ–°çš„ä»£ä»·è¾ƒä½ï¼ŒäºŒçº§ç´¢å¼•çš„æ€§èƒ½å’Œä¸»é”®ç´¢å¼•å‡ ä¹ç›¸åŒã€‚ç¼ºç‚¹æ˜¯æŸ¥è¯¢æ—¶å‡éœ€ä½¿ç”¨ record id è¿›è¡ŒäºŒæ¬¡æŸ¥è¯¢ã€‚</p><h3 id=task2-btree-data-structure-insertion-deletion-point-search>Task2 B+Tree Data Structure (Insertion, Deletion, Point Search)<a hidden class=anchor aria-hidden=true href=#task2-btree-data-structure-insertion-deletion-point-search>#</a></h3><p><strong>Search</strong></p><p>B+ æ ‘çš„èŠ‚ç‚¹åˆ†ä¸º internal page å’Œ leaf pageï¼Œæ¯ä¸ª page ä¸Šçš„ key æœ‰åºæ’åˆ—ã€‚å½“æ‹¿åˆ°ä¸€ä¸ª key éœ€è¦æŸ¥æ‰¾å¯¹åº”çš„ value æ—¶ï¼Œé¦–å…ˆéœ€è¦ç»ç”± internal page é€’å½’åœ°å‘ä¸‹æŸ¥æ‰¾ï¼Œæœ€ç»ˆæ‰¾åˆ° key æ‰€åœ¨çš„ leaf pageã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºä¸€ä¸ªå‡½æ•° <code>FindLeafPage()</code>ã€‚</p><p><code>FindLeafPage()</code> ä» root page å¼€å§‹ä¸€å±‚ä¸€å±‚çš„æŸ¥æ‰¾ã€‚åœ¨æŸ¥æ‰¾åˆ° leaf page æ—¶ç›´æ¥è¿”å›ï¼Œå¦åˆ™æ ¹æ® key åœ¨å½“å‰ internal page ä¸­æ‰¾åˆ°å¯¹åº”çš„ child page idï¼Œå†åœ¨child page ä¸­æŸ¥æ‰¾ã€‚ç”±äº key æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥ç›´æ¥è¿›è¡ŒäºŒåˆ†æœç´¢ã€‚</p><p>internal page ä¸­å‚¨å­˜ key å’Œ child page idï¼Œé‚£ä¹ˆåœ¨æ‹¿åˆ° page id åå¦‚ä½•è·å¾—å¯¹åº”çš„ page æŒ‡é’ˆï¼Ÿç”¨ Project 1 ä¸­å®ç°çš„ buffer poolã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>Page</span> <span class=o>*</span><span class=n>page</span> <span class=o>=</span> <span class=n>buffer_pool_manager_</span><span class=o>-&gt;</span><span class=n>FetchPage</span><span class=p>(</span><span class=n>page_id</span><span class=p>);</span>
</span></span></code></pre></div><p>åœ¨è·å–åˆ°ä¸€ä¸ª page åï¼Œå¦‚ä½•ä½¿ç”¨è¿™ä¸ª page æ¥å­˜å‚¨æ•°æ®ï¼Ÿä¹‹å‰å·²ç»æåˆ°è¿‡ï¼Œpage çš„ <code>data_</code> å­—æ®µæ˜¯å®é™…ç”¨äºå­˜å‚¨æ•°æ®çš„ 4KB å¤§å°çš„å­—èŠ‚æ•°ç»„ã€‚é€šè¿‡ <code>reinterpret_cast</code> å°†è¿™ä¸ªå­—èŠ‚æ•°ç»„å¼ºåˆ¶è½¬æ¢ä¸ºæˆ‘ä»¬è¦ä½¿ç”¨çš„ç±»å‹ï¼Œä¾‹å¦‚ leaf pageï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>auto</span> <span class=n>leaf_page</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>B_PLUS_TREE_LEAF_PAGE_TYPE</span> <span class=o>*&gt;</span><span class=p>(</span><span class=n>page</span><span class=o>-&gt;</span><span class=n>GetData</span><span class=p>())</span>
</span></span></code></pre></div><p><code>reinterpret_cast</code> ç”¨äºæ— å…³ç±»å‹çš„å¼ºåˆ¶è½¬æ¢ï¼Œè½¬æ¢æ–¹æ³•å¾ˆç®€å•ï¼ŒåŸå§‹ bits ä¸å˜ï¼Œåªæ˜¯å¯¹è¿™äº› bits ç”¨æ–°ç±»å‹è¿›è¡Œäº†é‡æ–°çš„è§£è¯»ã€‚å¯æƒ³è€ŒçŸ¥è¿™ç§è½¬æ¢éå¸¸ä¸å®‰å…¨ï¼Œéœ€è¦ç¡®ä¿è½¬æ¢åçš„å†…å­˜å¸ƒå±€ä»æ˜¯åˆæ³•çš„ã€‚åœ¨è¿™é‡ŒåŸç±»å‹æ˜¯ byte æ•°ç»„ï¼Œæ–°ç±»å‹æ˜¯æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„ tree pageã€‚</p><p>æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢ä¸¤éƒ¨å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºæ ¹æ®page_idè·å–BPlusTreePageåŸå§‹çš„pageå’Œpage.dataã€‚æ³¨æ„è¿™é‡Œreinterpret_castè¿”å›çš„æ˜¯BPlusTreePageï¼Œåç»­è¿˜éœ€è¦è½¬æˆå…¶å­ç±»leafå’Œinteral pageã€‚ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>INDEX_TEMPLATE_ARGUMENTS</span> <span class=k>auto</span> <span class=n>BPLUSTREE_TYPE</span><span class=o>::</span><span class=n>FetchBPlusTreePage</span><span class=p>(</span><span class=n>page_id_t</span> <span class=n>page_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>-&gt;</span> <span class=n>std</span><span class=o>::</span><span class=n>pair</span><span class=o>&lt;</span><span class=n>Page</span> <span class=o>*</span><span class=p>,</span> <span class=n>BPlusTreePage</span> <span class=o>*&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>Page</span> <span class=o>*</span><span class=n>page</span> <span class=o>=</span> <span class=n>buffer_pool_manager_</span><span class=o>-&gt;</span><span class=n>FetchPage</span><span class=p>(</span><span class=n>page_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>BUSTUB_ASSERT</span><span class=p>(</span><span class=n>page</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>,</span> <span class=s>&#34;FetchBPlusTreePage(): page != nullptr&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span><span class=n>page</span><span class=p>,</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>BPlusTreePage</span> <span class=o>*&gt;</span><span class=p>(</span><span class=n>page</span><span class=o>-&gt;</span><span class=n>GetData</span><span class=p>())};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>æ‰¾åˆ° leaf page åï¼ŒåŒæ ·æ˜¯äºŒåˆ†æŸ¥æ‰¾ keyï¼Œæ‰¾åˆ°å¯¹åº”çš„ record idã€‚æ³¨æ„åœ¨leaf pageä¸­äºŒåˆ†æŸ¥æ‰¾å·¦è¾¹ç•Œæ˜¯0ï¼Œåœ¨internal pageä¸­äºŒåˆ†æŸ¥æ‰¾å·¦è¾¹ç•Œæ˜¯1ã€‚</p><p>åœ¨æŸ¥æ‰¾çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦ä¸”å¤æ‚çš„ç»†èŠ‚ï¼Œå°±æ˜¯ page unpin çš„é—®é¢˜ã€‚</p><p>æˆ‘ä»¬åœ¨æ‹¿åˆ° page id åï¼Œè°ƒç”¨ buffer pool çš„ <code>FetchPage()</code> å‡½æ•°æ¥è·å–å¯¹åº”çš„ page æŒ‡é’ˆã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨å®Œ page ä¹‹åï¼Œéœ€è¦å°† page unpin æ‰ï¼Œå¦åˆ™æœ€ç»ˆä¼šå¯¼è‡´ buffer pool ä¸­çš„æ‰€æœ‰ page éƒ½è¢« pin ä½ï¼Œbuffer pool æ»¡æ— æ³•è¿›è¡Œæ¢å…¥æ¢å‡ºï¼Œæ— æ³•ä» disk è¯»å–å…¶ä»–çš„ pageã€‚</p><p>æ¯”è¾ƒåˆé€‚çš„åšæ³•æ˜¯ï¼Œåœ¨æœ¬æ¬¡æ“ä½œä¸­ï¼Œæ‰¾å‡º page æœ€åä¸€æ¬¡è¢«ä½¿ç”¨çš„åœ°æ–¹ï¼Œå¹¶åœ¨æœ€åä¸€æ¬¡ä½¿ç”¨å unpinã€‚</p><p><strong>Insert</strong></p><p>ä¸ Search ç›¸åŒï¼Œç¬¬ä¸€æ­¥æ˜¯æ ¹æ® key æ‰¾åˆ°éœ€è¦æ’å…¥çš„ leaf pageã€‚åŒæ ·æ˜¯è°ƒç”¨ <code>FindLeafPage()</code>ã€‚å¾—åˆ° leaf page åï¼Œå°† key æ’å…¥ leaf pageã€‚å½“B+æ ‘ä¸ºç©ºæ—¶ï¼Œæ–°å»ºä¸€ä¸ªleaf pageä½œä¸ºroot pageå°†å…¶æ’å…¥ã€‚è¦æ³¨æ„çš„æ˜¯ï¼š1.æ’å…¥æ—¶ä»éœ€ä¿è¯ key çš„æœ‰åºæ€§ï¼ŒåŒæ ·å¯ä»¥äºŒåˆ†æœç´¢æ‰¾åˆ°åˆé€‚çš„ä½ç½®æ’å…¥ã€‚2.æ˜¯ä¸å…è®¸æœ‰é‡å¤çš„keyçš„ï¼Œå½“æ’å…¥é‡å¤çš„keyè¿”å›falseã€‚</p><p>åœ¨æ’å…¥åï¼Œéœ€è¦æ£€æŸ¥å½“å‰ leaf page size æ˜¯å¦ç­‰äº max sizeã€‚è‹¥ç›¸ç­‰ï¼Œåˆ™è¦è¿›è¡Œä¸€æ¬¡ leaf page åˆ†è£‚æ“ä½œã€‚å…·ä½“æ­¥éª¤ä¸ºï¼š</p><ol><li>æ–°å»ºä¸€ä¸ªç©ºçš„ pageï¼Œ</li><li>å°†åŸ page çš„ä¸€åŠè½¬ç§»åˆ°æ–° page ä¸­ï¼Œï¼ˆå‡å¦‚é€‰æ‹©å°†æ–° page æ”¾åœ¨åŸ page å³ä¾§ï¼Œåˆ™è½¬ç§»åŸ page çš„å³åŠéƒ¨åˆ†ï¼‰</li><li>æ›´æ–°åŸ page å’Œæ–° page çš„ next page idï¼Œ</li><li>è·å– parent pageï¼Œå°†ç”¨äºåŒºåˆ†åŸ page å’Œæ–° page çš„ key æ’å…¥ parent page ä¸­ï¼Œ</li><li>æ›´æ–° parent page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚</li></ol><p>éœ€è¦ç»™ parent page æ’å…¥ä¸€ä¸ªæ–° key çš„åŸå› æ˜¯ï¼Œå¤šäº†ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œè‡ªç„¶éœ€è¦å¤šä¸€ä¸ª key æ¥åŒºåˆ†ï¼Œè¿™ä¸ªkeyæ˜¯å³è¾¹èŠ‚ç‚¹çš„key0ã€‚å…¶ä¸­ç¬¬ 4 æ­¥æ˜¯é‡ç‚¹ã€‚è·å– parent page å¹¶ä¸æ˜¯ç®€å•åœ°é€šè¿‡å½“å‰ page çš„ parent id æ¥è·å–ï¼Œå› ä¸º parent page ä¹Ÿå¯èƒ½å‘ç”Ÿåˆ†è£‚ã€‚</p><p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸€æ£µ 5 é˜¶çš„ B+ æ ‘ã€‚5 é˜¶åªæ˜¯ä¸€ç§å¸¸ç”¨çš„è¯´æ³•ï¼Œä»£è¡¨ B+ æ ‘èŠ‚ç‚¹æœ€å¤šèƒ½å®¹çº³äº”ä¸ª KV å¯¹ã€‚å¯¹äº leaf page æ¥è¯´ï¼Œå½“ B+ æ ‘å¤„äºç¨³å®šçŠ¶æ€æ—¶ï¼ˆæ’å…¥ã€åˆ é™¤ç­‰æ“ä½œå·²ç»å®Œå…¨ç»“æŸï¼‰ï¼Œæœ€å¤šåªèƒ½æœ‰ 4 ä¸ª KV å¯¹ã€‚å¯¹äº internal pageï¼Œæœ€å¤šæœ‰ 4 ä¸ª keyï¼Œ5 ä¸ª valueï¼Œå¯ä»¥çœ‹æˆæ˜¯æœ‰ 5 ä¸ª KV å¯¹ã€‚</p><p>å› æ­¤ï¼Œinstruction ä¸­æœ‰è¿™ä¹ˆä¸€å¥è¯ï¼š</p><blockquote><p>You should correctly perform splits if insertion triggers the splitting condition (number of key/value pairs <strong>AFTER</strong> insertion equals to max_size for leaf nodes, number of children <strong>BEFORE</strong> insertion equals to max_size for internal nodes.).</p></blockquote><p>åœ¨æ’å…¥åæ£€æµ‹ leaf page æ˜¯å¦éœ€è¦åˆ†è£‚ï¼Œå› ä¸º leaf page ç¨³å®šæ—¶åªæœ‰ 4 ä¸ª KV å¯¹ï¼Œæ’å…¥åæœ‰ 5 ä¸ªï¼Œä»èƒ½å®¹çº³ã€‚åœ¨æ’å…¥å‰æ£€æµ‹ internal pageï¼Œå› ä¸º internal page ç¨³å®šæ—¶å°±æœ‰ 5 ä¸ª KV å¯¹ï¼Œè‹¥æ’å…¥åå†æ£€æµ‹ï¼Œæ’å…¥çš„ç¬¬ 6 ä¸ª KV å¯¹ä¼šé€ æˆè¶Šç•Œã€‚</p><p>å®é™…ä¸Šè¿™ä¹Ÿåªæ˜¯ä¸€ç§çº¦å®šï¼Œå¹¶ä¸æ˜¯å¼ºåˆ¶çš„è§„åˆ™ã€‚</p><p>ç¬¬ 4 æ­¥å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š 1. æ ¹æ®leaf pageçš„ parent page id æ‹¿åˆ° parent pageï¼Œ 2. åˆ¤æ–­ parent page size æ˜¯å¦ç­‰äº max sizeï¼Œï¼ˆæ’å…¥å‰æ£€æŸ¥ï¼‰ 3. è‹¥å°äºï¼Œç›´æ¥è¿”å› parent pageï¼Œ 4. å¦åˆ™ï¼Œåˆ†è£‚å½“å‰ internal pageã€‚å¹¶æ ¹æ®æ­¤åéœ€è¦æ’å…¥çš„ key é€‰æ‹©åˆ†è£‚åçš„ä¸¤ä¸ª page ä¹‹ä¸€ä½œä¸º parent page è¿”å›ã€‚</p><p>åˆ†è£‚ internal page çš„æ­¥éª¤ä¸ºï¼š 1. æ–°å»ºä¸€ä¸ªç©ºçš„ InternalPageï¼Œ 2. å°†åŸ page çš„ä¸€åŠè½¬ç§»åˆ°æ–° page ä¸­ï¼Œéœ€è¦æ³¨æ„åŸ page å’Œæ–° page çš„ç¬¬ä¸€ä¸ª key éƒ½æ˜¯æ— æ•ˆçš„ï¼Œ 3. æ›´æ–°æ–° page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆï¼ŒæŒ‡å‘æ–° pageï¼Œ 4. è·å– parent pageï¼Œ 5. å°†ç”¨äºåŒºåˆ†åŸ page å’Œæ–° page çš„ key æ’å…¥ parent page ä¸­ï¼Œ 6. æ›´æ–° parent page æ‰€æœ‰ child page çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚</p><p>è¿™é‡Œå‘ç”Ÿäº†å‘ä¸Šçš„é€’å½’ï¼Œç›´åˆ°é‡åˆ°å®‰å…¨çš„çˆ¶èŠ‚ç‚¹æˆ–è€…é‡åˆ°æ ¹èŠ‚ç‚¹ã€‚åœ¨é‡åˆ°æ ¹èŠ‚ç‚¹æ—¶ï¼Œè‹¥æ ¹èŠ‚ç‚¹ä¹Ÿéœ€è¦åˆ†è£‚ï¼Œåˆ™é™¤äº†éœ€è¦æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æ¥å®¹çº³åŸæ ¹èŠ‚ç‚¹ä¸€åŠçš„ KV å¯¹ï¼Œè¿˜éœ€è¦æ–°å»ºä¸€ä¸ªæ–°çš„æ ¹èŠ‚ç‚¹ã€‚</p><p>å‡å¦‚æœ‰ä¸€æ£µ 4 é˜¶çš„ B+ æ ‘ï¼š</p><p><img loading=lazy src=../imgs/image-20231210210827043.png alt=image-20231210210827043></p><p><strong>Delete</strong></p><p>åŒæ ·åœ°ï¼Œå…ˆæ‰¾åˆ° leaf pageã€‚åˆ é™¤ leaf page ä¸­ key å¯¹åº”çš„ KV å¯¹åï¼Œæ£€æŸ¥ size æ˜¯å¦å°äº min sizeã€‚å¦‚æœå°äºçš„è¯ï¼Œé¦–å…ˆå°è¯•ä»ä¸¤ä¾§çš„å…„å¼ŸèŠ‚ç‚¹ä¸­å·ä¸€ä¸ª KV å¯¹ã€‚æ³¨æ„åªèƒ½ä»å…„å¼ŸèŠ‚ç‚¹ï¼Œå³çˆ¶èŠ‚ç‚¹ç›¸åŒçš„èŠ‚ç‚¹ä¸­é€‰å–ã€‚å‡å¦‚å­˜åœ¨ä¸€ä¾§èŠ‚ç‚¹æœ‰å¯Œä½™çš„ KV å¯¹ï¼Œåˆ™æˆåŠŸå·å–ï¼Œç»“æŸæ“ä½œã€‚è‹¥ä¸¤ä¾§éƒ½æ²¡æœ‰å¯Œä½™çš„ KV å¯¹ï¼Œåˆ™é€‰æ‹©ä¸€ä¾§èŠ‚ç‚¹ä¸å…¶åˆå¹¶ã€‚</p><p>å·å–çš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œä»å·¦ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå·¦ä¾§èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹ç¬¬ä¸€ä¸ª KV å¯¹ï¼Œä»å³ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå³ä¾§èŠ‚ç‚¹çš„ KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹ã€‚leaf page å’Œ internal page çš„å·å–è¿‡ç¨‹åŸºæœ¬ç›¸åŒï¼Œä»…éœ€æ³¨æ„ internal page å·å–åæ›´æ–°å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚</p><p>ç¨éš¾çš„æ˜¯åˆå¹¶çš„è¿‡ç¨‹ã€‚åŒæ ·ï¼Œä»»é€‰å·¦å³ä¾§ä¸€å…„å¼ŸèŠ‚ç‚¹è¿›è¡Œåˆå¹¶ã€‚å°†ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰ KV å¯¹è½¬ç§»è‡³å¦ä¸€èŠ‚ç‚¹ã€‚è‹¥åˆå¹¶çš„æ˜¯ leaf pageï¼Œè®°å¾—æ›´æ–° next page idã€‚è‹¥åˆå¹¶çš„æ˜¯ internal pageï¼Œè®°å¾—æ›´æ–°åˆå¹¶å page çš„å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚ç„¶åï¼Œåˆ é™¤ parent èŠ‚ç‚¹ä¸­å¯¹åº”çš„ keyã€‚åˆ é™¤åï¼Œå†æ¬¡æ£€æŸ¥ size æ˜¯å¦å°äº min sizeï¼Œå½¢æˆå‘ä¸Šé€’å½’ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œroot page å¹¶ä¸å— min size çš„é™åˆ¶ã€‚ä½†å¦‚æœ root page è¢«åˆ åˆ° size åªå‰© 1ï¼Œå³åªæœ‰ä¸€ä¸ª child page çš„æ—¶å€™ï¼Œåº”å°†æ­¤ child page è®¾ç½®ä¸ºæ–°çš„ root pageã€‚</p><p>å¦å¤–ï¼Œåœ¨åˆå¹¶æ—¶ï¼Œä¸¤ä¸ª page åˆå¹¶æˆä¸€ä¸ª pageï¼Œå¦ä¸€ä¸ª page åº”è¯¥åˆ é™¤ï¼Œé‡Šæ”¾èµ„æºã€‚åˆ é™¤ page æ—¶ï¼Œä»æ˜¯è°ƒç”¨ buffer pool çš„ <code>DeletePage()</code> å‡½æ•°ã€‚</p><p>å’Œ Insert ç±»ä¼¼ï¼ŒDelete è¿‡ç¨‹ä¹Ÿæ˜¯å…ˆå‘ä¸‹é€’å½’æŸ¥è¯¢ leaf pageï¼Œä¸æ»¡è¶³ min size åå…ˆå°è¯•å·å–ï¼Œæ— æ³•å·å–åˆ™åˆå¹¶ï¼Œå¹¶å‘ä¸Šé€’å½’åœ°æ£€æŸ¥æ˜¯å¦æ»¡è¶³ min sizeã€‚</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dueplay.github.io/tags/bustub/>Bustub</a></li></ul><nav class=paginav><a class=prev href=https://dueplay.github.io/posts/bustub-project4-concurrency/><span class=title>Â« Prev</span><br><span>bustub project4 concurrency</span>
</a><a class=next href=https://dueplay.github.io/posts/bustub-project1/><span class=title>Next Â»</span><br><span>bustub project1</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://dueplay.github.io/>Cookie's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>