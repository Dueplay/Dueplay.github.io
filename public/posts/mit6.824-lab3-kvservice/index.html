<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MIT6.824 Lab3 KVService | Cookie&#39;s Blog</title>
<meta name="keywords" content="Raft, Distributed System, Consensus Algorithm">
<meta name="description" content="Fault-tolerant KV Service based on Raft">
<meta name="author" content="Me">
<link rel="canonical" href="https://canonical.url/to/page">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2eadbb982468c11a433a3e291f01326f2ba43f065e256bf792dbd79640a92316.js" integrity="sha256-Lq27mCRowRpDOj4pHwEybyukPwZeJWv3ktvXlkCpIxY="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/mit6.824-lab3-kvservice/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XHWHM02GB"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-4XHWHM02GB', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="MIT6.824 Lab3 KVService" />
<meta property="og:description" content="Fault-tolerant KV Service based on Raft" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/mit6.824-lab3-kvservice/" />
<meta property="og:image" content="http://localhost:1313/%3Cimage%20path/url%3E" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-22T18:16:09&#43;08:00" />
<meta property="article:modified_time" content="2022-09-22T18:16:09&#43;08:00" /><meta property="og:site_name" content="ExampleSite" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/%3Cimage%20path/url%3E" />
<meta name="twitter:title" content="MIT6.824 Lab3 KVService"/>
<meta name="twitter:description" content="Fault-tolerant KV Service based on Raft"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "MIT6.824 Lab3 KVService",
      "item": "http://localhost:1313/posts/mit6.824-lab3-kvservice/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MIT6.824 Lab3 KVService",
  "name": "MIT6.824 Lab3 KVService",
  "description": "Fault-tolerant KV Service based on Raft",
  "keywords": [
    "Raft", "Distributed System", "Consensus Algorithm"
  ],
  "articleBody": "Introduction æ‘¸äº†ä¸€æ®µæ—¶é—´çš„é±¼ï¼Œå»å°è¯•ç”¨ SpringBoot + Vue æ­å»ºä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„ Web åº”ç”¨ã€‚éƒ½è¯´ CS çš„å­¦ç”Ÿä¸èƒ½åªä¼šç”¨æ¡†æ¶ CRUDï¼Œä½†æ›´ä¸èƒ½ä¸ä¼šç”¨æ¡†æ¶ CRUDã€‚å¤§æ¦‚åšå‡ºæ¥ä¸€ä¸ªå° demo åå°±æ²¡æœ‰å†ç»§ç»­äº†ã€‚æ¥ç€æ¥åš 6.824ã€‚\nLab3 å’Œ Lab2 å„æœ‰å„çš„éš¾å¤„ã€‚Lab2 æ˜¯ Raft çš„æ ¸å¿ƒï¼Œéœ€è¦å°å¿ƒåœ°å¤„ç†å„ç§ corner caseã€‚ä½†å¥½åœ¨æœ‰ Figure2 çš„å¼•å¯¼ï¼Œæœ€ç»ˆä¹Ÿæ˜¯æŒ‰ç…§å…¶ä¸¥æ ¼çš„è§„å®šæˆåŠŸå®ç°ã€‚Lab3 ç¼–ç éš¾åº¦ä¸å¦‚ Lab2ï¼Œä½†æ²¡æœ‰è¯¦ç»†çš„å¼•å¯¼ï¼Œç•™ç»™ä¸ªäººè‡ªç”±å‘æŒ¥çš„ç©ºé—´æ›´å¤§ (æ›´æœ‰å¯èƒ½ä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹)ã€‚\nLab3 éœ€è¦åœ¨ Raft å±‚ä¸Šå®ç°ä¸€ä¸ª fault-tolerant key-value serviceï¼Œæ»¡è¶³å¼ºä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ˜¯çº¿æ€§ä¸€è‡´æ€§ (Linearizable Consistency)ã€‚çº¿æ€§ä¸€è‡´æ€§ä¿è¯æ•´ä¸ªç³»ç»Ÿçœ‹èµ·æ¥å¥½åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚ç®€å•åœ°è¯´ï¼Œçº¿æ€§ä¸€è‡´æ€§ç³»ç»Ÿçš„è¯»å†™æ“ä½œæœ‰ä»¥ä¸‹ç‰¹å¾ï¼š\nè¯»å†™å¹¶ä¸èƒ½ç¬é—´å®Œæˆï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…è¿›è¡Œã€‚ è¯»åœ¨å†™å¼€å§‹å‰å®Œæˆï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯æ—§å€¼ï¼›è¯»åœ¨å†™å®Œæˆä¹‹åå¼€å§‹ï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯æ–°å€¼ã€‚(è¯»å†™æ“ä½œæ— é‡åˆéƒ¨åˆ†) è¯»å†™å¹¶å‘è¿›è¡Œï¼Œå³æœ‰é‡åˆéƒ¨åˆ†æ—¶ï¼Œæ—¢å¯èƒ½è¯»åˆ°æ–°å€¼ï¼Œä¹Ÿå¯èƒ½è¯»åˆ°æ—§å€¼ã€‚ ä¸€æ—¦æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯»å–åˆ°äº†æ–°å€¼ï¼Œé‚£ä¹ˆä¹‹åçš„å®¢æˆ·ç«¯ä¸€å®šä¹Ÿéƒ½ä¼šè¯»å–åˆ°æ–°å€¼ã€‚ å…³äºçº¿æ€§ä¸€è‡´æ€§æ›´åŠ è¯¦ç»†çš„å®šä¹‰å’Œè§£æï¼Œå¯ä»¥é˜…è¯»ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿã€‹(DDIA) ç›¸å…³ç« èŠ‚ã€‚\nå…ˆæ¥çœ‹çœ‹æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„ï¼š\næ•´ä¸ª KV Service ç”±å¤šä¸ª Server ç»„æˆï¼Œæ¯ä¸ª Server åŒ…å«ä¸€ä¸ª State Machineï¼Œå…·ä½“åœ¨ lab ä¸­æ˜¯ä¸€ä¸ª KV æ•°æ®åº“ï¼›Server è¿˜åŒ…å«ä¸€ä¸ª Raft èŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå„ Server ä¹‹é—´å¹¶ä¸ä¼šç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é å…¶ Raft èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚\næ•´ä¸ªç³»ç»Ÿçš„ç†æƒ³è¿è¡Œæµç¨‹æ˜¯ï¼š\nClient é€šè¿‡ RPC å‘ KV Service å‘é€è¯·æ±‚ï¼Œä¾‹å¦‚ Put(x,1) KV Service å°†è¯·æ±‚è½¬å‘ç»™å½“å‰æ‹¥æœ‰ Leader Raft èŠ‚ç‚¹çš„ Server Leader Server å°†è¯·æ±‚åŒ…å«çš„ command ä¼ é€’ç»™ Raft å±‚ Raft å±‚å¯¹ command è¿›è¡Œå…±è¯†ï¼Œç”Ÿæˆç›¸åŒçš„ log replica åœ¨è¾¾æˆå…±è¯†åï¼ŒRaft å±‚å°† command Apply å› Server Server æ”¶åˆ° Raft å±‚çš„ Apply åï¼Œå°† command åº”ç”¨åˆ°çŠ¶æ€æœºï¼Œå³çŠ¶æ€æœºæ­¤æ—¶çŠ¶æ€ä¸º {x: 1} æˆåŠŸåº”ç”¨è‡³çŠ¶æ€æœºåï¼ŒServer å¯¹ Client çš„ RPC è¿›è¡Œå›å¤ï¼Œè¿”å›ç»“æœå’Œé”™è¯¯ç ã€‚ å½“ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸è¿è¡Œæ—¶ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆæ¸…æ™°ç¾å¥½ã€‚ä½†æ˜¯ä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œå¦‚èŠ‚ç‚¹æŒ‚æ‰ã€RPCä¸¢åŒ…ã€ç½‘ç»œåˆ†åŒºç­‰ç­‰ï¼Œæƒ…å†µå°±å˜å¾—æ¯”è¾ƒå¤æ‚äº†ã€‚\nImplement åœ¨ Lab3 ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç°çš„éƒ¨åˆ†æ˜¯ Client ã€ Server å’Œ Server KV Databaseã€‚\nKV Database åœ¨ lab ä¸­ï¼ŒKV æ•°æ®åº“å¹¶ä¸æ˜¯ä¸»è¦å†…å®¹ã€‚å› æ­¤ç›´æ¥ç”¨ Hashmap æ¨¡æ‹Ÿå³å¯ã€‚é”®å€¼å‡ä¸º Stringã€‚\ntype kvdb struct { m map[string]string } func (db *kvdb) put(key string, value string) { db.m[key] = value } func (db *kvdb) append(key string, value string) { db.m[key] += value } func (db *kvdb) get(key string) (string, Err) { if _, ok := db.m[key]; !ok { return \"\", ErrNoKey } return db.m[key], OK } åœ¨è¿™é‡Œï¼Œæˆ‘æ²¡æœ‰åœ¨ KV db ä¸­ä½¿ç”¨å•ç‹¬çš„é”ã€‚å› ä¸ºè¿™äº›æ“ä½œåœ¨åç»­ä»£ç ä¸­éƒ½æ˜¯äº’æ–¥è¿›è¡Œçš„ï¼Œæ— éœ€é¢å¤–åŠ é”ã€‚\nClient Client ä¹Ÿç›¸å¯¹ç®€å•ã€‚Client å¯å‘ Server å‘é€ä¸‰ç§ä¸åŒçš„ RPCï¼šPut(key,value)ï¼Œ Append(key,arg)å’Œ Get(key)ã€‚Put å’Œ Append å‡ä¸ºå†™è¯·æ±‚ï¼ŒGet ä¸ºè¯»è¯·æ±‚ã€‚\nä¸€å¼€å§‹ï¼ŒClient å¹¶ä¸çŸ¥é“ Leader Server æ˜¯å“ªå° Serverã€‚Client å¯å‘éšæœºä¸€å° Server å‘é€ RPC è¯·æ±‚ã€‚å‡å¦‚è¯·æ±‚çš„ Server ä¸æ˜¯å½“å‰çš„ Leader Serverï¼Œæˆ–è€…ç”±äºç½‘ç»œä¸­æ–­ã€Server Crash ç­‰åŸå› ï¼Œæ— æ³•ä¸ Server å–å¾—è”ç³»ï¼Œåˆ™æ— é™åœ°å°è¯•æ›´æ¢ Server é‡æ–°å‘é€è¯·æ±‚ï¼Œç›´åˆ°è¯·æ±‚æˆåŠŸè¢«å¤„ç†ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œåœ¨å¾—çŸ¥ Leader Server åï¼ŒClient å¯ä»¥ä¿å­˜ Leader çš„ idï¼Œé¿å…ä¸‹æ¬¡å‘èµ·è¯·æ±‚æ—¶åˆéœ€è¦éšæœºåœ°é€‰æ‹©ä¸€å° Server å¤šæ¬¡å°è¯•ã€‚\ntype Clerk struct { servers []*labrpc.ClientEnd seq int64 // write op index, increasing from 1 id int64 // client uuid leader int } func (ck *Clerk) Get(key string) string { args := GetArgs{ Key: key, ClientId: ck.id, } i := ck.leader defer func() { ck.leader = i }() for { reply := GetReply{} ok := ck.servers[i].Call(\"KVServer.Get\", \u0026args, \u0026reply) if !ok || reply.Err == ErrWrongLeader || reply.Err == ErrTimeout { // cannot reach the server, or it's a wrong leader: retry i = (i + 1) % len(ck.servers) continue } if reply.Err == ErrNoKey { return \"\" } return reply.Value } } func (ck *Clerk) PutAppend(key string, value string, op string) { args := PutAppendArgs{ Key: key, Value: value, Op: op, Seq: ck.seq, ClientId: ck.id, } i := ck.leader defer func() { ck.seq++ ck.leader = i }() for { reply := PutAppendReply{} ok := ck.servers[i].Call(\"KVServer.PutAppend\", \u0026args, \u0026reply) if !ok || reply.Err == ErrWrongLeader || reply.Err == ErrTimeout { // cannot reach the server, or it's a wrong leader: retry i = (i + 1) % len(ck.servers) continue } // successfully PutAppend return } } å…³äº Client è¿˜éœ€è¦ç»´æŠ¤çš„å¦ä¸€äº›çŠ¶æ€ï¼Œå¦‚ id å’Œ seqï¼Œå¾…ä¼šå„¿å†è®¨è®ºã€‚\nServer Server åº”è¯¥æ˜¯ Lab3 ä¸­æœ€ä¸ºå¤æ‚çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬å…ˆè®¨è®ºä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¸‹ Server çš„è®¾è®¡ã€‚\nè¯»å†™ RPC Handler åœ¨æ¥æ”¶åˆ° Client çš„è¯·æ±‚åï¼Œé€šè¿‡è°ƒç”¨ raft.Start() å°†è¯·æ±‚åŒ…å«çš„ command ä¼ é€’åˆ° Raft å±‚ï¼Œè¾¾æˆå…±è¯†ã€‚å½“ç„¶ï¼Œå¦‚æœå½“å‰ Server ä¸ä¸º Leaderï¼Œåˆ™å‘ Client è¿”å› ErrWrongLeader é”™è¯¯ï¼ŒClient åœ¨æ”¶åˆ°å›å¤åé‡æ–°å°è¯•å‘å¦ä¸€å° Server å‘èµ·è¯·æ±‚ã€‚Raft å±‚è¾¾æˆå…±è¯†åï¼Œé€šè¿‡ applyCh é€šçŸ¥ Server è¯¥ command å·²è¾¾æˆå…±è¯†ã€‚\nåœ¨ä¸€å¼€å§‹ï¼Œå¯èƒ½ä¼šè¿™æ ·è®¾è®¡ Serverï¼š\n_, _, isLeader := kv.rf.Start(op) // push op to raft layer to reach the agreement if !isLeader { reply.Err = ErrWrongLeader return } \u003c- applyCh // agreed! apply to statemachine kv.apply(op) å¯¹äºä¸å‡ºé”™çš„å• Clientï¼Œè¿™æ ·è®¾è®¡ä¼¼ä¹æ²¡æœ‰é—®é¢˜ã€‚ä½†å¦‚æœæœ‰å¤šä¸ª Client å¹¶è¡Œåœ°å‘ Server å‘èµ·è¯·æ±‚æ—¶ï¼Œå°±æ˜¾ç„¶ä¸èƒ½ä¿è¯ä» applyCh ä¼ å›çš„æ•°æ®æ°å¥½æ˜¯æ­¤å‰æäº¤çš„ command äº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Server ä¸­å¯¹ç‰¹å®šçš„ command è¿›è¡Œç­‰å¾…ã€‚å¦‚ä½•åŒºåˆ†ä¸åŒçš„ commandï¼Ÿç”¨ command åœ¨ raft log ä¸­çš„ index åŒºåˆ†å³å¯ã€‚Server éœ€è¦ç»´æŠ¤ä¸€å¼  Mapï¼ŒKey ä¸º indexï¼ŒValue ä¸º Server ç­‰å¾…æ­¤ index å¯¹åº” command çš„ channelã€‚\ntype Result struct { value string err Err } notifyCh := map[int]chan Result åœ¨ Raft å±‚ï¼Œcommand ä¸€å®šæ˜¯æŒ‰åºå‘ applyCh ä¼ è¾“çš„ã€‚ä¸ºäº†èƒ½å¤ŸæŒ‰åºå°† command åº”ç”¨è‡³çŠ¶æ€æœºï¼ŒServer åº”èµ·ä¸€åå° goroutine ç›‘å¬ applyChï¼Œå¯¹éœ€è¦ apply çš„ command è¿›è¡Œäº’æ–¥çš„å¤„ç†ã€‚åŒæ—¶ï¼Œè¿™ä¸ª goroutine ä¹Ÿè´Ÿè´£å°† applyCh ä¼ æ¥çš„ä¿¡æ¯è½¬å‘ç»™å¯¹åº”çš„æ­£åœ¨é˜»å¡ç­‰å¾…çš„ RPC Handlerï¼š\nfunc (kv *KVServer) notifier() { for !kv.killed() { select { case msg := \u003c-kv.applyCh: op := msg.Command.(Op) result := kv.apply(op)\t// apply to state machine index := msg.CommandIndex ch := kv.getNotifyCh(index)\tch \u003c- result\t// notify the blocked server } } } func (kv *KVServer) getNotifyCh(index int) chan Result { kv.mu.Lock() defer kv.mu.Unlock() if _, ok := kv.notifyCh[index]; !ok { kv.notifyCh[index] = make(chan Result) } return kv.notifyCh[index] } Server é˜»å¡çš„ä»£ç æ”¹å†™å¦‚ä¸‹ï¼š\nindex, _, isLeader := kv.rf.Start(op) if !isLeader { reply.Err = ErrWrongLeader return } ch := kv.getNotifyCh(index) select { case result := \u003c-ch: // agreed! reply to client reply.Value, reply.Err = result.value, result.err case \u003c-time.After(AGREE_TIMEOUT): // too slow response, reply to client and let it retry another server reply.Value, reply.Err = \"\", ErrTimeout } go func() { // asynchronously release notifying channel kv.delNotifyCh(index) }() éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ Raft å±‚é•¿æ—¶é—´æ— æ³•å®Œæˆå…±è¯† (ç”±äºç½‘ç»œåˆ†åŒºç­‰åŸå› )ï¼Œä¸è¦è®© Server ä¸€ç›´é˜»å¡ã€‚åŠæ—¶å‘ Client è¿”å› Timeout é”™è¯¯ï¼Œä½¿å…¶é‡æ–°é€‰æ‹©å¦ä¸€å° Server é‡è¯•ã€‚\nè¿™æ ·ä¸€æ¥ï¼Œå¤šä¸ª Client å¹¶è¡Œå‘é€è¯·æ±‚çš„æƒ…å†µä¼¼ä¹ä¹Ÿå¯ä»¥åº”å¯¹äº†ã€‚\nç„¶è€Œæˆ‘ä»¬è¦å®ç°çš„ç³»ç»Ÿæœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œfault-tolerantã€‚ç›®å‰ä¸ºæ­¢ï¼Œfault è¿˜æ²¡æœ‰å‡ºç°ã€‚\nå®é™…ä¸Šï¼ŒRaft å±‚çš„å„ç§ fault æˆ‘ä»¬åœ¨ lab2 ä¸­å·²ç»å¦¥å–„å¤„ç†äº†ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯ Server å±‚çš„ faultã€‚é¦–å…ˆä¸è€ƒè™‘ Server ç›´æ¥æŒ‚æ‰çš„æƒ…å†µ (éœ€è¦åœ¨ lab3B ä¸­ç”¨ snapshot è§£å†³)ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯ Client å’Œ Server ä¹‹é—´çš„ RPC ä¸¢å¤±é—®é¢˜äº†ã€‚\nå‡å¦‚ Client å‘ Server å‘é€è¯·æ±‚ï¼Œå› ç½‘ç»œé—®é¢˜ Server æ— æ³•æ¥æ”¶ï¼Œè¿™ç§æƒ…å†µ Server æ— éœ€åº”å¯¹ (ä¹Ÿæ— åŠ›åº”å¯¹)ï¼Œè®© Client è‡ªå·±æ…¢æ…¢é‡è¯•å°±å¥½ã€‚æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜æ˜¯ï¼ŒClient å‘é€çš„è¯·æ±‚ Server æˆåŠŸæ¥æ”¶ï¼ŒServer ä¹Ÿå°†è¯·æ±‚ä¸­çš„ command æˆåŠŸåœ¨ Raft å±‚è¾¾æˆå…±è¯†å¹¶åº”ç”¨è‡³çŠ¶æ€æœºï¼Œç„¶è€Œåœ¨å›å¤ Client æ—¶å‡ºç°äº†é—®é¢˜ï¼ŒRPC å›å¤ä¸¢å¤±ã€‚è¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´ä¸€æ¬¡è¯·æ±‚å¤šæ¬¡é‡å¤æäº¤çš„æƒ…å†µã€‚æ¯”å¦‚ä¸‹é¢ä¸€ç§ç®€å•çš„æƒ…å†µï¼š\nClient å‘ Server å‘é€ Append(x, 1) çš„è¯·æ±‚ Server æˆåŠŸæ¥æ”¶ï¼ŒRaft å±‚è¾¾æˆå…±è¯†ï¼Œåº”ç”¨è‡³çŠ¶æ€æœºã€‚æ­¤æ—¶çŠ¶æ€æœºçŠ¶æ€ {x: 1} ç”±äºç½‘ç»œåŸå› ï¼ŒServer å‘ Client è¿”å›çš„ç»“æœä¸¢å¤± Client è‹¦è‹¦ç­‰å¾…ï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ° Server è¿”å›çš„ç»“æœï¼Œäºæ˜¯è¶…æ—¶é‡è¯•ã€‚ç»•äº†ä¸€åœˆååˆå›åˆ°äº†è¿™ä¸ª Server (æ­¤ Server ä»ä¸º Leader) Client åˆå‘ Server å‘é€ Append(x, 1) çš„è¯·æ±‚ï¼ŒServer æˆåŠŸæ¥æ”¶ï¼ŒRaft å±‚è¾¾æˆå…±è¯†ï¼Œåº”ç”¨è‡³çŠ¶æ€æœºã€‚æ­¤æ—¶çŠ¶æ€æœºçŠ¶æ€ {x: 11} è¿™æ¬¡ Server æˆåŠŸå‘ Client è¿”å›äº†ç»“æœã€‚ Client æˆåŠŸæ”¶åˆ°äº†è¿”å›çš„ç»“æœï¼Œç»“æŸè¯·æ±‚ã€‚ç„¶è€ŒåŸæœ¬çš„ Append(x, 1) è¯·æ±‚ï¼Œé€ æˆäº† Append(x, 11) çš„åæœã€‚ å‡ºç°è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› æ˜¯ï¼ŒRaft å±‚å…è®¸åŒæ ·çš„ command commit å¤šæ¬¡ (Raft å±‚å¹¶ä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯ç›¸åŒçš„ commandï¼Œåªè¦æœ‰ command æ¥ï¼Œå°±å°è¯•å…±è¯†)ï¼Œä½†å®é™…ä¸Šï¼ŒåŒæ ·çš„ command åªèƒ½ apply ä¸€æ¬¡ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨ Server å±‚å¯¹è¯·æ±‚è¿›è¡Œå»é‡ã€‚\nä¸Šé¢åªä»‹ç»äº† Append è¯·æ±‚çš„æƒ…å†µï¼ŒPut è¯·æ±‚ä¹Ÿç±»ä¼¼ã€‚è™½ç„¶åœ¨åªæœ‰ä¸€ä¸ª Client æ—¶ï¼ŒPut è¯·æ±‚å¤šæ¬¡æ‰§è¡Œä¸ä¼šæ”¹å˜ç»“æœï¼Œä½†å¦‚æœæœ‰å¤šä¸ª Clientï¼Œé‡å¤çš„ Put è¯·æ±‚ä¹Ÿå¯èƒ½é€ æˆäº’ç›¸è¦†ç›–çš„åæœã€‚å› æ­¤ä¹Ÿéœ€è¦è¿›è¡Œå»é‡ã€‚\nè‡³äº Get è¯·æ±‚ï¼Œå¤šæ¬¡é‡å¤å¹¶ä¸ä¼šæ”¹å˜çŠ¶æ€æœºçš„çŠ¶æ€ï¼Œæ— éœ€è¿›è¡Œå»é‡å¤„ç†ã€‚\nè¯´åˆ° Get è¯·æ±‚ï¼Œåœ¨è¿™é‡Œå°å°åœ°åä¸€ä¸‹é¢˜ï¼š\næŒ‰æˆ‘ä»¬ç›®å‰çš„å®ç°ï¼ŒGet/Put/Append è¯·æ±‚å‡éœ€å…ˆæ¨è‡³ Raft å±‚è¾¾æˆå…±è¯†ï¼Œè®°å½•åœ¨ Raft å±‚çš„ Log ä¸­ã€‚ç„¶è€Œ Get è¯·æ±‚å¹¶ä¸ä¼šæ”¹å˜ç³»ç»Ÿçš„çŠ¶æ€ï¼Œè®°å½•åœ¨ Log ä¸­ï¼Œå¯¹å´©æºƒåå›æ”¾ Log æ¢å¤æ•°æ®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚é‚£ä¹ˆå®é™…ä¸Šæ˜¯ä¸æ˜¯ä¸éœ€è¦å°† Get è¯·æ±‚ä¼ å…¥ Raft å±‚è¿›è¡Œå…±è¯†å‘¢ï¼Ÿæ˜¯çš„ã€‚å¹¶ä¸”è¿™æ ·ä¼šä½¿ç³»ç»Ÿæ•ˆç‡æ›´é«˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å°† Get è¯·æ±‚ä¹Ÿä¼ å…¥ Raft å±‚å‘¢ï¼Ÿè¿™ä¹ˆåšå®é™…ä¸Šæ˜¯ä¸ºäº†ç®€åŒ– KV Service çš„å®ç°éš¾åº¦ã€‚KV Service è¦æ±‚æˆ‘ä»¬æ°¸è¿œä¸åœ¨ minority ä¸­è¯»å–æ•°æ®ï¼Œå› ä¸ºè¿™æ ·å¯èƒ½ä¼šç ´åçº¿æ€§ä¸€è‡´æ€§ã€‚å‡å¦‚æˆ‘ä»¬ä¸å°† Get ä¼ å…¥ Raft å±‚ï¼Œç›´æ¥è¯»å– Leader Server çŠ¶æ€æœºä¸­çš„æ•°æ®ï¼Œè¯•æƒ³ä¸‹é¢è¿™ç§æƒ…å†µï¼š\nä¸€å…±æœ‰ 5 å° Serverã€‚ä¸€å¼€å§‹ï¼ŒServer1 ä¸º Leaderï¼ŒClient å‘é€äº†ä¸€äº›è¯·æ±‚ï¼ŒRaft æˆåŠŸå…±è¯†ã€‚ æ­¤åï¼ŒServer1ã€Server2 ä¸ Server3ã€Server4ã€Server5 ç”±äºç½‘ç»œé—®é¢˜è¢«åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ã€‚ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼ŒServer1 ä»è®¤ä¸ºè‡ªå·±æ˜¯ Leaderã€‚ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼ŒServer3 æˆåŠŸå½“é€‰ Leaderã€‚ Server3 åˆæ¥æ”¶äº†ä¸€äº›æ¥è‡ª Client çš„è¯·æ±‚ï¼Œä¸”åœ¨ Server3ã€Server4ã€Server5 é—´è¾¾æˆäº†å…±è¯†ã€‚ æœ‰ä¸¤ä¸ª Client å¸Œæœ› Get åŒä¸€ä¸ª keyï¼š Client1 é¦–å…ˆè”ç³»äº† Server1ï¼ŒServer1 è®¤ä¸ºå®ƒè‡ªå·±æ˜¯ Leader (å®é™…å·²ç» outdated)ï¼Œä¾¿å‘ Client1 è¿”å›äº† outdated valueã€‚ Client2 é¦–å…ˆè”ç³» Server3ï¼ŒServer3 å‘å…¶è¿”å›äº† updated valueã€‚ è¿™ä¸¤ä¸ª Get æ“ä½œé—´å¹¶æ²¡æœ‰å†™æ“ä½œï¼Œå´è¯»åˆ°äº†ä¸åŒçš„æ•°æ®ï¼Œè¿èƒŒäº†çº¿æ€§ä¸€è‡´æ€§ã€‚ ä¸ºä»€ä¹ˆå°† Get ä¼ å…¥ Raft è¿›è¡Œå…±è¯†å°±å¯ä»¥é¿å…è¿™ç§é”™è¯¯ï¼Ÿä¾ç„¶è€ƒè™‘ä¸Šè¿°æƒ…å†µï¼šServer1 åœ¨æ¥æ”¶åˆ° Client1 çš„ Get è¯·æ±‚åï¼Œå°†å…¶ä¼ å…¥ Raft å±‚è¯•å›¾è¾¾æˆå…±è¯†ã€‚ç„¶è€Œ Server1 åªèƒ½è·å¾— Server2 çš„å“åº”ï¼Œæ— æ³•å°† Get è¯·æ±‚åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥è¿Ÿè¿Ÿæ— æ³•è¾¾æˆå…±è¯†ï¼ŒServer å±‚ä¹Ÿä¼šè¢«é•¿æœŸé˜»å¡ã€‚Client1 ä¹…ä¹…ç­‰ä¸åˆ°ç­”å¤ï¼Œä¾¿ä¼šæ›´æ¢ Server é‡æ–°è¿›è¡Œè¯·æ±‚ï¼Œæ­¤æ—¶å°±ä¼šæ‰¾åˆ°æ–°çš„ Leader Server3 å¹¶æˆåŠŸæ‰§è¡Œ Get è¯·æ±‚ã€‚æ‰€ä»¥ï¼Œå°† Get è¯·æ±‚ä¸€åŒä¼ å…¥ Raft å±‚æ˜¯æœ€ç®€å•åœ°é¿å…è¯»å–åˆ° minority æ•°æ®çš„æ–¹æ³•ã€‚\nRaft è®ºæ–‡åœ¨ session 8 ä¸­æåˆ°äº† read-only operations ç­‰ä¼˜åŒ–ï¼Œé¿å…å°† Get å†™å…¥ Logï¼ŒåŒæ—¶è§£å†³äº†å¯èƒ½è·å– outdated æ•°æ®çš„é—®é¢˜ã€‚å¯ä»¥è‡ªè¡Œå‚è€ƒã€‚\nå»é‡å…·ä½“çš„æ‰§è¡Œæ–¹å¼ï¼Œå°±å’Œä¹‹å‰åœ¨ Client ä¸­è¿˜æ²¡æœ‰è®²åˆ°çš„ idã€seq ç­‰å˜é‡æœ‰å…³äº†ã€‚\nid æ˜¯ Client çš„ uuidï¼Œç”¨äºæ ‡è¯†ä¸åŒçš„ Clientï¼Œç›´æ¥ç”¨ skeleton code ä¸­çš„ nrand() æ–¹æ³•ç”Ÿæˆå³å¯ (æµ‹è¯•æ—¶å¼€ä¸äº†é‚£ä¹ˆå¤š Clientï¼Œç¢°æ’æ¦‚ç‡æä½ï¼Œå¯ä»¥å‡‘åˆå½“uuidç”¨)ã€‚seq åˆ™æ˜¯ Client å†™æ“ä½œçš„æœ€å¤§æ“ä½œæ•°ï¼Œä» 1 å¼€å§‹é€’å¢ã€‚æ¯å½“ Client å®Œæˆä¸€æ¬¡å†™æ“ä½œï¼Œå°±å°† seq åŠ  1ã€‚\nServer ç«¯åˆ™ç»´æŠ¤ä¸€å¼  mapï¼Œç”¨äºè®°å½•ä¸åŒ Client æˆåŠŸåº”ç”¨è‡³çŠ¶æ€æœºçš„æœ€å¤§ seq æ•°ï¼š\nmaxSeq := map[int64]int64 åœ¨é‡åˆ°æ¥è‡ª client x çš„ y seq è¯·æ±‚æ—¶ï¼Œå¦‚æœ\nmaxSeq[x] \u003e= y å°±è¡¨æ˜è¿™æ˜¯ä¸€æ¬¡é‡å¤çš„è¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œæ‹¦æˆªã€‚\næ­¤æ—¶åˆæœ‰æ–°çš„é—®é¢˜å‡ºç°äº†ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨å“ªé‡Œæ‹¦æˆªé‡å¤çš„è¯·æ±‚ï¼Œåœ¨å“ªé‡Œæ›´æ–° maxSeqï¼Ÿ\næˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯ï¼Œç›´æ¥åœ¨ RPC handler çš„æœ€å¼€å§‹åˆ¤æ–­è¯·æ±‚æ˜¯å¦é‡å¤ï¼Œè‹¥æ˜¯é‡å¤è¯·æ±‚åˆ™ç›´æ¥æ‹¦æˆªå¹¶è¿”å›ã€‚å¹¶åœ¨ RPC handler è¿”å›å‰æ›´æ–° maxSeqã€‚ç„¶è€Œè¿™ç§å¤„ç†æ–¹æ³•å­˜åœ¨é—®é¢˜ã€‚è¯•æƒ³å¦‚ä¸‹æƒ…å†µï¼š\nClient é¦–å…ˆå‘ Leader Server1 å‘èµ· Append è¯·æ±‚ã€‚Server1 æˆåŠŸå®Œæˆå…±è¯†å¹¶å°†è¯·æ±‚åº”ç”¨è‡³çŠ¶æ€æœºï¼Œä¹Ÿæ›´æ–°äº† maxSeqã€‚ä½†åœ¨è¿”å›æ—¶ RPC ç»“æœä¸¢å¤±ã€‚ æ­¤æ—¶ï¼Œæ°å¥½ Server1 ç”±äºå´©æºƒæˆ–ç½‘ç»œéš”ç¦»ç­‰åŸå› ï¼Œå¤±å» Leader èº«ä»½ï¼ŒServer2 å½“é€‰ Leaderã€‚ ç”±äº RPC ç»“æœä¸¢å¤±ï¼ŒClient é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ï¼Œä¾¿å°è¯•æ›´æ¢ Server é‡æ–°å‘èµ·è¯·æ±‚ã€‚ Client å‘ Server2 å‘èµ·äº†åŒæ ·çš„ Append è¯·æ±‚ã€‚ç”±äº Server2 çš„ maxSeq ä¸­å¹¶æ²¡æœ‰æ­¤ Client æ­¤ Seq çš„ä¿¡æ¯ (ä¸Šæ¬¡ä»…æ˜¯å­˜å‚¨åœ¨äº† Server1 çš„ maxSeq)ï¼Œäºæ˜¯ Server2 å†æ¬¡æ‰§è¡Œäº†è¯·æ±‚ã€‚ä¹Ÿå¯¼è‡´äº†ä¸€æ¬¡è¯·æ±‚å¤šæ¬¡åº”ç”¨çš„åæœã€‚ å‡ºç°è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› æ˜¯ Server å¹¶ä¸ä¼šç›´æ¥è”ç³»ï¼Œä¸åŒ Server çš„ maxSeq æ— æ³•å…±äº«ï¼Œå› æ­¤åœ¨ Client åˆ‡æ¢ Server æäº¤é‡å¤è¯·æ±‚æ—¶ï¼ŒServer æ— æ³•å¯Ÿè§‰ã€‚\nè§£å†³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼šåœ¨ command è¾¾æˆå…±è¯†åï¼Œå°† command åº”ç”¨è‡³çŠ¶æ€æœºå‰ï¼Œå¯¹ command è¿›è¡Œå»é‡ã€‚å¹¶åœ¨æˆåŠŸåº”ç”¨ command åï¼Œæ›´æ–° maxSeqã€‚å³ maxSeq å®é™…ä¸Šç”±çŠ¶æ€æœºç»´æŠ¤ã€‚è¿™æ ·åšèƒ½æˆåŠŸçš„åŸå› æ˜¯ï¼Œä¸åŒçš„ Server é€šè¿‡ Raft å±‚çš„äº¤æµï¼Œé—´æ¥åœ°å…±äº«äº† maxSeqã€‚æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦å…ˆå°è¯•åº”ç”¨è‡³çŠ¶æ€æœºï¼Œè€ŒçŠ¶æ€æœºç»´æŠ¤çš„ maxSeq æ°å¥½å¯ä»¥æ‹¦æˆªè¯•å›¾åº”ç”¨çš„é‡å¤è¯·æ±‚ã€‚\nfunc (kv *KVServer) apply(op Op) Result { result := Result{} if op.T == \"Get\" { result.value, result.err = kv.db.get(op.Key) } else if op.T == \"Put\" { if kv.maxSeq[op.ClientId] \u003c op.Seq { kv.db.put(op.Key, op.Value) kv.maxSeq[op.ClientId] = op.Seq } result.err = OK } else { if kv.maxSeq[op.ClientId] \u003c op.Seq { kv.db.append(op.Key, op.Value) kv.maxSeq[op.ClientId] = op.Seq } result.err = OK } return result } åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹æˆ‘ä»¬çš„ KV Service å·²ç»å®Œç¾æ— ç¼ºäº†ã€‚å½“æ—¶æˆ‘å°±æ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼Œç„¶è€Œå®ƒè¿˜å­˜åœ¨ä¸¤ä¸ªé€»è¾‘ä¸Šçš„å°é—®é¢˜ TAT\næˆ‘ä»¬ç”¨æ¥è½¬å‘ applyCh ä¿¡æ¯çš„ notifier åç¨‹æ˜¯è¿™æ ·çš„ï¼š\nfunc (kv *KVServer) notifier() { for !kv.killed() { select { case msg := \u003c-kv.applyCh: op := msg.Command.(Op) result := kv.apply(op)\t// apply to state machine index := msg.CommandIndex ch := kv.getNotifyCh(index)\tch \u003c- result\t// notify the blocked server } } } éœ€è¦æ„è¯†åˆ°çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰ Server éƒ½æ˜¯ Leader èŠ‚ç‚¹ï¼ŒFollower èŠ‚ç‚¹ä¹Ÿä¼šé€šè¿‡ applyCh å‘ Server å±‚è½¬é€’éœ€è¦ apply è‡³çŠ¶æ€æœºçš„æ•°æ®ã€‚æ­¤æ—¶ Server å±‚å¹¶æ²¡æœ‰ RPC Handler åœ¨ç­‰å¾… applyCh çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬ä»å°è¯•è·å–å¯¹åº”çš„ notifyCh å¹¶è½¬å‘æ•°æ®ï¼Œåˆ™ä¼šé€ æˆ notifier çš„æ— é™é˜»å¡ã€‚æ”¹å†™å¦‚ä¸‹ï¼š\nfunc (kv *KVServer) notifier() { for !kv.killed() { select { case msg := \u003c-kv.applyCh: op := msg.Command.(Op) result := kv.apply(op)\t// apply to state machine if _, isLeader := kv.rf.GetState(); !isLeader { continue } index := msg.CommandIndex ch := kv.getNotifyCh(index)\tch \u003c- result\t// notify the blocked server } } } Server ä¸ä¸º Leader çš„æƒ…å†µå·²ç»è§£å†³ã€‚å‡å¦‚ Server å½“å‰æ˜¯ Leaderï¼Œæœ‰æ²¡æœ‰å¯èƒ½éƒ¨åˆ† applyCh ä¼ æ¥çš„æ•°æ®ä¹Ÿæ— éœ€è½¬å‘å‘¢ï¼Ÿä¹Ÿæœ‰å¯èƒ½ï¼Œæœ€ç®€å•çš„æƒ…å†µå°±æ˜¯æ–°å½“é€‰çš„ Leader çš„ Log ä¸­è¿˜å­˜åœ¨å·²æäº¤æœªåº”ç”¨çš„ commandã€‚å°†è¿™ä¸ª command ä¼ å…¥ Server å±‚åï¼ŒæŒ‰ç…§ä¸Šé¢çš„å†™æ³•ï¼Œä¹Ÿä¼šå°è¯•å‘å¹¶ä¸å­˜åœ¨çš„ RPC Handler è½¬å‘æ•°æ®å¹¶é€ æˆé˜»å¡ã€‚è¿™ç§æƒ…å†µè§£å†³èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸å±äºå½“å‰ term çš„ command æ— éœ€è½¬å‘ï¼Œç›´æ¥ç»™çŠ¶æ€æœºåº”ç”¨å°±å¯ä»¥äº†ã€‚\nfunc (kv *KVServer) notifier() { for !kv.killed() { select { case msg := \u003c-kv.applyCh: op := msg.Command.(Op) result := kv.apply(op) if term, isLeader := kv.rf.GetState(); !isLeader || term != msg.CommandTerm { continue } index := msg.CommandIndex ch := kv.getNotifyCh(index) ch \u003c- result } } } åˆ°è¿™é‡Œ Lab3A çš„è¦æ±‚å·²ç»å®Œæˆäº†ã€‚\nTest \u0026 Debug ä¸Šé¢ä¸æ–­æ”¹é”™çš„ç»å†å¤§è‡´å°±æ˜¯æˆ‘åœ¨æµ‹è¯•é›†ä¸­ä¸æ–­ fail å¹¶ä¿®æ”¹çš„è¿‡ç¨‹ã€‚Lab ç»™å‡ºçš„æµ‹è¯•é›†è¿˜æ˜¯æ¯”è¾ƒè¯¦å°½çš„ï¼Œå¯ä»¥æµ‹å‡ºå„æ–¹é¢çš„ç»†èŠ‚ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæµ‹è¯•é›†æ¯”è¾ƒå¥‡æ€ªï¼š\nTest: ops complete fast enough (3A) è¿™ä¸ªæµ‹è¯•æ˜¯éœ€è¦ command è¾¾æˆå…±è¯†å¹¶åº”ç”¨è‡³çŠ¶æ€æœºçš„é€Ÿåº¦è¶³å¤Ÿå¿«ï¼Œæ¯æ¬¡å¿ƒè·³é—´éš” (100ms) ä¸­è‡³å°‘éœ€è¦å®Œæˆ 3 æ¬¡å…±è¯†ã€‚åœ¨ Lab2 ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨æ¯æ¬¡ Start(command) æ—¶éƒ½æèµ·ä¸€æ¬¡å¤åˆ¶è¯·æ±‚ï¼Œç”¨ä¸åŒçš„ replicator å‘å„ä¸ªèŠ‚ç‚¹å¹¶è¡Œåœ°ä¸æ–­å°è¯•å¤åˆ¶ Logï¼Œè€Œä¸æ˜¯å®Œå…¨é å¿ƒè·³è¿›è¡Œå¤åˆ¶ (åŸºæœ¬æ¯æ¬¡å¿ƒè·³é—´éš”åªèƒ½å®Œæˆä¸€æ¬¡å…±è¯†)ã€‚æŒ‰ç†æ¥è¯´åº”è¯¥èƒ½å¤Ÿè½»æ¾é€šè¿‡ï¼Œç„¶è€Œæµ‹è¯•ç»“æœæ€»æ˜¯è¶…æ—¶ã€‚\næˆ‘è¯•äº†è¯•ä¸å¸¦ -race æ ‡è¯†çš„æµ‹è¯•ï¼Œç»“æœå¾ˆæ„å¤–ï¼Œä»…ä»… 3s å·¦å³å°±é€šè¿‡äº†æµ‹è¯•ï¼Œè€Œå¸¦ä¸Š -race æ ‡è¯†è¶³è¶³éœ€è¦ 40s å·¦å³ã€‚åˆ°è¿™é‡Œå…¶å®å·²ç»åŸºæœ¬å¯ä»¥çŒœåˆ°æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼šé”çš„ç«äº‰è¿‡äºæ¿€çƒˆï¼Œ-race æ ‡è¯†ä¼šè¿›è¡Œ Data race çš„æ£€æµ‹ï¼Œ ä¸¥é‡åœ°å½±å“äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚\næˆ‘åˆåœ¨ test ä¸­åŠ å…¥äº†å¯¹ goroutine æ•°é‡çš„ç›‘æ§ï¼Œå‘ç° goroutine æ•°é‡ä¸æ–­å¢é•¿ï¼Œé«˜çš„æ—¶å€™å¯ä»¥è¾¾åˆ° 300+ goroutineã€‚è™½è¯´ goroutine å·ç§°æ˜¯è½»æ¾å¼€å¯ä¸Šä¸‡ä¸ªï¼Œä½†è¿™ä¹ˆé«˜çš„ goroutine æ•°é‡æ˜¾ç„¶è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ã€‚\nä¹‹åç»è¿‡æ’æŸ¥ï¼Œå‘ç°å¤§é‡çš„ goroutine å¡åœ¨äº† Lab2 Raft å±‚å‘ applier å‘é€ apply è¯·æ±‚çš„ goroutine ä¸Šï¼š\ngo func() { rf.applyCh \u003c- msg }() è¿™æ ·å°±æ¯”è¾ƒå¥½è§£é‡Šäº†ï¼ŒClient çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡çš„è¯·æ±‚ï¼Œè€Œ applier åªæœ‰ä¸€ä¸ªï¼Œå¤§é‡å°è¯•ä¼ é€’ç»™ applyCh çš„ msg é˜»å¡ï¼Œå¯¼è‡´åç¨‹æ•°è¿‡å¤§ã€‚\nå› æ­¤éœ€è¦å°† Lab2 ä¸­è¿‡å¤šçš„é‡å¤ msg æ‹¦æˆªï¼Œåšæ³•å’Œ replicator ä¸­ç±»ä¼¼ï¼Œæˆ–è€…æ”¹ç”¨ sync.Condï¼Œç”¨ Signal ä¸é˜»å¡çš„æ€§è´¨æ¥å®ç°ã€‚\nLab3A éƒ¨åˆ†åˆ°è¿™é‡Œç»“æŸï¼Œæ¥ä¸‹æ¥è®²è®² Lab3Bã€‚\nSnapshot å‰é¢çš„å·¥ä½œåšå¥½åï¼ŒåŠ ä¸Šä¸€ä¸ª Snapshot å…¶å®æ¯”è¾ƒç®€å•ï¼Œåœ¨ notifier ä¸­æ ¹æ® RaftStateSize() å’Œ MaxStateSize çš„å¤§å°å…³ç³»åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦éœ€è¦è¿›è¡Œä¸€æ¬¡ Snapshotï¼Œå¹¶ä¸”å¢åŠ ä¸€ä¸ª commandValid == false çš„åˆ†æ”¯å°† Raft å±‚ä¼ é€’çš„ Snapshot åº”ç”¨è‡³çŠ¶æ€æœºå°±å¯ä»¥äº†ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSnapshot ä¸ä»…éœ€è¦ä¿å­˜ kv database çš„ä¿¡æ¯ï¼Œè¿˜éœ€è¦ä¿å­˜ maxSeqã€‚å› ä¸ºæ”¹å˜äº†çŠ¶æ€æœºçš„çŠ¶æ€ï¼Œå°±éœ€è¦çŠ¶æ€æœºç›¸å…³çš„ maxSeq ä¿¡æ¯æ¥æ‹¦æˆªé‡å¤è¯·æ±‚ã€‚åœ¨åº”ç”¨ Snapshot æ—¶ï¼ŒçŠ¶æ€æœºçŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å°† maxSeq ä¸ Leader çš„ maxSeq è¿›è¡ŒåŒæ­¥ã€‚\nSummary Lab3 æ•´ä½“åä¸‹æ¥éš¾åº¦æ¯” Lab2 å°ä¸€äº›ï¼Œdebug ä¹Ÿå¾ˆæŠ˜ç£¨äººå°±æ˜¯äº†ã€‚å…¶é—´ä¹Ÿé‡åˆ°äº†ä¸å°‘æ¦‚ç‡æä½ä½†åŒªå¤·æ‰€æ€çš„å°é—®é¢˜ï¼Œæˆ–è®¸ Raft å±‚è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Ÿä¸è¿‡ä¹Ÿä¸æƒ³å†å»å¤„ç†äº†ï¼Œæ„Ÿè§‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ debug æ›´åƒæ˜¯ä¸€ç§ä½“åŠ›æ´»ã€‚\n",
  "wordCount" : "1506",
  "inLanguage": "en",
  "image":"http://localhost:1313/%3Cimage%20path/url%3E","datePublished": "2022-09-22T18:16:09+08:00",
  "dateModified": "2022-09-22T18:16:09+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/mit6.824-lab3-kvservice/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">Home</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="â±archives">
                    <span>â±archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ”Search">
                    <span>ğŸ”Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ”–Tags">
                    <span>ğŸ”–Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title">
      MIT6.824 Lab3 KVService
    </h1>
    <div class="post-description">
      Fault-tolerant KV Service based on Raft
    </div>
    <div class="post-meta">&lt;span title=&#39;2022-09-22 18:16:09 &#43;0800 CST&#39;&gt;2022-09-22&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;8 min&amp;nbsp;Â·&amp;nbsp;1506 words&amp;nbsp;Â·&amp;nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/Dueplay/blog/content/posts/MIT6.824-Lab3-KVService.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#implement">Implement</a>
      <ul>
        <li><a href="#kv-database">KV Database</a></li>
        <li><a href="#client">Client</a></li>
        <li><a href="#server">Server</a></li>
      </ul>
    </li>
    <li><a href="#test--debug">Test &amp; Debug</a></li>
    <li><a href="#snapshot">Snapshot</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>æ‘¸äº†ä¸€æ®µæ—¶é—´çš„é±¼ï¼Œå»å°è¯•ç”¨ SpringBoot + Vue æ­å»ºä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„ Web åº”ç”¨ã€‚éƒ½è¯´ CS çš„å­¦ç”Ÿä¸èƒ½åªä¼šç”¨æ¡†æ¶ CRUDï¼Œä½†æ›´ä¸èƒ½ä¸ä¼šç”¨æ¡†æ¶ CRUDã€‚å¤§æ¦‚åšå‡ºæ¥ä¸€ä¸ªå° demo åå°±æ²¡æœ‰å†ç»§ç»­äº†ã€‚æ¥ç€æ¥åš 6.824ã€‚</p>
<p>Lab3 å’Œ Lab2 å„æœ‰å„çš„éš¾å¤„ã€‚Lab2 æ˜¯ Raft çš„æ ¸å¿ƒï¼Œéœ€è¦å°å¿ƒåœ°å¤„ç†å„ç§ corner caseã€‚ä½†å¥½åœ¨æœ‰ Figure2 çš„å¼•å¯¼ï¼Œæœ€ç»ˆä¹Ÿæ˜¯æŒ‰ç…§å…¶ä¸¥æ ¼çš„è§„å®šæˆåŠŸå®ç°ã€‚Lab3 ç¼–ç éš¾åº¦ä¸å¦‚ Lab2ï¼Œä½†æ²¡æœ‰è¯¦ç»†çš„å¼•å¯¼ï¼Œç•™ç»™ä¸ªäººè‡ªç”±å‘æŒ¥çš„ç©ºé—´æ›´å¤§ (æ›´æœ‰å¯èƒ½ä¸çŸ¥é“ä»ä½•ä¸‹æ‰‹)ã€‚</p>
<p>Lab3 éœ€è¦åœ¨ Raft å±‚ä¸Šå®ç°ä¸€ä¸ª fault-tolerant key-value serviceï¼Œæ»¡è¶³å¼ºä¸€è‡´æ€§ï¼Œä¹Ÿå°±æ˜¯çº¿æ€§ä¸€è‡´æ€§ (Linearizable Consistency)ã€‚çº¿æ€§ä¸€è‡´æ€§ä¿è¯æ•´ä¸ªç³»ç»Ÿçœ‹èµ·æ¥å¥½åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„ã€‚ç®€å•åœ°è¯´ï¼Œçº¿æ€§ä¸€è‡´æ€§ç³»ç»Ÿçš„è¯»å†™æ“ä½œæœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<ul>
<li>è¯»å†™å¹¶ä¸èƒ½ç¬é—´å®Œæˆï¼Œè€Œæ˜¯åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…è¿›è¡Œã€‚</li>
<li>è¯»åœ¨å†™å¼€å§‹å‰å®Œæˆï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯æ—§å€¼ï¼›è¯»åœ¨å†™å®Œæˆä¹‹åå¼€å§‹ï¼Œè¯»åˆ°çš„ä¸€å®šæ˜¯æ–°å€¼ã€‚(è¯»å†™æ“ä½œæ— é‡åˆéƒ¨åˆ†)</li>
<li>è¯»å†™å¹¶å‘è¿›è¡Œï¼Œå³æœ‰é‡åˆéƒ¨åˆ†æ—¶ï¼Œæ—¢å¯èƒ½è¯»åˆ°æ–°å€¼ï¼Œä¹Ÿå¯èƒ½è¯»åˆ°æ—§å€¼ã€‚</li>
<li>ä¸€æ—¦æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯»å–åˆ°äº†æ–°å€¼ï¼Œé‚£ä¹ˆä¹‹åçš„å®¢æˆ·ç«¯ä¸€å®šä¹Ÿéƒ½ä¼šè¯»å–åˆ°æ–°å€¼ã€‚</li>
</ul>
<p>å…³äºçº¿æ€§ä¸€è‡´æ€§æ›´åŠ è¯¦ç»†çš„å®šä¹‰å’Œè§£æï¼Œå¯ä»¥é˜…è¯»ã€Šæ•°æ®å¯†é›†å‹åº”ç”¨ç³»ç»Ÿã€‹(DDIA) ç›¸å…³ç« èŠ‚ã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„ï¼š</p>
<p><img loading="lazy" src="../../imgs/lab3A1.png" alt=""  />
</p>
<p>æ•´ä¸ª KV Service ç”±å¤šä¸ª Server ç»„æˆï¼Œæ¯ä¸ª Server åŒ…å«ä¸€ä¸ª State Machineï¼Œå…·ä½“åœ¨ lab ä¸­æ˜¯ä¸€ä¸ª KV æ•°æ®åº“ï¼›Server è¿˜åŒ…å«ä¸€ä¸ª Raft èŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå„ Server ä¹‹é—´å¹¶ä¸ä¼šç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é å…¶ Raft èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚</p>
<p>æ•´ä¸ªç³»ç»Ÿçš„ç†æƒ³è¿è¡Œæµç¨‹æ˜¯ï¼š</p>
<ul>
<li>Client é€šè¿‡ RPC å‘ KV Service å‘é€è¯·æ±‚ï¼Œä¾‹å¦‚ Put(x,1)</li>
<li>KV Service å°†è¯·æ±‚è½¬å‘ç»™å½“å‰æ‹¥æœ‰ Leader Raft èŠ‚ç‚¹çš„ Server</li>
<li>Leader Server å°†è¯·æ±‚åŒ…å«çš„ command ä¼ é€’ç»™ Raft å±‚</li>
<li>Raft å±‚å¯¹ command è¿›è¡Œå…±è¯†ï¼Œç”Ÿæˆç›¸åŒçš„ log replica</li>
<li>åœ¨è¾¾æˆå…±è¯†åï¼ŒRaft å±‚å°† command Apply å› Server</li>
<li>Server æ”¶åˆ° Raft å±‚çš„ Apply åï¼Œå°† command åº”ç”¨åˆ°çŠ¶æ€æœºï¼Œå³çŠ¶æ€æœºæ­¤æ—¶çŠ¶æ€ä¸º {x: 1}</li>
<li>æˆåŠŸåº”ç”¨è‡³çŠ¶æ€æœºåï¼ŒServer å¯¹ Client çš„ RPC è¿›è¡Œå›å¤ï¼Œè¿”å›ç»“æœå’Œé”™è¯¯ç ã€‚</li>
</ul>
<p>å½“ç³»ç»Ÿèƒ½å¤Ÿæ­£å¸¸è¿è¡Œæ—¶ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆæ¸…æ™°ç¾å¥½ã€‚ä½†æ˜¯ä¸€æ—¦å‡ºç°é—®é¢˜ï¼Œå¦‚èŠ‚ç‚¹æŒ‚æ‰ã€RPCä¸¢åŒ…ã€ç½‘ç»œåˆ†åŒºç­‰ç­‰ï¼Œæƒ…å†µå°±å˜å¾—æ¯”è¾ƒå¤æ‚äº†ã€‚</p>
<h2 id="implement">Implement<a hidden class="anchor" aria-hidden="true" href="#implement">#</a></h2>
<p>åœ¨ Lab3 ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦éœ€è¦å®ç°çš„éƒ¨åˆ†æ˜¯ Client ã€ Server å’Œ Server KV Databaseã€‚</p>
<h3 id="kv-database">KV Database<a hidden class="anchor" aria-hidden="true" href="#kv-database">#</a></h3>
<p>åœ¨ lab ä¸­ï¼ŒKV æ•°æ®åº“å¹¶ä¸æ˜¯ä¸»è¦å†…å®¹ã€‚å› æ­¤ç›´æ¥ç”¨ Hashmap æ¨¡æ‹Ÿå³å¯ã€‚é”®å€¼å‡ä¸º Stringã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">kvdb</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span>  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">kvdb</span><span class="p">)</span> <span class="nf">put</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">value</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">kvdb</span><span class="p">)</span> <span class="nb">append</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">db</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">value</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">kvdb</span><span class="p">)</span> <span class="nf">get</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">Err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">ErrNoKey</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">OK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘æ²¡æœ‰åœ¨ KV db ä¸­ä½¿ç”¨å•ç‹¬çš„é”ã€‚å› ä¸ºè¿™äº›æ“ä½œåœ¨åç»­ä»£ç ä¸­éƒ½æ˜¯äº’æ–¥è¿›è¡Œçš„ï¼Œæ— éœ€é¢å¤–åŠ é”ã€‚</p>
<h3 id="client">Client<a hidden class="anchor" aria-hidden="true" href="#client">#</a></h3>
<p>Client ä¹Ÿç›¸å¯¹ç®€å•ã€‚Client å¯å‘ Server å‘é€ä¸‰ç§ä¸åŒçš„ RPCï¼š<code>Put(key,value)</code>ï¼Œ <code>Append(key,arg)</code>å’Œ <code>Get(key)</code>ã€‚Put å’Œ Append å‡ä¸ºå†™è¯·æ±‚ï¼ŒGet ä¸ºè¯»è¯·æ±‚ã€‚</p>
<p>ä¸€å¼€å§‹ï¼ŒClient å¹¶ä¸çŸ¥é“ Leader Server æ˜¯å“ªå° Serverã€‚Client å¯å‘éšæœºä¸€å° Server å‘é€ RPC è¯·æ±‚ã€‚å‡å¦‚è¯·æ±‚çš„ Server ä¸æ˜¯å½“å‰çš„ Leader Serverï¼Œæˆ–è€…ç”±äºç½‘ç»œä¸­æ–­ã€Server Crash ç­‰åŸå› ï¼Œæ— æ³•ä¸ Server å–å¾—è”ç³»ï¼Œåˆ™æ— é™åœ°å°è¯•æ›´æ¢ Server é‡æ–°å‘é€è¯·æ±‚ï¼Œç›´åˆ°è¯·æ±‚æˆåŠŸè¢«å¤„ç†ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œåœ¨å¾—çŸ¥ Leader Server åï¼ŒClient å¯ä»¥ä¿å­˜ Leader çš„ idï¼Œé¿å…ä¸‹æ¬¡å‘èµ·è¯·æ±‚æ—¶åˆéœ€è¦éšæœºåœ°é€‰æ‹©ä¸€å° Server å¤šæ¬¡å°è¯•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Clerk</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">servers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">labrpc</span><span class="p">.</span><span class="nx">ClientEnd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">seq</span>    <span class="kt">int64</span> <span class="c1">// write op index, increasing from 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">id</span>     <span class="kt">int64</span> <span class="c1">// client uuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">leader</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ck</span> <span class="o">*</span><span class="nx">Clerk</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">GetArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Key</span><span class="p">:</span>      <span class="nx">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ClientId</span><span class="p">:</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">i</span> <span class="o">:=</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">leader</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ck</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span> <span class="o">:=</span> <span class="nx">GetReply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">servers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Call</span><span class="p">(</span><span class="s">&#34;KVServer.Get&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="nx">ErrWrongLeader</span> <span class="o">||</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="nx">ErrTimeout</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// cannot reach the server, or it&#39;s a wrong leader: retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">i</span> <span class="p">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ck</span><span class="p">.</span><span class="nx">servers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="nx">ErrNoKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Value</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">ck</span> <span class="o">*</span><span class="nx">Clerk</span><span class="p">)</span> <span class="nf">PutAppend</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">op</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="nx">PutAppendArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Key</span><span class="p">:</span>      <span class="nx">key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Value</span><span class="p">:</span>    <span class="nx">value</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Op</span><span class="p">:</span>       <span class="nx">op</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Seq</span><span class="p">:</span>      <span class="nx">ck</span><span class="p">.</span><span class="nx">seq</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ClientId</span><span class="p">:</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">i</span> <span class="o">:=</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">leader</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ck</span><span class="p">.</span><span class="nx">seq</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ck</span><span class="p">.</span><span class="nx">leader</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reply</span> <span class="o">:=</span> <span class="nx">PutAppendReply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ck</span><span class="p">.</span><span class="nx">servers</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nf">Call</span><span class="p">(</span><span class="s">&#34;KVServer.PutAppend&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="nx">ErrWrongLeader</span> <span class="o">||</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="nx">ErrTimeout</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// cannot reach the server, or it&#39;s a wrong leader: retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">i</span> <span class="p">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ck</span><span class="p">.</span><span class="nx">servers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// successfully PutAppend
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>å…³äº Client è¿˜éœ€è¦ç»´æŠ¤çš„å¦ä¸€äº›çŠ¶æ€ï¼Œå¦‚ id å’Œ seqï¼Œå¾…ä¼šå„¿å†è®¨è®ºã€‚</p>
<h3 id="server">Server<a hidden class="anchor" aria-hidden="true" href="#server">#</a></h3>
<p>Server åº”è¯¥æ˜¯ Lab3 ä¸­æœ€ä¸ºå¤æ‚çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬å…ˆè®¨è®ºä¸€åˆ‡æ­£å¸¸çš„æƒ…å†µä¸‹ Server çš„è®¾è®¡ã€‚</p>
<p>è¯»å†™ RPC Handler åœ¨æ¥æ”¶åˆ° Client çš„è¯·æ±‚åï¼Œé€šè¿‡è°ƒç”¨ <code>raft.Start()</code> å°†è¯·æ±‚åŒ…å«çš„ command ä¼ é€’åˆ° Raft å±‚ï¼Œè¾¾æˆå…±è¯†ã€‚å½“ç„¶ï¼Œå¦‚æœå½“å‰ Server ä¸ä¸º Leaderï¼Œåˆ™å‘ Client è¿”å› ErrWrongLeader é”™è¯¯ï¼ŒClient åœ¨æ”¶åˆ°å›å¤åé‡æ–°å°è¯•å‘å¦ä¸€å° Server å‘èµ·è¯·æ±‚ã€‚Raft å±‚è¾¾æˆå…±è¯†åï¼Œé€šè¿‡ applyCh é€šçŸ¥ Server è¯¥ command å·²è¾¾æˆå…±è¯†ã€‚</p>
<p>åœ¨ä¸€å¼€å§‹ï¼Œå¯èƒ½ä¼šè¿™æ ·è®¾è®¡ Serverï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isLeader</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">rf</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span> <span class="c1">// push op to raft layer to reach the agreement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">isLeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="p">=</span> <span class="nx">ErrWrongLeader</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;-</span> <span class="nx">applyCh</span>
</span></span><span class="line"><span class="cl"><span class="c1">// agreed! apply to statemachine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">kv</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>
</span></span></code></pre></div><p>å¯¹äºä¸å‡ºé”™çš„å• Clientï¼Œè¿™æ ·è®¾è®¡ä¼¼ä¹æ²¡æœ‰é—®é¢˜ã€‚ä½†å¦‚æœæœ‰å¤šä¸ª Client å¹¶è¡Œåœ°å‘ Server å‘èµ·è¯·æ±‚æ—¶ï¼Œå°±æ˜¾ç„¶ä¸èƒ½ä¿è¯ä» applyCh ä¼ å›çš„æ•°æ®æ°å¥½æ˜¯æ­¤å‰æäº¤çš„ command äº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Server ä¸­å¯¹ç‰¹å®šçš„ command è¿›è¡Œç­‰å¾…ã€‚å¦‚ä½•åŒºåˆ†ä¸åŒçš„ commandï¼Ÿç”¨ command åœ¨ raft log ä¸­çš„ index åŒºåˆ†å³å¯ã€‚Server éœ€è¦ç»´æŠ¤ä¸€å¼  Mapï¼ŒKey ä¸º indexï¼ŒValue ä¸º Server ç­‰å¾…æ­¤ index å¯¹åº” command çš„ channelã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Result</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">value</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span>   <span class="nx">Err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">notifyCh</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kd">chan</span> <span class="nx">Result</span>
</span></span></code></pre></div><p>åœ¨ Raft å±‚ï¼Œcommand ä¸€å®šæ˜¯æŒ‰åºå‘ applyCh ä¼ è¾“çš„ã€‚ä¸ºäº†èƒ½å¤ŸæŒ‰åºå°† command åº”ç”¨è‡³çŠ¶æ€æœºï¼ŒServer åº”èµ·ä¸€åå° goroutine ç›‘å¬ applyChï¼Œå¯¹éœ€è¦ apply çš„ command è¿›è¡Œäº’æ–¥çš„å¤„ç†ã€‚åŒæ—¶ï¼Œè¿™ä¸ª goroutine ä¹Ÿè´Ÿè´£å°† applyCh ä¼ æ¥çš„ä¿¡æ¯è½¬å‘ç»™å¯¹åº”çš„æ­£åœ¨é˜»å¡ç­‰å¾…çš„ RPC Handlerï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">notifier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">!</span><span class="nx">kv</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">kv</span><span class="p">.</span><span class="nx">applyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">op</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Command</span><span class="p">.(</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">result</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>	<span class="c1">// apply to state machine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">			<span class="nx">index</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">result</span>	<span class="c1">// notify the blocked server 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">chan</span> <span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">kv</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">notifyCh</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kv</span><span class="p">.</span><span class="nx">notifyCh</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">Result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">notifyCh</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Server é˜»å¡çš„ä»£ç æ”¹å†™å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">index</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isLeader</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">rf</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">isLeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="p">=</span> <span class="nx">ErrWrongLeader</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">ch</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="nx">result</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// agreed! reply to client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">reply</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="p">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">AGREE_TIMEOUT</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// too slow response, reply to client and let it retry another server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">reply</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Err</span> <span class="p">=</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">ErrTimeout</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// asynchronously release notifying channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">kv</span><span class="p">.</span><span class="nf">delNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span>
</span></span></code></pre></div><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ Raft å±‚é•¿æ—¶é—´æ— æ³•å®Œæˆå…±è¯† (ç”±äºç½‘ç»œåˆ†åŒºç­‰åŸå› )ï¼Œä¸è¦è®© Server ä¸€ç›´é˜»å¡ã€‚åŠæ—¶å‘ Client è¿”å› Timeout é”™è¯¯ï¼Œä½¿å…¶é‡æ–°é€‰æ‹©å¦ä¸€å° Server é‡è¯•ã€‚</p>
<p>è¿™æ ·ä¸€æ¥ï¼Œå¤šä¸ª Client å¹¶è¡Œå‘é€è¯·æ±‚çš„æƒ…å†µä¼¼ä¹ä¹Ÿå¯ä»¥åº”å¯¹äº†ã€‚</p>
<p>ç„¶è€Œæˆ‘ä»¬è¦å®ç°çš„ç³»ç»Ÿæœ‰ä¸€ä¸ªé‡è¦çš„æ€§è´¨ï¼Œfault-tolerantã€‚ç›®å‰ä¸ºæ­¢ï¼Œfault è¿˜æ²¡æœ‰å‡ºç°ã€‚</p>
<p>å®é™…ä¸Šï¼ŒRaft å±‚çš„å„ç§ fault æˆ‘ä»¬åœ¨ lab2 ä¸­å·²ç»å¦¥å–„å¤„ç†äº†ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦éœ€è¦å…³æ³¨çš„æ˜¯ Server å±‚çš„ faultã€‚é¦–å…ˆä¸è€ƒè™‘ Server ç›´æ¥æŒ‚æ‰çš„æƒ…å†µ (éœ€è¦åœ¨ lab3B ä¸­ç”¨ snapshot è§£å†³)ï¼Œé‚£ä¹ˆå‰©ä¸‹çš„å°±æ˜¯ Client å’Œ Server ä¹‹é—´çš„ RPC ä¸¢å¤±é—®é¢˜äº†ã€‚</p>
<p>å‡å¦‚ Client å‘ Server å‘é€è¯·æ±‚ï¼Œå› ç½‘ç»œé—®é¢˜ Server æ— æ³•æ¥æ”¶ï¼Œè¿™ç§æƒ…å†µ Server æ— éœ€åº”å¯¹ (ä¹Ÿæ— åŠ›åº”å¯¹)ï¼Œè®© Client è‡ªå·±æ…¢æ…¢é‡è¯•å°±å¥½ã€‚æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜æ˜¯ï¼ŒClient å‘é€çš„è¯·æ±‚ Server æˆåŠŸæ¥æ”¶ï¼ŒServer ä¹Ÿå°†è¯·æ±‚ä¸­çš„ command æˆåŠŸåœ¨ Raft å±‚è¾¾æˆå…±è¯†å¹¶åº”ç”¨è‡³çŠ¶æ€æœºï¼Œç„¶è€Œåœ¨å›å¤ Client æ—¶å‡ºç°äº†é—®é¢˜ï¼ŒRPC å›å¤ä¸¢å¤±ã€‚è¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´ä¸€æ¬¡è¯·æ±‚å¤šæ¬¡é‡å¤æäº¤çš„æƒ…å†µã€‚æ¯”å¦‚ä¸‹é¢ä¸€ç§ç®€å•çš„æƒ…å†µï¼š</p>
<ol>
<li>Client å‘ Server å‘é€ Append(x, 1) çš„è¯·æ±‚</li>
<li>Server æˆåŠŸæ¥æ”¶ï¼ŒRaft å±‚è¾¾æˆå…±è¯†ï¼Œåº”ç”¨è‡³çŠ¶æ€æœºã€‚æ­¤æ—¶çŠ¶æ€æœºçŠ¶æ€ {x: 1}</li>
<li>ç”±äºç½‘ç»œåŸå› ï¼ŒServer å‘ Client è¿”å›çš„ç»“æœä¸¢å¤±</li>
<li>Client è‹¦è‹¦ç­‰å¾…ï¼Œä¹Ÿæ²¡æœ‰æ”¶åˆ° Server è¿”å›çš„ç»“æœï¼Œäºæ˜¯è¶…æ—¶é‡è¯•ã€‚ç»•äº†ä¸€åœˆååˆå›åˆ°äº†è¿™ä¸ª Server (æ­¤ Server ä»ä¸º Leader)</li>
<li>Client åˆå‘ Server å‘é€ Append(x, 1) çš„è¯·æ±‚ï¼ŒServer æˆåŠŸæ¥æ”¶ï¼ŒRaft å±‚è¾¾æˆå…±è¯†ï¼Œåº”ç”¨è‡³çŠ¶æ€æœºã€‚æ­¤æ—¶çŠ¶æ€æœºçŠ¶æ€ {x: 11}</li>
<li>è¿™æ¬¡ Server æˆåŠŸå‘ Client è¿”å›äº†ç»“æœã€‚</li>
<li>Client æˆåŠŸæ”¶åˆ°äº†è¿”å›çš„ç»“æœï¼Œç»“æŸè¯·æ±‚ã€‚ç„¶è€ŒåŸæœ¬çš„ Append(x, 1) è¯·æ±‚ï¼Œé€ æˆäº† Append(x, 11) çš„åæœã€‚</li>
</ol>
<p>å‡ºç°è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› æ˜¯ï¼ŒRaft å±‚å…è®¸åŒæ ·çš„ command commit å¤šæ¬¡ (Raft å±‚å¹¶ä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯ç›¸åŒçš„ commandï¼Œåªè¦æœ‰ command æ¥ï¼Œå°±å°è¯•å…±è¯†)ï¼Œä½†å®é™…ä¸Šï¼ŒåŒæ ·çš„ command åªèƒ½ apply ä¸€æ¬¡ã€‚è¿™å°±éœ€è¦æˆ‘ä»¬åœ¨ Server å±‚å¯¹è¯·æ±‚è¿›è¡Œå»é‡ã€‚</p>
<p>ä¸Šé¢åªä»‹ç»äº† Append è¯·æ±‚çš„æƒ…å†µï¼ŒPut è¯·æ±‚ä¹Ÿç±»ä¼¼ã€‚è™½ç„¶åœ¨åªæœ‰ä¸€ä¸ª Client æ—¶ï¼ŒPut è¯·æ±‚å¤šæ¬¡æ‰§è¡Œä¸ä¼šæ”¹å˜ç»“æœï¼Œä½†å¦‚æœæœ‰å¤šä¸ª Clientï¼Œé‡å¤çš„ Put è¯·æ±‚ä¹Ÿå¯èƒ½é€ æˆäº’ç›¸è¦†ç›–çš„åæœã€‚å› æ­¤ä¹Ÿéœ€è¦è¿›è¡Œå»é‡ã€‚</p>
<p>è‡³äº Get è¯·æ±‚ï¼Œå¤šæ¬¡é‡å¤å¹¶ä¸ä¼šæ”¹å˜çŠ¶æ€æœºçš„çŠ¶æ€ï¼Œæ— éœ€è¿›è¡Œå»é‡å¤„ç†ã€‚</p>
<blockquote>
<p>è¯´åˆ° Get è¯·æ±‚ï¼Œåœ¨è¿™é‡Œå°å°åœ°åä¸€ä¸‹é¢˜ï¼š</p>
<p>æŒ‰æˆ‘ä»¬ç›®å‰çš„å®ç°ï¼ŒGet/Put/Append è¯·æ±‚å‡éœ€å…ˆæ¨è‡³ Raft å±‚è¾¾æˆå…±è¯†ï¼Œè®°å½•åœ¨ Raft å±‚çš„ Log ä¸­ã€‚ç„¶è€Œ Get è¯·æ±‚å¹¶ä¸ä¼šæ”¹å˜ç³»ç»Ÿçš„çŠ¶æ€ï¼Œè®°å½•åœ¨ Log ä¸­ï¼Œå¯¹å´©æºƒåå›æ”¾ Log æ¢å¤æ•°æ®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚é‚£ä¹ˆå®é™…ä¸Šæ˜¯ä¸æ˜¯ä¸éœ€è¦å°† Get è¯·æ±‚ä¼ å…¥ Raft å±‚è¿›è¡Œå…±è¯†å‘¢ï¼Ÿæ˜¯çš„ã€‚å¹¶ä¸”è¿™æ ·ä¼šä½¿ç³»ç»Ÿæ•ˆç‡æ›´é«˜ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å°† Get è¯·æ±‚ä¹Ÿä¼ å…¥ Raft å±‚å‘¢ï¼Ÿè¿™ä¹ˆåšå®é™…ä¸Šæ˜¯ä¸ºäº†ç®€åŒ– KV Service çš„å®ç°éš¾åº¦ã€‚KV Service è¦æ±‚æˆ‘ä»¬æ°¸è¿œä¸åœ¨ minority ä¸­è¯»å–æ•°æ®ï¼Œå› ä¸ºè¿™æ ·å¯èƒ½ä¼šç ´åçº¿æ€§ä¸€è‡´æ€§ã€‚å‡å¦‚æˆ‘ä»¬ä¸å°† Get ä¼ å…¥ Raft å±‚ï¼Œç›´æ¥è¯»å– Leader Server çŠ¶æ€æœºä¸­çš„æ•°æ®ï¼Œè¯•æƒ³ä¸‹é¢è¿™ç§æƒ…å†µï¼š</p>
<ul>
<li>ä¸€å…±æœ‰ 5 å° Serverã€‚ä¸€å¼€å§‹ï¼ŒServer1 ä¸º Leaderï¼ŒClient å‘é€äº†ä¸€äº›è¯·æ±‚ï¼ŒRaft æˆåŠŸå…±è¯†ã€‚</li>
<li>æ­¤åï¼ŒServer1ã€Server2 ä¸ Server3ã€Server4ã€Server5 ç”±äºç½‘ç»œé—®é¢˜è¢«åˆ’åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ã€‚ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼ŒServer1 ä»è®¤ä¸ºè‡ªå·±æ˜¯ Leaderã€‚ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼ŒServer3 æˆåŠŸå½“é€‰ Leaderã€‚</li>
<li>Server3 åˆæ¥æ”¶äº†ä¸€äº›æ¥è‡ª Client çš„è¯·æ±‚ï¼Œä¸”åœ¨ Server3ã€Server4ã€Server5 é—´è¾¾æˆäº†å…±è¯†ã€‚</li>
<li>æœ‰ä¸¤ä¸ª Client å¸Œæœ› Get åŒä¸€ä¸ª keyï¼š
<ul>
<li>Client1 é¦–å…ˆè”ç³»äº† Server1ï¼ŒServer1 è®¤ä¸ºå®ƒè‡ªå·±æ˜¯ Leader (å®é™…å·²ç» outdated)ï¼Œä¾¿å‘ Client1 è¿”å›äº† outdated valueã€‚</li>
<li>Client2 é¦–å…ˆè”ç³» Server3ï¼ŒServer3 å‘å…¶è¿”å›äº† updated valueã€‚</li>
</ul>
</li>
<li>è¿™ä¸¤ä¸ª Get æ“ä½œé—´å¹¶æ²¡æœ‰å†™æ“ä½œï¼Œå´è¯»åˆ°äº†ä¸åŒçš„æ•°æ®ï¼Œè¿èƒŒäº†çº¿æ€§ä¸€è‡´æ€§ã€‚</li>
</ul>
<p>ä¸ºä»€ä¹ˆå°† Get ä¼ å…¥ Raft è¿›è¡Œå…±è¯†å°±å¯ä»¥é¿å…è¿™ç§é”™è¯¯ï¼Ÿä¾ç„¶è€ƒè™‘ä¸Šè¿°æƒ…å†µï¼šServer1 åœ¨æ¥æ”¶åˆ° Client1 çš„ Get è¯·æ±‚åï¼Œå°†å…¶ä¼ å…¥ Raft å±‚è¯•å›¾è¾¾æˆå…±è¯†ã€‚ç„¶è€Œ Server1 åªèƒ½è·å¾— Server2 çš„å“åº”ï¼Œæ— æ³•å°† Get è¯·æ±‚åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥è¿Ÿè¿Ÿæ— æ³•è¾¾æˆå…±è¯†ï¼ŒServer å±‚ä¹Ÿä¼šè¢«é•¿æœŸé˜»å¡ã€‚Client1 ä¹…ä¹…ç­‰ä¸åˆ°ç­”å¤ï¼Œä¾¿ä¼šæ›´æ¢ Server é‡æ–°è¿›è¡Œè¯·æ±‚ï¼Œæ­¤æ—¶å°±ä¼šæ‰¾åˆ°æ–°çš„ Leader Server3 å¹¶æˆåŠŸæ‰§è¡Œ Get è¯·æ±‚ã€‚æ‰€ä»¥ï¼Œå°† Get è¯·æ±‚ä¸€åŒä¼ å…¥ Raft å±‚æ˜¯æœ€ç®€å•åœ°é¿å…è¯»å–åˆ° minority æ•°æ®çš„æ–¹æ³•ã€‚</p>
<p>Raft è®ºæ–‡åœ¨ session 8 ä¸­æåˆ°äº† read-only operations ç­‰ä¼˜åŒ–ï¼Œé¿å…å°† Get å†™å…¥ Logï¼ŒåŒæ—¶è§£å†³äº†å¯èƒ½è·å– outdated æ•°æ®çš„é—®é¢˜ã€‚å¯ä»¥è‡ªè¡Œå‚è€ƒã€‚</p>
</blockquote>
<p>å»é‡å…·ä½“çš„æ‰§è¡Œæ–¹å¼ï¼Œå°±å’Œä¹‹å‰åœ¨ Client ä¸­è¿˜æ²¡æœ‰è®²åˆ°çš„ idã€seq ç­‰å˜é‡æœ‰å…³äº†ã€‚</p>
<p>id æ˜¯ Client çš„ uuidï¼Œç”¨äºæ ‡è¯†ä¸åŒçš„ Clientï¼Œç›´æ¥ç”¨ skeleton code ä¸­çš„ <code>nrand()</code> æ–¹æ³•ç”Ÿæˆå³å¯ (æµ‹è¯•æ—¶å¼€ä¸äº†é‚£ä¹ˆå¤š Clientï¼Œç¢°æ’æ¦‚ç‡æä½ï¼Œå¯ä»¥å‡‘åˆå½“uuidç”¨)ã€‚seq åˆ™æ˜¯ Client å†™æ“ä½œçš„æœ€å¤§æ“ä½œæ•°ï¼Œä» 1 å¼€å§‹é€’å¢ã€‚æ¯å½“ Client å®Œæˆä¸€æ¬¡å†™æ“ä½œï¼Œå°±å°† seq åŠ  1ã€‚</p>
<p>Server ç«¯åˆ™ç»´æŠ¤ä¸€å¼  mapï¼Œç”¨äºè®°å½•ä¸åŒ Client æˆåŠŸåº”ç”¨è‡³çŠ¶æ€æœºçš„æœ€å¤§ seq æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">maxSeq</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="kt">int64</span>
</span></span></code></pre></div><p>åœ¨é‡åˆ°æ¥è‡ª client x çš„ y seq è¯·æ±‚æ—¶ï¼Œå¦‚æœ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">maxSeq</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">y</span>
</span></span></code></pre></div><p>å°±è¡¨æ˜è¿™æ˜¯ä¸€æ¬¡é‡å¤çš„è¯·æ±‚ï¼Œéœ€è¦è¿›è¡Œæ‹¦æˆªã€‚</p>
<p>æ­¤æ—¶åˆæœ‰æ–°çš„é—®é¢˜å‡ºç°äº†ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨å“ªé‡Œæ‹¦æˆªé‡å¤çš„è¯·æ±‚ï¼Œåœ¨å“ªé‡Œæ›´æ–° maxSeqï¼Ÿ</p>
<p>æˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯ï¼Œç›´æ¥åœ¨ RPC handler çš„æœ€å¼€å§‹åˆ¤æ–­è¯·æ±‚æ˜¯å¦é‡å¤ï¼Œè‹¥æ˜¯é‡å¤è¯·æ±‚åˆ™ç›´æ¥æ‹¦æˆªå¹¶è¿”å›ã€‚å¹¶åœ¨ RPC handler è¿”å›å‰æ›´æ–° maxSeqã€‚ç„¶è€Œè¿™ç§å¤„ç†æ–¹æ³•å­˜åœ¨é—®é¢˜ã€‚è¯•æƒ³å¦‚ä¸‹æƒ…å†µï¼š</p>
<ul>
<li>Client é¦–å…ˆå‘ Leader Server1 å‘èµ· Append è¯·æ±‚ã€‚Server1 æˆåŠŸå®Œæˆå…±è¯†å¹¶å°†è¯·æ±‚åº”ç”¨è‡³çŠ¶æ€æœºï¼Œä¹Ÿæ›´æ–°äº† maxSeqã€‚ä½†åœ¨è¿”å›æ—¶ RPC ç»“æœä¸¢å¤±ã€‚</li>
<li>æ­¤æ—¶ï¼Œæ°å¥½ Server1 ç”±äºå´©æºƒæˆ–ç½‘ç»œéš”ç¦»ç­‰åŸå› ï¼Œå¤±å» Leader èº«ä»½ï¼ŒServer2 å½“é€‰ Leaderã€‚</li>
<li>ç”±äº RPC ç»“æœä¸¢å¤±ï¼ŒClient é•¿æ—¶é—´å¾—ä¸åˆ°å“åº”ï¼Œä¾¿å°è¯•æ›´æ¢ Server é‡æ–°å‘èµ·è¯·æ±‚ã€‚</li>
<li>Client å‘ Server2 å‘èµ·äº†åŒæ ·çš„ Append è¯·æ±‚ã€‚ç”±äº Server2 çš„ maxSeq ä¸­å¹¶æ²¡æœ‰æ­¤ Client æ­¤ Seq çš„ä¿¡æ¯ (ä¸Šæ¬¡ä»…æ˜¯å­˜å‚¨åœ¨äº† Server1 çš„ maxSeq)ï¼Œäºæ˜¯ Server2 å†æ¬¡æ‰§è¡Œäº†è¯·æ±‚ã€‚ä¹Ÿå¯¼è‡´äº†ä¸€æ¬¡è¯·æ±‚å¤šæ¬¡åº”ç”¨çš„åæœã€‚</li>
</ul>
<p>å‡ºç°è¿™ç§æƒ…å†µçš„æ ¹æœ¬åŸå› æ˜¯ Server å¹¶ä¸ä¼šç›´æ¥è”ç³»ï¼Œä¸åŒ Server çš„ maxSeq æ— æ³•å…±äº«ï¼Œå› æ­¤åœ¨ Client åˆ‡æ¢ Server æäº¤é‡å¤è¯·æ±‚æ—¶ï¼ŒServer æ— æ³•å¯Ÿè§‰ã€‚</p>
<p>è§£å†³æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼šåœ¨ command è¾¾æˆå…±è¯†åï¼Œå°† command åº”ç”¨è‡³çŠ¶æ€æœºå‰ï¼Œå¯¹ command è¿›è¡Œå»é‡ã€‚å¹¶åœ¨æˆåŠŸåº”ç”¨ command åï¼Œæ›´æ–° maxSeqã€‚å³ maxSeq å®é™…ä¸Šç”±çŠ¶æ€æœºç»´æŠ¤ã€‚è¿™æ ·åšèƒ½æˆåŠŸçš„åŸå› æ˜¯ï¼Œä¸åŒçš„ Server é€šè¿‡ Raft å±‚çš„äº¤æµï¼Œé—´æ¥åœ°å…±äº«äº† maxSeqã€‚æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦å…ˆå°è¯•åº”ç”¨è‡³çŠ¶æ€æœºï¼Œè€ŒçŠ¶æ€æœºç»´æŠ¤çš„ maxSeq æ°å¥½å¯ä»¥æ‹¦æˆªè¯•å›¾åº”ç”¨çš„é‡å¤è¯·æ±‚ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">apply</span><span class="p">(</span><span class="nx">op</span> <span class="nx">Op</span><span class="p">)</span> <span class="nx">Result</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">result</span> <span class="o">:=</span> <span class="nx">Result</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">T</span> <span class="o">==</span> <span class="s">&#34;Get&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">Key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">op</span><span class="p">.</span><span class="nx">T</span> <span class="o">==</span> <span class="s">&#34;Put&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">maxSeq</span><span class="p">[</span><span class="nx">op</span><span class="p">.</span><span class="nx">ClientId</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Seq</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">kv</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">kv</span><span class="p">.</span><span class="nx">maxSeq</span><span class="p">[</span><span class="nx">op</span><span class="p">.</span><span class="nx">ClientId</span><span class="p">]</span> <span class="p">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Seq</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">OK</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">maxSeq</span><span class="p">[</span><span class="nx">op</span><span class="p">.</span><span class="nx">ClientId</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Seq</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">kv</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nb">append</span><span class="p">(</span><span class="nx">op</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">kv</span><span class="p">.</span><span class="nx">maxSeq</span><span class="p">[</span><span class="nx">op</span><span class="p">.</span><span class="nx">ClientId</span><span class="p">]</span> <span class="p">=</span> <span class="nx">op</span><span class="p">.</span><span class="nx">Seq</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">result</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">OK</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¼¼ä¹æˆ‘ä»¬çš„ KV Service å·²ç»å®Œç¾æ— ç¼ºäº†ã€‚å½“æ—¶æˆ‘å°±æ˜¯è¿™ä¹ˆè®¤ä¸ºçš„ï¼Œç„¶è€Œå®ƒè¿˜å­˜åœ¨ä¸¤ä¸ªé€»è¾‘ä¸Šçš„å°é—®é¢˜ TAT</p>
<p>æˆ‘ä»¬ç”¨æ¥è½¬å‘ applyCh ä¿¡æ¯çš„ notifier åç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">notifier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">!</span><span class="nx">kv</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">kv</span><span class="p">.</span><span class="nx">applyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">op</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Command</span><span class="p">.(</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">result</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>	<span class="c1">// apply to state machine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">			<span class="nx">index</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">result</span>	<span class="c1">// notify the blocked server 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>éœ€è¦æ„è¯†åˆ°çš„æ˜¯ï¼Œä¸æ˜¯æ‰€æœ‰ Server éƒ½æ˜¯ Leader èŠ‚ç‚¹ï¼ŒFollower èŠ‚ç‚¹ä¹Ÿä¼šé€šè¿‡ applyCh å‘ Server å±‚è½¬é€’éœ€è¦ apply è‡³çŠ¶æ€æœºçš„æ•°æ®ã€‚æ­¤æ—¶ Server å±‚å¹¶æ²¡æœ‰ RPC Handler åœ¨ç­‰å¾… applyCh çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬ä»å°è¯•è·å–å¯¹åº”çš„ <code>notifyCh</code> å¹¶è½¬å‘æ•°æ®ï¼Œåˆ™ä¼šé€ æˆ notifier çš„æ— é™é˜»å¡ã€‚æ”¹å†™å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">notifier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">!</span><span class="nx">kv</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">kv</span><span class="p">.</span><span class="nx">applyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">op</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Command</span><span class="p">.(</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">result</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>	<span class="c1">// apply to state machine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">isLeader</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">rf</span><span class="p">.</span><span class="nf">GetState</span><span class="p">();</span> <span class="p">!</span><span class="nx">isLeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">index</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">result</span>	<span class="c1">// notify the blocked server 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Server ä¸ä¸º Leader çš„æƒ…å†µå·²ç»è§£å†³ã€‚å‡å¦‚ Server å½“å‰æ˜¯ Leaderï¼Œæœ‰æ²¡æœ‰å¯èƒ½éƒ¨åˆ† applyCh ä¼ æ¥çš„æ•°æ®ä¹Ÿæ— éœ€è½¬å‘å‘¢ï¼Ÿä¹Ÿæœ‰å¯èƒ½ï¼Œæœ€ç®€å•çš„æƒ…å†µå°±æ˜¯æ–°å½“é€‰çš„ Leader çš„ Log ä¸­è¿˜å­˜åœ¨å·²æäº¤æœªåº”ç”¨çš„ commandã€‚å°†è¿™ä¸ª command ä¼ å…¥ Server å±‚åï¼ŒæŒ‰ç…§ä¸Šé¢çš„å†™æ³•ï¼Œä¹Ÿä¼šå°è¯•å‘å¹¶ä¸å­˜åœ¨çš„ RPC Handler è½¬å‘æ•°æ®å¹¶é€ æˆé˜»å¡ã€‚è¿™ç§æƒ…å†µè§£å†³èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸å±äºå½“å‰ term çš„ command æ— éœ€è½¬å‘ï¼Œç›´æ¥ç»™çŠ¶æ€æœºåº”ç”¨å°±å¯ä»¥äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">kv</span> <span class="o">*</span><span class="nx">KVServer</span><span class="p">)</span> <span class="nf">notifier</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">!</span><span class="nx">kv</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">msg</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">kv</span><span class="p">.</span><span class="nx">applyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">op</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">Command</span><span class="p">.(</span><span class="nx">Op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">result</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">op</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">term</span><span class="p">,</span> <span class="nx">isLeader</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">rf</span><span class="p">.</span><span class="nf">GetState</span><span class="p">();</span> <span class="p">!</span><span class="nx">isLeader</span> <span class="o">||</span> <span class="nx">term</span> <span class="o">!=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">index</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">CommandIndex</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">:=</span> <span class="nx">kv</span><span class="p">.</span><span class="nf">getNotifyCh</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åˆ°è¿™é‡Œ Lab3A çš„è¦æ±‚å·²ç»å®Œæˆäº†ã€‚</p>
<h2 id="test--debug">Test &amp; Debug<a hidden class="anchor" aria-hidden="true" href="#test--debug">#</a></h2>
<p>ä¸Šé¢ä¸æ–­æ”¹é”™çš„ç»å†å¤§è‡´å°±æ˜¯æˆ‘åœ¨æµ‹è¯•é›†ä¸­ä¸æ–­ fail å¹¶ä¿®æ”¹çš„è¿‡ç¨‹ã€‚Lab ç»™å‡ºçš„æµ‹è¯•é›†è¿˜æ˜¯æ¯”è¾ƒè¯¦å°½çš„ï¼Œå¯ä»¥æµ‹å‡ºå„æ–¹é¢çš„ç»†èŠ‚ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªæµ‹è¯•é›†æ¯”è¾ƒå¥‡æ€ªï¼š</p>
<pre tabindex="0"><code>Test: ops complete fast enough (3A)
</code></pre><p>è¿™ä¸ªæµ‹è¯•æ˜¯éœ€è¦ command è¾¾æˆå…±è¯†å¹¶åº”ç”¨è‡³çŠ¶æ€æœºçš„é€Ÿåº¦è¶³å¤Ÿå¿«ï¼Œæ¯æ¬¡å¿ƒè·³é—´éš” (100ms) ä¸­è‡³å°‘éœ€è¦å®Œæˆ 3 æ¬¡å…±è¯†ã€‚åœ¨ Lab2 ä¸­ï¼Œæˆ‘ä»¬å·²ç»åœ¨æ¯æ¬¡ <code>Start(command)</code> æ—¶éƒ½æèµ·ä¸€æ¬¡å¤åˆ¶è¯·æ±‚ï¼Œç”¨ä¸åŒçš„ replicator å‘å„ä¸ªèŠ‚ç‚¹å¹¶è¡Œåœ°ä¸æ–­å°è¯•å¤åˆ¶ Logï¼Œè€Œä¸æ˜¯å®Œå…¨é å¿ƒè·³è¿›è¡Œå¤åˆ¶ (åŸºæœ¬æ¯æ¬¡å¿ƒè·³é—´éš”åªèƒ½å®Œæˆä¸€æ¬¡å…±è¯†)ã€‚æŒ‰ç†æ¥è¯´åº”è¯¥èƒ½å¤Ÿè½»æ¾é€šè¿‡ï¼Œç„¶è€Œæµ‹è¯•ç»“æœæ€»æ˜¯è¶…æ—¶ã€‚</p>
<p>æˆ‘è¯•äº†è¯•ä¸å¸¦ <code>-race</code> æ ‡è¯†çš„æµ‹è¯•ï¼Œç»“æœå¾ˆæ„å¤–ï¼Œä»…ä»… 3s å·¦å³å°±é€šè¿‡äº†æµ‹è¯•ï¼Œè€Œå¸¦ä¸Š <code>-race</code> æ ‡è¯†è¶³è¶³éœ€è¦ 40s å·¦å³ã€‚åˆ°è¿™é‡Œå…¶å®å·²ç»åŸºæœ¬å¯ä»¥çŒœåˆ°æ˜¯ä»€ä¹ˆé—®é¢˜äº†ï¼šé”çš„ç«äº‰è¿‡äºæ¿€çƒˆï¼Œ<code>-race</code> æ ‡è¯†ä¼šè¿›è¡Œ Data race çš„æ£€æµ‹ï¼Œ ä¸¥é‡åœ°å½±å“äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p>
<p>æˆ‘åˆåœ¨ test ä¸­åŠ å…¥äº†å¯¹ goroutine æ•°é‡çš„ç›‘æ§ï¼Œå‘ç° goroutine æ•°é‡ä¸æ–­å¢é•¿ï¼Œé«˜çš„æ—¶å€™å¯ä»¥è¾¾åˆ° 300+ goroutineã€‚è™½è¯´ goroutine å·ç§°æ˜¯è½»æ¾å¼€å¯ä¸Šä¸‡ä¸ªï¼Œä½†è¿™ä¹ˆé«˜çš„ goroutine æ•°é‡æ˜¾ç„¶è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ã€‚</p>
<p>ä¹‹åç»è¿‡æ’æŸ¥ï¼Œå‘ç°å¤§é‡çš„ goroutine å¡åœ¨äº† Lab2 Raft å±‚å‘ applier å‘é€ apply è¯·æ±‚çš„ goroutine ä¸Šï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCh</span> <span class="o">&lt;-</span> <span class="nx">msg</span> <span class="p">}()</span>
</span></span></code></pre></div><p>è¿™æ ·å°±æ¯”è¾ƒå¥½è§£é‡Šäº†ï¼ŒClient çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡çš„è¯·æ±‚ï¼Œè€Œ applier åªæœ‰ä¸€ä¸ªï¼Œå¤§é‡å°è¯•ä¼ é€’ç»™ applyCh çš„ msg é˜»å¡ï¼Œå¯¼è‡´åç¨‹æ•°è¿‡å¤§ã€‚</p>
<p>å› æ­¤éœ€è¦å°† Lab2 ä¸­è¿‡å¤šçš„é‡å¤ msg æ‹¦æˆªï¼Œåšæ³•å’Œ replicator ä¸­ç±»ä¼¼ï¼Œæˆ–è€…æ”¹ç”¨ sync.Condï¼Œç”¨ Signal ä¸é˜»å¡çš„æ€§è´¨æ¥å®ç°ã€‚</p>
<p>Lab3A éƒ¨åˆ†åˆ°è¿™é‡Œç»“æŸï¼Œæ¥ä¸‹æ¥è®²è®² Lab3Bã€‚</p>
<h2 id="snapshot">Snapshot<a hidden class="anchor" aria-hidden="true" href="#snapshot">#</a></h2>
<p>å‰é¢çš„å·¥ä½œåšå¥½åï¼ŒåŠ ä¸Šä¸€ä¸ª Snapshot å…¶å®æ¯”è¾ƒç®€å•ï¼Œåœ¨ notifier ä¸­æ ¹æ® <code>RaftStateSize()</code> å’Œ <code>MaxStateSize</code> çš„å¤§å°å…³ç³»åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦éœ€è¦è¿›è¡Œä¸€æ¬¡ Snapshotï¼Œå¹¶ä¸”å¢åŠ ä¸€ä¸ª <code>commandValid == false</code> çš„åˆ†æ”¯å°† Raft å±‚ä¼ é€’çš„ Snapshot åº”ç”¨è‡³çŠ¶æ€æœºå°±å¯ä»¥äº†ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSnapshot ä¸ä»…éœ€è¦ä¿å­˜ kv database çš„ä¿¡æ¯ï¼Œè¿˜éœ€è¦ä¿å­˜ maxSeqã€‚å› ä¸ºæ”¹å˜äº†çŠ¶æ€æœºçš„çŠ¶æ€ï¼Œå°±éœ€è¦çŠ¶æ€æœºç›¸å…³çš„ maxSeq ä¿¡æ¯æ¥æ‹¦æˆªé‡å¤è¯·æ±‚ã€‚åœ¨åº”ç”¨ Snapshot æ—¶ï¼ŒçŠ¶æ€æœºçŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦å°† maxSeq ä¸ Leader çš„ maxSeq è¿›è¡ŒåŒæ­¥ã€‚</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>Lab3 æ•´ä½“åä¸‹æ¥éš¾åº¦æ¯” Lab2 å°ä¸€äº›ï¼Œdebug ä¹Ÿå¾ˆæŠ˜ç£¨äººå°±æ˜¯äº†ã€‚å…¶é—´ä¹Ÿé‡åˆ°äº†ä¸å°‘æ¦‚ç‡æä½ä½†åŒªå¤·æ‰€æ€çš„å°é—®é¢˜ï¼Œæˆ–è®¸ Raft å±‚è¿˜æ˜¯ä¸å¤ªå¯¹ï¼Ÿä¸è¿‡ä¹Ÿä¸æƒ³å†å»å¤„ç†äº†ï¼Œæ„Ÿè§‰åˆ†å¸ƒå¼ç³»ç»Ÿçš„ debug æ›´åƒæ˜¯ä¸€ç§ä½“åŠ›æ´»ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/raft/">Raft</a></li>
      <li><a href="http://localhost:1313/tags/distributed-system/">Distributed System</a></li>
      <li><a href="http://localhost:1313/tags/consensus-algorithm/">Consensus Algorithm</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/zsh/">
    <span class="title">Â« Prev</span>
    <br>
    <span>zshå®‰è£…ä¸é…ç½®</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/mit6.824-lab2-raft/">
    <span class="title">Next Â»</span>
    <br>
    <span>MIT6.824 Lab2 Raft</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Cookie&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
