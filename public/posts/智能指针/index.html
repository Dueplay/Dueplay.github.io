<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æ™ºèƒ½æŒ‡é’ˆ | Cookie&#39;s Blog</title>
<meta name="keywords" content="c&#43;&#43;">
<meta name="description" content="c&#43;&#43;ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ">
<meta name="author" content="Me">
<link rel="canonical" href="https://canonical.url/to/page">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2&#43;ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.2eadbb982468c11a433a3e291f01326f2ba43f065e256bf792dbd79640a92316.js" integrity="sha256-Lq27mCRowRpDOj4pHwEybyukPwZeJWv3ktvXlkCpIxY="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="apple-touch-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<link rel="mask-icon" href="http://localhost:1313/%3Clink%20/%20abs%20url%3E">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4XHWHM02GB"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-4XHWHM02GB', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="æ™ºèƒ½æŒ‡é’ˆ" />
<meta property="og:description" content="c&#43;&#43;ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/" />
<meta property="og:image" content="http://localhost:1313/%3Cimage%20path/url%3E" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-03-12T15:12:01&#43;08:00" />
<meta property="article:modified_time" content="2024-03-12T15:12:01&#43;08:00" /><meta property="og:site_name" content="ExampleSite" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/%3Cimage%20path/url%3E" />
<meta name="twitter:title" content="æ™ºèƒ½æŒ‡é’ˆ"/>
<meta name="twitter:description" content="c&#43;&#43;ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "æ™ºèƒ½æŒ‡é’ˆ",
      "item": "http://localhost:1313/posts/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æ™ºèƒ½æŒ‡é’ˆ",
  "name": "æ™ºèƒ½æŒ‡é’ˆ",
  "description": "c++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ",
  "keywords": [
    "c++"
  ],
  "articleBody": "unique_ptr è€ƒè™‘ä¸‹é¢çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨å †ä¸Šåˆ†é…äº†ä¸€ä¸ª Simple å¯¹è±¡ï¼Œä½†æ˜¯ä¸é‡Šæ”¾è¿™ä¸ªå¯¹è±¡ï¼Œæ•…æ„äº§ç”Ÿå†…å­˜æ³„æ¼ã€‚\nvoid leaky() { Simple* mySimplePtr = new Simple(); // BUG! Memory is never released! mySimplePtr-\u003ego(); } æœ‰æ—¶ä½ å¯èƒ½è®¤ä¸ºï¼Œä»£ç æ­£ç¡®åœ°é‡Šæ”¾äº†åŠ¨æ€åˆ†é…çš„å†…å­˜ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™ç§æƒ³æ³•å‡ ä¹æ€»æ˜¯ä¸æ­£ç¡®çš„ã€‚æ¯”å¦‚è¿™ä¸ªå‡½æ•°:\nvoid couldBeLeaky() { Simple*mySimplePtr =new Simple(); mySimplePtr-\u003ego(); delete mySimplePtr; } ä¸Šé¢çš„å‡½æ•°åŠ¨æ€åˆ†é…ä¸€ä¸ª Simple å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡ï¼Œç„¶åæ­£ç¡®åœ°è°ƒç”¨ deleteã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¾‹å­ä»ç„¶å¯èƒ½äº§ç”Ÿå†…å­˜æ³„æ¼! å¦‚æœ goæ–¹æ³•æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå°†æ°¸è¿œä¸ä¼šè°ƒç”¨ deleteï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚\nè¿™ä¸¤ç§æƒ…å†µä¸‹åº”ä½¿ç”¨ unique_ptrã€‚å¯¹è±¡ä¸ä¼šæ˜¾å¼åˆ é™¤ï¼Œä½†å®ä¾‹ unique_ptrç¦»å¼€ä½œç”¨åŸŸæ—¶(åœ¨å‡½æ•°çš„æœ«å°¾ï¼Œæˆ–è€…å› ä¸ºæŠ›å‡ºäº†å¼‚å¸¸)ï¼Œå°±ä¼šåœ¨å…¶ææ„å‡½æ•°ä¸­è‡ªåŠ¨é‡Šæ”¾ Simple å¯¹è±¡:\nvoid notLeaky() { auto mySimpleSmartPtr =make unique\u003cSimple\u003e(); mySimpleSmartPtr-\u003ego(); } è¿™æ®µä»£ç ä½¿ç”¨ C++14 ä¸­çš„ make_uniqueå’Œ auto å…³é”®å­—ï¼Œæ‰€ä»¥åªéœ€è¦æŒ‡å®šæŒ‡é’ˆçš„ç±»å‹ï¼Œæœ¬ä¾‹ä¸­æ˜¯ Simple,å¦‚æœSimpleæ„é€ å‡½æ•°éœ€è¦å‚æ•°ï¼Œå°±æŠŠå®ƒä»¬æ”¾åœ¨make_unique()è°ƒç”¨çš„åœ†æ‹¬å·ä¸­ã€‚\nå¦‚æœç¼–è¯‘å™¨ä¸æ”¯æŒmake_unique, å¯ä»¥è¿™ç§æ–¹å¼åˆ›å»ºã€‚\nunique_ptr\u003cSimple\u003e p(new Simple()); åƒæ ‡å‡†æŒ‡é’ˆä¸€æ ·ï¼Œä»å¯ä»¥ä½¿ç”¨*æˆ–-\u003eå¯¹æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ã€‚\nget()æ–¹æ³•å¯ç”¨äºç›´æ¥è®¿é—®åº•å±‚æŒ‡é’ˆã€‚è¿™å¯å°†æŒ‡é’ˆä¼ é€’ç»™éœ€è¦æ™®é€šæŒ‡é’ˆçš„å‡½æ•°ã€‚ä¾‹å¦‚\nvoid processData(Simple* simple)( /* Use the simple pointer...*/ // å¯é‡‡ç”¨å¦‚ä¸‹æ–¹å¼è¿›è¡Œè°ƒç”¨: auto mySimpleSmartPtr = make_unique\u003cSimple\u003e(); processData(mySimpleSmartPtr.get()); å¯é‡Šæ”¾unique_ptr çš„åº•å±‚æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨reset()æ ¹æ®éœ€è¦å°†å…¶æ”¹æˆå¦ä¸€ä¸ªæŒ‡é’ˆã€‚\nmySimpleSmartPtr.reset(); // Free resource and set to nullptr mySimpleSmartPtr.reset(new Simple()); // Free resource and set to a new Simple instance å¯ä½¿ç”¨ release()æ–­å¼€ unique_ptr ä¸åº•å±‚æŒ‡é’ˆçš„è¿æ¥ã€‚releaseæ–¹æ³•è¿”å›èµ„æºçš„åº•å±‚æŒ‡é’ˆï¼Œç„¶åå°†æ™ºèƒ½æŒ‡é’ˆè®¾ ä¸º nullptrã€‚å®é™…ä¸Šï¼Œæ™ºèƒ½æŒ‡é’ˆå¤±å»å¯¹èµ„æºçš„æ‰€æœ‰æƒï¼Œè´Ÿè´£åœ¨ä½ ç”¨å®Œèµ„æºæ—¶é‡Šæ”¾èµ„æºã€‚\nSimple* simple= mySimpleSmartPtr.release();// Release ownership //Use the simple pointer... delete simple; simple = nullptr; ç”±äº unique_pträ»£è¡¨å”¯ä¸€æ‹¥æœ‰æƒï¼Œå› æ­¤æ— æ³•å¤åˆ¶å®ƒ!ä½¿ç”¨ std::move() ç§»åŠ¨è¯­ä¹‰å°†ä¸€ä¸ªunique_ptr ç§»åˆ°å¦ä¸€ä¸ªã€‚è¿™ç”¨äºæ˜¾å¼ç§»åŠ¨æ‰€æœ‰æƒã€‚\nclass Foo { public: Foo(unique ptr\u003cint\u003e data) : mData(move(data)) {} private: unique_ptr\u003cint\u003emData; }; auto myIntSmartPtr = make unique\u003cint\u003e(42); Foo f(move(myIntSmartPtr)); unique_ptr é€‚ç”¨äºå­˜å‚¨åŠ¨æ€åˆ†é…çš„æ—§å¼C é£æ ¼æ•°ç»„ã€‚ä¸‹ä¾‹åˆ›å»ºäº†ä¸€ä¸ª unique_ptr æ¥ä¿å­˜åŠ¨æ€åˆ†é…çš„ã€åŒ…å«10ä¸ªæ•´æ•°çš„Cé£æ ¼æ•°ç»„:\nauto myVariableSizedArray = make_unique\u003cint[]\u003e(10); è‡ªå®šä¹‰ deleter é»˜è®¤æƒ…å†µä¸‹ï¼Œunique_ptr ä½¿ç”¨æ ‡å‡†çš„new å’Œdeleteè¿ç®—ç¬¦æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚å¯å°†æ­¤è¡Œä¸ºæ”¹æˆ:\nint* malloc_int(int value) { int*p= (int*)malloc(sizeof(int)); *p=value; return p; } int main() { unique ptr\u003cintï¼Œdecltype(free)*\u003e myIntSmartPtr(malloc_int(42)ï¼Œfree); return 0; } è¿™æ®µä»£ç ä½¿ç”¨ malloc_int()ç»™æ•´æ•°åˆ†é…å†…å­˜ã€‚unique_ptr è°ƒç”¨æ ‡å‡†çš„ freeå‡½æ•°æ¥é‡Šæ”¾å†…å­˜ã€‚å¦‚å‰æ‰€è¿°, åœ¨C++ä¸­ä¸åº”è¯¥ä½¿ç”¨ mallocï¼Œè€Œåº”æ”¹ç”¨ newã€‚ç„¶è€Œï¼Œunique_ptr çš„è¿™é¡¹ç‰¹æ€§æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºè¿˜å¯ç®¡ç†å…¶ä»–ç±»å‹çš„èµ„æºè€Œä¸ä»…æ˜¯å†…å­˜ã€‚ä¾‹å¦‚ï¼Œå½“ unique_ptr ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¯è‡ªåŠ¨å…³é—­æ–‡ä»¶æˆ–ç½‘ç»œå¥—æ¥å­—ä»¥åŠå…¶ä»–ä»»ä½•èµ„æºã€‚ ä½†æ˜¯ï¼Œunique_ptr çš„è‡ªå®šä¹‰ deleter çš„è¯­æ³•æœ‰äº›è´¹è§£ã€‚éœ€è¦å°†è‡ªå®šä¹‰ deleter çš„ç±»å‹æŒ‡å®šä¸ºæ¨¡æ¿ç±»å‹å‚æ•°. decltype(free)ç”¨äºè¿”å› free()ç±»å‹ã€‚æ¨¡æ¿ç±»å‹å‚æ•°åº”å½“æ˜¯å‡½æ•°æŒ‡é’ˆçš„ç±»å‹ï¼Œå› æ­¤å¦å¤–é™„åŠ ä¸€ä¸ª*ï¼Œå¦‚decltype(free)*\nshared_ptr shared_ptr çš„ç”¨æ³•ä¸ unique_ptr ç±»ä¼¼ã€‚è¦åˆ›å»º shared_ptrï¼Œå¯ä½¿ç”¨ make_shared()ï¼Œå®ƒæ¯”ç›´æ¥åˆ›å»º shared_ptræ›´é«˜æ•ˆã€‚\næ›´é«˜æ•ˆåŸå› ï¼š\nå½“ä½¿ç”¨ std::make_shared åˆ›å»º shared_ptr æ—¶ï¼Œæ‰€æœ‰éœ€è¦çš„å†…å­˜ï¼ˆåŒ…æ‹¬å¯¹è±¡æœ¬èº«å’Œæ§åˆ¶å—ï¼‰åœ¨ä¸€æ¬¡åˆ†é…ä¸­å®Œæˆã€‚è¿™å‡å°‘äº†å†…å­˜åˆ†é…çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚\nè€Œç›´æ¥ä½¿ç”¨ std::shared_ptr æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡é€šå¸¸éœ€è¦ä¸¤æ¬¡å†…å­˜åˆ†é…ï¼Œä¸€æ¬¡ç”¨äºå¯¹è±¡æœ¬èº«ï¼Œä¸€æ¬¡ç”¨äºæ§åˆ¶å—ã€‚\nåœ¨ç›´æ¥ä½¿ç”¨ new çš„æƒ…å†µä¸‹ï¼Œåœ¨å¯¹è±¡æ„é€ å’Œæ§åˆ¶å—åˆ†é…ä¹‹é—´ï¼Œå¦‚æœå¯¹è±¡æ„é€ æŠ›å‡ºå¼‚å¸¸ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è€Œ std::make_shared åœ¨åˆ†é…å’Œæ„é€ å¯¹è±¡çš„è¿‡ç¨‹ä¸­æ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚\nauto mySimpleSmartPtr = make_shared\u003cSimple\u003e(); std::shared_ptr\u003cSimple\u003e ptr(new Simple()); ä¸unique_ptr ä¸€æ ·ï¼Œshared_ptr ä¹Ÿæ”¯æŒ getå’Œresetæ–¹æ³•ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œå½“è°ƒç”¨ resetæ—¶ï¼Œç”±äºå¼•ç”¨è®¡æ•°ï¼Œä»…åœ¨æœ€åçš„ shared_ptré”€æ¯æˆ–é‡ç½®æ—¶,æ‰é‡Šæ”¾åº•å±‚èµ„æºã€‚æ³¨æ„,shared ptr ä¸æ”¯æŒ releaseã€‚å¯ä½¿ç”¨use count()æ¥æ£€ç´¢å…±äº«åŒä¸€èµ„æºçš„shared_ptr å®ä¾‹æ•°é‡ã€‚\nä¸ unique_ptr ç±»ä¼¼ï¼Œshared_ptr é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æ ‡å‡†çš„ new å’Œ delete è¿ç®—ç¬¦æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜;åœ¨ C++17 ä¸­å­˜å‚¨Cé£æ ¼æ•°ç»„æ—¶ï¼Œä½¿ç”¨ new[]å’Œ delete[]ã€‚å¯æ›´æ”¹æ­¤è¡Œä¸º\nshared_ptr\u003cint\u003e myIntSmartPtr(malloc_int(42)ï¼Œ free); å¯ä»¥çœ‹åˆ°ï¼Œä¸å¿…å°†è‡ªå®šä¹‰ deleter çš„ç±»å‹æŒ‡å®šä¸ºæ¨¡æ¿ç±»å‹å‚æ•°ï¼Œè¿™æ¯” unique_ptr çš„è‡ªå®šä¹‰ deleter æ›´ç®€ä¾¿ã€‚\nä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨ shared_ptr å­˜å‚¨æ–‡ä»¶æŒ‡é’ˆã€‚å½“ shared_ptr ç¦»å¼€ä½œç”¨åŸŸæ—¶(æ­¤å¤„ä¸ºè„±ç¦»ä½œç”¨åŸŸæ—¶)ï¼Œä¼šè°ƒç”¨ CloseFileå‡½æ•°æ¥è‡ªåŠ¨å…³é—­æ–‡ä»¶æŒ‡é’ˆã€‚å›é¡¾ä¸€ä¸‹ï¼ŒC++ä¸­æœ‰å¯ä»¥æ“ä½œæ–‡ä»¶çš„é¢å‘å¯¹è±¡çš„ç±»ã€‚è¿™äº›ç±»åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ã€‚\nvoid CloseFile(FILE* filePtr) { if (filePtr==nullptr) return; fclose(filePtr); cout \u003c\u003c\"File closed.\" \u003c\u003c endl; } int main() { FILE* f = fopen(\"data.txt\", uw\"); // è‡ªå®šä¹‰deleter shared ptr\u003cFILE\u003e filePtr(f, CloseFile); if (filePtr== nullptr) { cerr \u003c\u003c \"Error opening file.\" \u003c\u003c endl; } else { cout \u003c\u003c\"File opened.\" \u003c\u003c endl; } //Use filePtr return 0; } åŒé‡åˆ é™¤çš„é—®é¢˜ å¦‚æœè¦åˆ›å»ºä¸¤ä¸ªæ ‡å‡†çš„ shared_ptrï¼Œå¹¶ä½¿å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ª Simple å¯¹è±¡ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨é”€æ¯æ—¶ï¼Œä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå°†å°è¯•åˆ é™¤åŒä¸€ä¸ªå¯¹è±¡:\nvoid doubleDelete() { Simple*mySimple=new Simple(); shared ptr\u003cSimple\u003e smartPtrl(mySimple); shared ptr\u003cSimple\u003e smartPtr2(mySimple); } æ ¹æ®ç¼–è¯‘å™¨ï¼Œè¿™æ®µä»£ç å¯èƒ½ä¼šå´©æºƒ!å¦‚æœå¾—åˆ°äº†è¾“å‡ºï¼Œåˆ™è¾“å‡ºä¸º: Simple constructor called! Simple destructor called! Simple destructor called åªè°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œå´è°ƒç”¨ä¸¤æ¬¡ææ„å‡½æ•°?ä½¿ç”¨ unique ptr ä¹Ÿä¼šå‡ºç°åŒæ ·çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œæ ¹æ® C+æ ‡å‡†ï¼Œè¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºã€‚ä¸åº”è¯¥åƒä»¥ä¸Š doubleDeleteå‡½æ•°é‚£æ ·åˆ›å»ºä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡çš„ shared_ptrï¼Œè€Œæ˜¯åº”è¯¥å»ºç«‹å‰¯æœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤º:\nvoid noDoubleDelete() { auto smartPtr1 = make_shared\u003cSimple\u003e(); shared ptr\u003cSimple\u003e smartPtr2(smartPtrl); } è¿™æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º: Simple constructor called! Simple destructor called! å³ä½¿æœ‰ä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªSimpleå¯¹è±¡çš„shared_ptrï¼ŒSimpleå¯¹è±¡ä¹Ÿåªé”€æ¯ä¸€æ¬¡ã€‚\nweak_ptr weak_ptr å¯åŒ…å«ç”± shared_ptr ç®¡ç†çš„èµ„æºçš„å¼•ç”¨ã€‚weak_ptr ä¸æ‹¥æœ‰è¿™ä¸ªèµ„æºï¼Œæ‰€ä»¥ä¸èƒ½é˜»æ­¢ shared_ptr é‡Šæ”¾èµ„æºã€‚weak_ptr é”€æ¯æ—¶(ä¾‹å¦‚ç¦»å¼€ä½œç”¨åŸŸæ—¶)ä¸ä¼šé”€æ¯å®ƒæŒ‡å‘çš„èµ„æº: ç„¶è€Œï¼Œå®ƒå¯ç”¨äºåˆ¤æ–­èµ„æºæ˜¯å¦å·²ç»è¢«å…³è”çš„ shared_ptr é‡Šæ”¾äº†ã€‚\nweak_ptr çš„æ„é€ å‡½æ•°è¦æ±‚å°†ä¸€ä¸ª shared_ptr æˆ–å¦ä¸€ä¸ª weak_ptr ä½œä¸ºå‚æ•°ã€‚\nä¸ºäº†è®¿é—® weak_ptr ä¸­ä¿å­˜çš„æŒ‡é’ˆï¼Œéœ€è¦å°† weak_ptr è½¬æ¢ä¸ºshared_ptrã€‚æœ‰ä¸¤ç§æ–¹æ³•: ä½¿ç”¨ weak_ptr å®ä¾‹çš„ lockæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª shared_ptrã€‚å¦‚æœåŒæ—¶é‡Šæ”¾äº†ä¸ weak_ptr å…³è”çš„shared_ptrï¼Œè¿”å›çš„shared_ptr æ˜¯nullptr åˆ›å»ºä¸€ä¸ªæ–°çš„ shared_ptr å®ä¾‹ï¼Œå°† weak_ptr ä½œä¸º shared_ptr é€ å‡½æ•°çš„å‚æ•°ã€‚å¦‚æœé‡Šæ”¾äº†ä¸ weak_ptrå…³è”çš„shared_ptrï¼Œå°†æŠ›å‡ºstd::bad weak_ptr å¼‚å¸¸ã€‚\nvoid useResource(weak ptr\u003cSimple\u003e\u0026 weakSimple) { auto resource = weakSimple.lock(); if (resource) { cout \u003c\u003c\"Resource still alive.\" \u003c\u003c endl; }else cout \u003c\u003c\"Resource has been freed!\" \u003c\u003c endl; } int main() { auto sharedSimple = make_shared\u003cSimple\u003e(); weak_ptr\u003cSimple\u003e weakSimple(sharedSimple); // Try to use the weak ptr. useResource(weakSimple); // Reset the shared ptr. // Since there is only 1 shared ptr to the Simple resource, this will free the resource, even though there is still a weak ptr alive. sharedSimple.reset(); // Try touse the weak ptr a second time. useResource(weakSimple); return 0; } ä¸Šè¿°ä»£ç çš„è¾“å‡ºå¦‚ä¸‹: Simple constructor called! Resource still alive. Simple destructor called! Resource has been freed!\nmove 1.å³å€¼å¼•ç”¨ å·¦å€¼(value)æ˜¯å¯è·å–å…¶åœ°å€çš„ä¸€ä¸ªé‡ï¼Œä¾‹å¦‚ä¸€ä¸ªæœ‰åç§°çš„å˜é‡ã€‚ç”±äºç»å¸¸å‡ºç°åœ¨èµ‹å€¼è¯­å¥çš„å·¦è¾¹ï¼Œå› æ­¤å°†å…¶ç§°ä½œå·¦å€¼ã€‚å¦å¤–ï¼Œæ‰€æœ‰ä¸æ˜¯å·¦å€¼çš„é‡éƒ½æ˜¯å³å€¼(rvalue)ï¼Œä¾‹å¦‚å­—é¢é‡ã€ä¸´æ—¶å¯¹è±¡æˆ–ä¸´æ—¶å€¼ã€‚é€šå¸¸å³å€¼ä½äºèµ‹å€¼è¿ç®—ç¬¦çš„å³è¾¹ã€‚ int a=4 * 2; åœ¨è¿™æ¡è¯­å¥ä¸­ï¼Œa æ˜¯å·¦å€¼ï¼Œå®ƒå…·æœ‰åç§°ï¼Œå®ƒçš„åœ°å€ä¸º\u0026aã€‚å³ä¾§è¡¨è¾¾å¼4*2 çš„ç»“æœæ˜¯å³å€¼ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶å€¼,å°†åœ¨è¯­å¥æ‰§è¡Œå®Œæ¯•æ—¶é”€æ¯ã€‚ å³å€¼å¼•ç”¨æ˜¯ä¸€ä¸ªå¯¹å³å€¼(rvalue)çš„å¼•ç”¨ã€‚ç‰¹åˆ«åœ°ï¼Œè¿™æ˜¯ä¸€ä¸ªå½“å³å€¼æ˜¯ä¸´æ—¶å¯¹è±¡æ—¶æ‰é€‚ç”¨çš„æ¦‚å¿µã€‚å³å€¼å¼•ç”¨å…è®¸å¼€å‘è€…æ•è·å°†è¦é”€æ¯çš„ä¸´æ—¶å¯¹è±¡ï¼Œå¹¶å¯¹å…¶èµ„æºè¿›è¡Œé‡æ–°åˆ©ç”¨ã€‚\nå³å€¼å¼•ç”¨çš„ç›®çš„æ˜¯åœ¨æ¶‰åŠä¸´æ—¶å¯¹è±¡æ—¶æä¾›å¯é€‰ç”¨çš„ç‰¹å®šå‡½æ•°ã€‚ç”±äºçŸ¥é“ä¸´æ—¶å¯¹è±¡ä¼šè¢«é”€æ¯ï¼Œé€šè¿‡å³å€¼å¼•ç”¨ï¼ŒæŸäº›æ¶‰åŠå¤åˆ¶å¤§é‡å€¼çš„æ“ä½œå¯é€šè¿‡ç®€å•åœ°å¤åˆ¶æŒ‡å‘è¿™äº›å€¼çš„æŒ‡é’ˆæ¥å®ç°ã€‚\nå‡½æ•°å¯å°†\u0026\u0026ä½œä¸ºå‚æ•°è¯´æ˜çš„ä¸€éƒ¨åˆ†(ä¾‹å¦‚ type\u0026\u0026name),ä»¥æŒ‡å®šå³å€¼å¼•ç”¨å‚æ•°ã€‚é€šå¸¸,ä¸´æ—¶å¯¹è±¡è¢«å½“ä½œ const type\u0026ï¼Œä½†å½“å‡½æ•°é‡è½½ä½¿ç”¨äº†å³å€¼å¼•ç”¨æ—¶ï¼Œå¯ä»¥è§£æä¸´æ—¶å¯¹è±¡ï¼Œç”¨äºè¯¥å‡½æ•°é‡è½½ã€‚\nstd::string str1 = \"Hello\"; std::string str2 = std::move(str1); // str1 çš„å†…å®¹è¢«ç§»åŠ¨åˆ° str2ï¼Œè€Œä¸æ˜¯å¤åˆ¶ std::move å°† str1 è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œä»è€Œè§¦å‘ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå°† str1 çš„å†…éƒ¨æ•°æ®ç›´æ¥è½¬ç§»ç»™ str2ï¼Œé¿å…äº†æ·±åº¦å¤åˆ¶ã€‚\nå‡è®¾æœ‰ä¸€ä¸ªç±» LargeDataï¼Œå®ƒåŒ…å«å¤§é‡çš„æ•°æ®ï¼š\nclass LargeData { public: LargeData() { data = new int[1000000]; // å¤§é‡æ•°æ® } ~LargeData() { delete[] data; } LargeData(const LargeData\u0026 other) { // æ‹·è´æ„é€ å‡½æ•° data = new int[1000000]; std::copy(other.data, other.data + 1000000, data); } LargeData(LargeData\u0026\u0026 other) noexcept { // ç§»åŠ¨æ„é€ å‡½æ•° data = other.data; other.data = nullptr; // å°†æºå¯¹è±¡çš„æŒ‡é’ˆç½®ç©º } private: int* data; }; åœ¨è¿™é‡Œï¼Œç§»åŠ¨æ„é€ å‡½æ•°é€šè¿‡ç®€å•åœ°å¤åˆ¶æŒ‡é’ˆ dataï¼Œè€Œä¸æ˜¯å¤åˆ¶æ•´ä¸ªæ•°æ®æ•°ç»„ï¼Œå®ç°äº†é«˜æ•ˆçš„èµ„æºè½¬ç§»ã€‚\nLargeData createLargeData() { return LargeData(); } int main() { LargeData ld = createLargeData(); // ç§»åŠ¨æ„é€ ï¼Œä¸æ˜¯æ‹·è´ return 0; } åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒcreateLargeData è¿”å›ä¸€ä¸ªä¸´æ—¶çš„ LargeData å¯¹è±¡ï¼Œé€šè¿‡å³å€¼å¼•ç”¨å’Œç§»åŠ¨è¯­ä¹‰ï¼Œä¸´æ—¶å¯¹è±¡çš„èµ„æºè¢«é«˜æ•ˆåœ°ç§»åŠ¨åˆ° ldï¼Œé¿å…äº†å¤§é‡æ•°æ®çš„å¤åˆ¶æ“ä½œã€‚\nstd::moveå¯å°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼ï¼Œå¼ºè¿«ç¼–è¯‘å™¨è°ƒç”¨ handleMessageå‡½æ•°çš„å³å€¼å¼•ç”¨ç‰ˆæœ¬\nhandleMessage(std::move(b)); // Calls handleMessage(string\u0026\u0026 value) å› ä¸ºæœ‰åç§°çš„å˜é‡æ˜¯å·¦å€¼ã€‚å› æ­¤ï¼Œåœ¨ handleMessageå‡½æ•°ä¸­ï¼Œå³å€¼å¼•ç”¨å‚æ•° message æœ¬èº«æ˜¯ä¸€ä¸ªå·¦å€¼ï¼ŒåŸå› æ˜¯å®ƒå…·æœ‰åç§°! å¦‚æœå¸Œæœ›å°†è¿™ä¸ªå·¦å€¼å¼•ç”¨å‚æ•°ï¼Œä½œä¸ºå³å€¼ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™éœ€è¦ä½¿ç”¨ std:moveå°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼ã€‚ä¾‹å¦‚ï¼Œå‡è®¾è¦æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼Œä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°:\nvoid helper(std::string\u0026\u0026 message) å¦‚æœæŒ‰å¦‚ä¸‹æ–¹å¼è°ƒç”¨ï¼Œåˆ™æ— æ³•ç¼–è¯‘:\nvoid handleMessage(std::string\u0026\u0026 message) { helper(message); } helperå‡½æ•°éœ€è¦å³å€¼å¼•ç”¨ï¼Œè€Œ handleMessageå‡½æ•°ä¼ é€’ messageï¼Œmessage å…·æœ‰åç§°ï¼Œæ˜¯å·¦å€¼ï¼Œå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯ä½¿ç”¨std::move():\nvoid handleMessaqe(std::string\u0026\u0026 message) { helper(std::move(message)) ; } std::move çš„è¿”å›çš„æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚\nstd::move å¹¶ä¸çœŸçš„â€œç§»åŠ¨â€å¯¹è±¡ï¼Œè€Œæ˜¯å°†ä¸€ä¸ªå·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œå…è®¸è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚\nMyClass b(std::move(a)); std::move(a) å°† a è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œè§¦å‘ MyClass çš„ç§»åŠ¨æ„é€ å‡½æ•°ã€‚\né”™è¯¯ï¼š\nMyClass a(\"Hello\"); MyClass\u0026\u0026 r = std::move(a); // å³å€¼å¼•ç”¨èµ‹ç»™å³å€¼å¼•ç”¨å˜é‡ rï¼Œä½† r ä½œä¸ºå˜é‡åï¼Œæ˜¯ä¸€ä¸ªå·¦å€¼ã€‚ MyClass b(r); // é”™è¯¯ï¼šè°ƒç”¨çš„æ˜¯å¤åˆ¶æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯ç§»åŠ¨æ„é€ å‡½æ•° è™½ç„¶ r æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼Œä½†æ˜¯ r ä½œä¸ºä¸€ä¸ªå…·åå˜é‡æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå› æ­¤ MyClass b(r); è°ƒç”¨äº†å¤åˆ¶æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯ç§»åŠ¨æ„é€ å‡½æ•°ã€‚\n",
  "wordCount" : "702",
  "inLanguage": "en",
  "image":"http://localhost:1313/%3Cimage%20path/url%3E","datePublished": "2024-03-12T15:12:01+08:00",
  "dateModified": "2024-03-12T15:12:01+08:00",
  "author":{
    "@type": "Person",
    "name": "Me"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Cookie's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/%3Clink%20/%20abs%20url%3E"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Home (Alt + H)">Home</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives/" title="â±archives">
                    <span>â±archives</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="ğŸ”Search">
                    <span>ğŸ”Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="ğŸ”–Tags">
                    <span>ğŸ”–Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;Â»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title">
      æ™ºèƒ½æŒ‡é’ˆ
    </h1>
    <div class="post-description">
      c&#43;&#43;ä¸­çš„æ™ºèƒ½æŒ‡é’ˆ
    </div>
    <div class="post-meta">&lt;span title=&#39;2024-03-12 15:12:01 &#43;0800 CST&#39;&gt;2024-03-12&lt;/span&gt;&amp;nbsp;Â·&amp;nbsp;4 min&amp;nbsp;Â·&amp;nbsp;702 words&amp;nbsp;Â·&amp;nbsp;Me&nbsp;|&nbsp;<a href="https://github.com/Dueplay/blog/content/posts/%e6%99%ba%e8%83%bd%e6%8c%87%e9%92%88.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#unique_ptr">unique_ptr</a></li>
    <li><a href="#shared_ptr">shared_ptr</a></li>
    <li><a href="#weak_ptr">weak_ptr</a></li>
    <li><a href="#move">move</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="unique_ptr">unique_ptr<a hidden class="anchor" aria-hidden="true" href="#unique_ptr">#</a></h2>
<p>è€ƒè™‘ä¸‹é¢çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨å †ä¸Šåˆ†é…äº†ä¸€ä¸ª Simple å¯¹è±¡ï¼Œä½†æ˜¯ä¸é‡Šæ”¾è¿™ä¸ªå¯¹è±¡ï¼Œæ•…æ„äº§ç”Ÿå†…å­˜æ³„æ¼ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">leaky</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Simple</span><span class="o">*</span> <span class="n">mySimplePtr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Simple</span><span class="p">();</span> <span class="c1">// BUG! Memory is never released!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">mySimplePtr</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æœ‰æ—¶ä½ å¯èƒ½è®¤ä¸ºï¼Œä»£ç æ­£ç¡®åœ°é‡Šæ”¾äº†åŠ¨æ€åˆ†é…çš„å†…å­˜ã€‚é—æ†¾çš„æ˜¯ï¼Œè¿™ç§æƒ³æ³•å‡ ä¹æ€»æ˜¯ä¸æ­£ç¡®çš„ã€‚æ¯”å¦‚è¿™ä¸ªå‡½æ•°:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">couldBeLeaky</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Simple</span><span class="o">*</span><span class="n">mySimplePtr</span> <span class="o">=</span><span class="k">new</span> <span class="n">Simple</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">mySimplePtr</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">delete</span> <span class="n">mySimplePtr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šé¢çš„å‡½æ•°åŠ¨æ€åˆ†é…ä¸€ä¸ª Simple å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡ï¼Œç„¶åæ­£ç¡®åœ°è°ƒç”¨ deleteã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªä¾‹å­ä»ç„¶å¯èƒ½äº§ç”Ÿå†…å­˜æ³„æ¼! <strong>å¦‚æœ goæ–¹æ³•æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå°†æ°¸è¿œä¸ä¼šè°ƒç”¨ deleteï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</strong></p>
<p>è¿™ä¸¤ç§æƒ…å†µä¸‹åº”ä½¿ç”¨ unique_ptrã€‚å¯¹è±¡ä¸ä¼šæ˜¾å¼åˆ é™¤ï¼Œä½†å®ä¾‹ unique_ptrç¦»å¼€ä½œç”¨åŸŸæ—¶(åœ¨å‡½æ•°çš„æœ«å°¾ï¼Œæˆ–è€…å› ä¸ºæŠ›å‡ºäº†å¼‚å¸¸)ï¼Œå°±ä¼šåœ¨å…¶ææ„å‡½æ•°ä¸­è‡ªåŠ¨é‡Šæ”¾ Simple å¯¹è±¡:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">notLeaky</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">mySimpleSmartPtr</span> <span class="o">=</span><span class="n">make</span> <span class="n">unique</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">mySimpleSmartPtr</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç ä½¿ç”¨ C++14 ä¸­çš„ make_uniqueå’Œ auto å…³é”®å­—ï¼Œæ‰€ä»¥åªéœ€è¦æŒ‡å®šæŒ‡é’ˆçš„ç±»å‹ï¼Œæœ¬ä¾‹ä¸­æ˜¯ Simple,å¦‚æœSimpleæ„é€ å‡½æ•°éœ€è¦å‚æ•°ï¼Œå°±æŠŠå®ƒä»¬æ”¾åœ¨make_unique()è°ƒç”¨çš„åœ†æ‹¬å·ä¸­ã€‚</p>
<p>å¦‚æœç¼–è¯‘å™¨ä¸æ”¯æŒmake_unique, å¯ä»¥è¿™ç§æ–¹å¼åˆ›å»ºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">Simple</span><span class="p">());</span>
</span></span></code></pre></div><p>åƒæ ‡å‡†æŒ‡é’ˆä¸€æ ·ï¼Œä»å¯ä»¥ä½¿ç”¨*æˆ–-&gt;å¯¹æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œè§£å¼•ç”¨ã€‚</p>
<p>get()æ–¹æ³•å¯ç”¨äºç›´æ¥è®¿é—®åº•å±‚æŒ‡é’ˆã€‚è¿™å¯å°†æŒ‡é’ˆä¼ é€’ç»™éœ€è¦æ™®é€šæŒ‡é’ˆçš„å‡½æ•°ã€‚ä¾‹å¦‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">processData</span><span class="p">(</span><span class="n">Simple</span><span class="o">*</span> <span class="n">simple</span><span class="p">)(</span> <span class="cm">/* Use the simple pointer...*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å¯é‡‡ç”¨å¦‚ä¸‹æ–¹å¼è¿›è¡Œè°ƒç”¨:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">mySimpleSmartPtr</span> <span class="o">=</span> <span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">processData</span><span class="p">(</span><span class="n">mySimpleSmartPtr</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span></code></pre></div><p>å¯é‡Šæ”¾unique_ptr çš„åº•å±‚æŒ‡é’ˆï¼Œå¹¶ä½¿ç”¨reset()æ ¹æ®éœ€è¦å°†å…¶æ”¹æˆå¦ä¸€ä¸ªæŒ‡é’ˆã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">mySimpleSmartPtr</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Free resource and set to nullptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">mySimpleSmartPtr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">Simple</span><span class="p">());</span> <span class="c1">// Free resource and set to a new Simple instance
</span></span></span></code></pre></div><p>å¯ä½¿ç”¨ release()æ–­å¼€ unique_ptr ä¸åº•å±‚æŒ‡é’ˆçš„è¿æ¥ã€‚releaseæ–¹æ³•è¿”å›èµ„æºçš„åº•å±‚æŒ‡é’ˆï¼Œç„¶åå°†æ™ºèƒ½æŒ‡é’ˆè®¾
ä¸º nullptrã€‚å®é™…ä¸Šï¼Œæ™ºèƒ½æŒ‡é’ˆå¤±å»å¯¹èµ„æºçš„æ‰€æœ‰æƒï¼Œè´Ÿè´£åœ¨ä½ ç”¨å®Œèµ„æºæ—¶é‡Šæ”¾èµ„æºã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">Simple</span><span class="o">*</span> <span class="n">simple</span><span class="o">=</span> <span class="n">mySimpleSmartPtr</span><span class="p">.</span><span class="n">release</span><span class="p">();</span><span class="c1">// Release ownership
</span></span></span><span class="line"><span class="cl"><span class="c1">//Use the simple pointer...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">delete</span> <span class="n">simple</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">simple</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span></code></pre></div><p>ç”±äº unique_pträ»£è¡¨å”¯ä¸€æ‹¥æœ‰æƒï¼Œå› æ­¤æ— æ³•å¤åˆ¶å®ƒ!ä½¿ç”¨ std::move() ç§»åŠ¨è¯­ä¹‰å°†ä¸€ä¸ªunique_ptr ç§»åˆ°å¦ä¸€ä¸ªã€‚è¿™ç”¨äºæ˜¾å¼ç§»åŠ¨æ‰€æœ‰æƒã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Foo</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">Foo</span><span class="p">(</span><span class="n">unique</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">)</span> <span class="o">:</span> <span class="n">mData</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="n">mData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">myIntSmartPtr</span> <span class="o">=</span> <span class="n">make</span> <span class="n">unique</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Foo</span> <span class="nf">f</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">myIntSmartPtr</span><span class="p">));</span> 
</span></span></code></pre></div><p>unique_ptr é€‚ç”¨äºå­˜å‚¨åŠ¨æ€åˆ†é…çš„æ—§å¼C é£æ ¼æ•°ç»„ã€‚ä¸‹ä¾‹åˆ›å»ºäº†ä¸€ä¸ª unique_ptr æ¥ä¿å­˜åŠ¨æ€åˆ†é…çš„ã€åŒ…å«10ä¸ªæ•´æ•°çš„Cé£æ ¼æ•°ç»„:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">myVariableSizedArray</span> <span class="o">=</span> <span class="n">make_unique</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span></code></pre></div><p>è‡ªå®šä¹‰ deleter
é»˜è®¤æƒ…å†µä¸‹ï¼Œunique_ptr ä½¿ç”¨æ ‡å‡†çš„new å’Œdeleteè¿ç®—ç¬¦æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜ã€‚å¯å°†æ­¤è¡Œä¸ºæ”¹æˆ:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span><span class="o">*</span> <span class="nf">malloc_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="o">*</span><span class="n">p</span><span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">p</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unique</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="err">ï¼Œ</span><span class="k">decltype</span><span class="p">(</span><span class="n">free</span><span class="p">)</span><span class="o">*&gt;</span> 			<span class="n">myIntSmartPtr</span><span class="p">(</span><span class="n">malloc_int</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="err">ï¼Œ</span><span class="n">free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç ä½¿ç”¨ malloc_int()ç»™æ•´æ•°åˆ†é…å†…å­˜ã€‚unique_ptr è°ƒç”¨æ ‡å‡†çš„ freeå‡½æ•°æ¥é‡Šæ”¾å†…å­˜ã€‚å¦‚å‰æ‰€è¿°, åœ¨C++ä¸­ä¸åº”è¯¥ä½¿ç”¨ mallocï¼Œè€Œåº”æ”¹ç”¨ newã€‚ç„¶è€Œï¼Œunique_ptr çš„è¿™é¡¹ç‰¹æ€§æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºè¿˜å¯ç®¡ç†å…¶ä»–ç±»å‹çš„èµ„æºè€Œä¸ä»…æ˜¯å†…å­˜ã€‚ä¾‹å¦‚ï¼Œ<strong>å½“ unique_ptr ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå¯è‡ªåŠ¨å…³é—­æ–‡ä»¶æˆ–ç½‘ç»œå¥—æ¥å­—ä»¥åŠå…¶ä»–ä»»ä½•èµ„æºã€‚</strong>
ä½†æ˜¯ï¼Œunique_ptr çš„è‡ªå®šä¹‰ deleter çš„è¯­æ³•æœ‰äº›è´¹è§£ã€‚éœ€è¦å°†è‡ªå®šä¹‰ deleter çš„ç±»å‹æŒ‡å®šä¸ºæ¨¡æ¿ç±»å‹å‚æ•°. decltype(free)ç”¨äºè¿”å› free()ç±»å‹ã€‚æ¨¡æ¿ç±»å‹å‚æ•°åº”å½“æ˜¯å‡½æ•°æŒ‡é’ˆçš„ç±»å‹ï¼Œå› æ­¤å¦å¤–é™„åŠ ä¸€ä¸ª*ï¼Œå¦‚<code>decltype(free)*</code></p>
<h2 id="shared_ptr">shared_ptr<a hidden class="anchor" aria-hidden="true" href="#shared_ptr">#</a></h2>
<p>shared_ptr çš„ç”¨æ³•ä¸ unique_ptr ç±»ä¼¼ã€‚è¦åˆ›å»º shared_ptrï¼Œå¯ä½¿ç”¨ make_shared()ï¼Œå®ƒæ¯”ç›´æ¥åˆ›å»º shared_ptræ›´é«˜æ•ˆã€‚</p>
<p>æ›´é«˜æ•ˆåŸå› ï¼š</p>
<p>å½“ä½¿ç”¨ <code>std::make_shared</code> åˆ›å»º <code>shared_ptr</code> æ—¶ï¼Œæ‰€æœ‰éœ€è¦çš„å†…å­˜ï¼ˆåŒ…æ‹¬å¯¹è±¡æœ¬èº«å’Œæ§åˆ¶å—ï¼‰åœ¨ä¸€æ¬¡åˆ†é…ä¸­å®Œæˆã€‚è¿™å‡å°‘äº†å†…å­˜åˆ†é…çš„æ¬¡æ•°ï¼Œä»è€Œæé«˜äº†æ•ˆç‡ã€‚</p>
<p>è€Œç›´æ¥ä½¿ç”¨ <code>std::shared_ptr</code> æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡é€šå¸¸éœ€è¦ä¸¤æ¬¡å†…å­˜åˆ†é…ï¼Œä¸€æ¬¡ç”¨äºå¯¹è±¡æœ¬èº«ï¼Œä¸€æ¬¡ç”¨äºæ§åˆ¶å—ã€‚</p>
<p>åœ¨ç›´æ¥ä½¿ç”¨ <code>new</code> çš„æƒ…å†µä¸‹ï¼Œåœ¨å¯¹è±¡æ„é€ å’Œæ§åˆ¶å—åˆ†é…ä¹‹é—´ï¼Œå¦‚æœå¯¹è±¡æ„é€ æŠ›å‡ºå¼‚å¸¸ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚è€Œ <code>std::make_shared</code> åœ¨åˆ†é…å’Œæ„é€ å¯¹è±¡çš„è¿‡ç¨‹ä¸­æ˜¯å¼‚å¸¸å®‰å…¨çš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">mySimpleSmartPtr</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="k">new</span> <span class="n">Simple</span><span class="p">());</span>
</span></span></code></pre></div><p>ä¸unique_ptr ä¸€æ ·ï¼Œshared_ptr ä¹Ÿæ”¯æŒ getå’Œresetæ–¹æ³•ã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼Œå½“è°ƒç”¨ resetæ—¶ï¼Œç”±äºå¼•ç”¨è®¡æ•°ï¼Œä»…åœ¨æœ€åçš„ shared_ptré”€æ¯æˆ–é‡ç½®æ—¶,æ‰é‡Šæ”¾åº•å±‚èµ„æºã€‚æ³¨æ„,shared ptr ä¸æ”¯æŒ releaseã€‚å¯ä½¿ç”¨use count()æ¥æ£€ç´¢å…±äº«åŒä¸€èµ„æºçš„shared_ptr å®ä¾‹æ•°é‡ã€‚</p>
<p>ä¸ unique_ptr ç±»ä¼¼ï¼Œshared_ptr é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨æ ‡å‡†çš„ new å’Œ delete è¿ç®—ç¬¦æ¥åˆ†é…å’Œé‡Šæ”¾å†…å­˜;åœ¨ C++17
ä¸­å­˜å‚¨Cé£æ ¼æ•°ç»„æ—¶ï¼Œä½¿ç”¨ new[]å’Œ delete[]ã€‚å¯æ›´æ”¹æ­¤è¡Œä¸º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">myIntSmartPtr</span><span class="p">(</span><span class="n">malloc_int</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="err">ï¼Œ</span> <span class="n">free</span><span class="p">);</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸å¿…å°†<strong>è‡ªå®šä¹‰ deleter çš„ç±»å‹æŒ‡å®šä¸ºæ¨¡æ¿ç±»å‹å‚æ•°</strong>ï¼Œè¿™æ¯” unique_ptr çš„è‡ªå®šä¹‰ deleter æ›´ç®€ä¾¿ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨ shared_ptr å­˜å‚¨æ–‡ä»¶æŒ‡é’ˆã€‚å½“ shared_ptr ç¦»å¼€ä½œç”¨åŸŸæ—¶(æ­¤å¤„ä¸ºè„±ç¦»ä½œç”¨åŸŸæ—¶)ï¼Œä¼šè°ƒç”¨
CloseFileå‡½æ•°æ¥è‡ªåŠ¨å…³é—­æ–‡ä»¶æŒ‡é’ˆã€‚å›é¡¾ä¸€ä¸‹ï¼ŒC++ä¸­æœ‰å¯ä»¥æ“ä½œæ–‡ä»¶çš„é¢å‘å¯¹è±¡çš„ç±»ã€‚è¿™äº›ç±»åœ¨ç¦»å¼€ä½œç”¨åŸŸæ—¶ä¼šè‡ªåŠ¨å…³é—­æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">CloseFile</span><span class="p">(</span><span class="n">FILE</span><span class="o">*</span> <span class="n">filePtr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">filePtr</span><span class="o">==</span><span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">filePtr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">cout</span> <span class="o">&lt;&lt;</span><span class="s">&#34;File closed.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;data.txt&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">uw</span><span class="s">&#34;);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è‡ªå®šä¹‰deleter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">shared</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="n">FILE</span><span class="o">&gt;</span> <span class="n">filePtr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">CloseFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">filePtr</span><span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Error opening file.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">cout</span> <span class="o">&lt;&lt;</span><span class="s">&#34;File opened.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Use filePtr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åŒé‡åˆ é™¤çš„é—®é¢˜
å¦‚æœè¦åˆ›å»ºä¸¤ä¸ªæ ‡å‡†çš„ shared_ptrï¼Œå¹¶ä½¿å®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ª Simple å¯¹è±¡ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨é”€æ¯æ—¶ï¼Œä¸¤ä¸ªæ™ºèƒ½æŒ‡é’ˆå°†å°è¯•åˆ é™¤åŒä¸€ä¸ªå¯¹è±¡:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">doubleDelete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Simple</span><span class="o">*</span><span class="n">mySimple</span><span class="o">=</span><span class="k">new</span> <span class="n">Simple</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">shared</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">smartPtrl</span><span class="p">(</span><span class="n">mySimple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">shared</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">smartPtr2</span><span class="p">(</span><span class="n">mySimple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>æ ¹æ®ç¼–è¯‘å™¨ï¼Œè¿™æ®µä»£ç å¯èƒ½ä¼šå´©æºƒ!å¦‚æœå¾—åˆ°äº†è¾“å‡ºï¼Œåˆ™è¾“å‡ºä¸º:
Simple constructor called!
Simple destructor called!
Simple destructor called
åªè°ƒç”¨ä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œå´è°ƒç”¨ä¸¤æ¬¡ææ„å‡½æ•°?ä½¿ç”¨ unique ptr ä¹Ÿä¼šå‡ºç°åŒæ ·çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œæ ¹æ® C+æ ‡å‡†ï¼Œè¿™æ˜¯æ­£ç¡®çš„è¡Œä¸ºã€‚ä¸åº”è¯¥åƒä»¥ä¸Š doubleDeleteå‡½æ•°é‚£æ ·<strong>åˆ›å»ºä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡çš„ shared_ptrï¼Œè€Œæ˜¯åº”è¯¥å»ºç«‹å‰¯æœ¬</strong>ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">noDoubleDelete</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">smartPtr1</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">shared</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">smartPtr2</span><span class="p">(</span><span class="n">smartPtrl</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç çš„è¾“å‡ºå¦‚ä¸‹æ‰€ç¤º:
Simple constructor called!
Simple destructor called!
å³ä½¿æœ‰ä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªSimpleå¯¹è±¡çš„shared_ptrï¼ŒSimpleå¯¹è±¡ä¹Ÿåªé”€æ¯ä¸€æ¬¡ã€‚</p>
<h2 id="weak_ptr">weak_ptr<a hidden class="anchor" aria-hidden="true" href="#weak_ptr">#</a></h2>
<p>weak_ptr å¯åŒ…å«ç”± shared_ptr ç®¡ç†çš„èµ„æºçš„å¼•ç”¨ã€‚weak_ptr ä¸æ‹¥æœ‰è¿™ä¸ªèµ„æºï¼Œæ‰€ä»¥ä¸èƒ½é˜»æ­¢ shared_ptr é‡Šæ”¾èµ„æºã€‚weak_ptr é”€æ¯æ—¶(ä¾‹å¦‚ç¦»å¼€ä½œç”¨åŸŸæ—¶)ä¸ä¼šé”€æ¯å®ƒæŒ‡å‘çš„èµ„æº: ç„¶è€Œï¼Œå®ƒå¯ç”¨äºåˆ¤æ–­èµ„æºæ˜¯å¦å·²ç»è¢«å…³è”çš„ shared_ptr é‡Šæ”¾äº†ã€‚</p>
<p>weak_ptr çš„æ„é€ å‡½æ•°è¦æ±‚å°†ä¸€ä¸ª shared_ptr æˆ–å¦ä¸€ä¸ª weak_ptr ä½œä¸ºå‚æ•°ã€‚</p>
<p>ä¸ºäº†è®¿é—® weak_ptr ä¸­ä¿å­˜çš„æŒ‡é’ˆï¼Œéœ€è¦å°† weak_ptr è½¬æ¢ä¸ºshared_ptrã€‚æœ‰ä¸¤ç§æ–¹æ³•:
ä½¿ç”¨ weak_ptr å®ä¾‹çš„ lockæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª shared_ptrã€‚å¦‚æœåŒæ—¶é‡Šæ”¾äº†ä¸ weak_ptr å…³è”çš„shared_ptrï¼Œè¿”å›çš„shared_ptr æ˜¯nullptr
åˆ›å»ºä¸€ä¸ªæ–°çš„ shared_ptr å®ä¾‹ï¼Œå°† weak_ptr ä½œä¸º shared_ptr é€ å‡½æ•°çš„å‚æ•°ã€‚å¦‚æœé‡Šæ”¾äº†ä¸ weak_ptrå…³è”çš„shared_ptrï¼Œå°†æŠ›å‡ºstd::bad weak_ptr å¼‚å¸¸ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">useResource</span><span class="p">(</span><span class="n">weak</span> <span class="n">ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;&amp;</span> <span class="n">weakSimple</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">weakSimple</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">resource</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    	<span class="n">cout</span> <span class="o">&lt;&lt;</span><span class="s">&#34;Resource still alive.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span><span class="k">else</span> 
</span></span><span class="line"><span class="cl">    	<span class="n">cout</span> <span class="o">&lt;&lt;</span><span class="s">&#34;Resource has been freed!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">sharedSimple</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">weak_ptr</span><span class="o">&lt;</span><span class="n">Simple</span><span class="o">&gt;</span> <span class="n">weakSimple</span><span class="p">(</span><span class="n">sharedSimple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to use the weak ptr.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">useResource</span><span class="p">(</span><span class="n">weakSimple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Reset the shared ptr.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Since there is only 1 shared ptr to the Simple resource, this will free the resource, even though there is still a weak ptr alive.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sharedSimple</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try touse the weak ptr a second time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">useResource</span><span class="p">(</span><span class="n">weakSimple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ä¸Šè¿°ä»£ç çš„è¾“å‡ºå¦‚ä¸‹:
Simple constructor called!
Resource still alive.
Simple destructor called!
Resource has been freed!</p>
<h2 id="move">move<a hidden class="anchor" aria-hidden="true" href="#move">#</a></h2>
<p>1.å³å€¼å¼•ç”¨
<strong>å·¦å€¼(value)æ˜¯å¯è·å–å…¶åœ°å€çš„ä¸€ä¸ªé‡</strong>ï¼Œä¾‹å¦‚ä¸€ä¸ªæœ‰åç§°çš„å˜é‡ã€‚ç”±äºç»å¸¸å‡ºç°åœ¨èµ‹å€¼è¯­å¥çš„å·¦è¾¹ï¼Œå› æ­¤å°†å…¶ç§°ä½œå·¦å€¼ã€‚å¦å¤–ï¼Œ<strong>æ‰€æœ‰ä¸æ˜¯å·¦å€¼çš„é‡éƒ½æ˜¯å³å€¼(rvalue)</strong>ï¼Œä¾‹å¦‚<strong>å­—é¢é‡ã€ä¸´æ—¶å¯¹è±¡æˆ–ä¸´æ—¶å€¼</strong>ã€‚é€šå¸¸å³å€¼ä½äºèµ‹å€¼è¿ç®—ç¬¦çš„å³è¾¹ã€‚
int a=4 * 2;
åœ¨è¿™æ¡è¯­å¥ä¸­ï¼Œa æ˜¯å·¦å€¼ï¼Œå®ƒå…·æœ‰åç§°ï¼Œå®ƒçš„åœ°å€ä¸º&amp;aã€‚å³ä¾§è¡¨è¾¾å¼4*2 çš„ç»“æœæ˜¯å³å€¼ã€‚å®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶å€¼,å°†åœ¨è¯­å¥æ‰§è¡Œå®Œæ¯•æ—¶é”€æ¯ã€‚
å³å€¼å¼•ç”¨æ˜¯ä¸€ä¸ªå¯¹å³å€¼(rvalue)çš„å¼•ç”¨ã€‚ç‰¹åˆ«åœ°ï¼Œè¿™æ˜¯ä¸€ä¸ªå½“å³å€¼æ˜¯ä¸´æ—¶å¯¹è±¡æ—¶æ‰é€‚ç”¨çš„æ¦‚å¿µã€‚å³å€¼å¼•ç”¨å…è®¸å¼€å‘è€…æ•è·å°†è¦é”€æ¯çš„ä¸´æ—¶å¯¹è±¡ï¼Œå¹¶å¯¹å…¶èµ„æºè¿›è¡Œé‡æ–°åˆ©ç”¨ã€‚</p>
<p>å³å€¼å¼•ç”¨çš„ç›®çš„æ˜¯åœ¨æ¶‰åŠä¸´æ—¶å¯¹è±¡æ—¶æä¾›å¯é€‰ç”¨çš„ç‰¹å®šå‡½æ•°ã€‚ç”±äºçŸ¥é“ä¸´æ—¶å¯¹è±¡ä¼šè¢«é”€æ¯ï¼Œé€šè¿‡å³å€¼å¼•ç”¨ï¼ŒæŸäº›æ¶‰åŠå¤åˆ¶å¤§é‡å€¼çš„æ“ä½œå¯é€šè¿‡ç®€å•åœ°å¤åˆ¶æŒ‡å‘è¿™äº›å€¼çš„æŒ‡é’ˆæ¥å®ç°ã€‚</p>
<p>å‡½æ•°å¯å°†&amp;&amp;ä½œä¸ºå‚æ•°è¯´æ˜çš„ä¸€éƒ¨åˆ†(ä¾‹å¦‚ type&amp;&amp;name),ä»¥æŒ‡å®šå³å€¼å¼•ç”¨å‚æ•°ã€‚é€šå¸¸,ä¸´æ—¶å¯¹è±¡è¢«å½“ä½œ const type&amp;ï¼Œä½†å½“å‡½æ•°é‡è½½ä½¿ç”¨äº†å³å€¼å¼•ç”¨æ—¶ï¼Œå¯ä»¥è§£æä¸´æ—¶å¯¹è±¡ï¼Œç”¨äºè¯¥å‡½æ•°é‡è½½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str1</span> <span class="o">=</span> <span class="s">&#34;Hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span> <span class="c1">// str1 çš„å†…å®¹è¢«ç§»åŠ¨åˆ° str2ï¼Œè€Œä¸æ˜¯å¤åˆ¶
</span></span></span></code></pre></div><p><code>std::move</code> å°† <code>str1</code> è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œä»è€Œè§¦å‘ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå°† <code>str1</code> çš„å†…éƒ¨æ•°æ®ç›´æ¥è½¬ç§»ç»™ <code>str2</code>ï¼Œé¿å…äº†æ·±åº¦å¤åˆ¶ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªç±» <code>LargeData</code>ï¼Œå®ƒåŒ…å«å¤§é‡çš„æ•°æ®ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">LargeData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">LargeData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">1000000</span><span class="p">];</span> <span class="c1">// å¤§é‡æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">~</span><span class="n">LargeData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">delete</span><span class="p">[]</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LargeData</span><span class="p">(</span><span class="k">const</span> <span class="n">LargeData</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// æ‹·è´æ„é€ å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="mi">1000000</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">LargeData</span><span class="p">(</span><span class="n">LargeData</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="c1">// ç§»åŠ¨æ„é€ å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">data</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span> <span class="c1">// å°†æºå¯¹è±¡çš„æŒ‡é’ˆç½®ç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>åœ¨è¿™é‡Œï¼Œç§»åŠ¨æ„é€ å‡½æ•°é€šè¿‡ç®€å•åœ°å¤åˆ¶æŒ‡é’ˆ <code>data</code>ï¼Œè€Œä¸æ˜¯å¤åˆ¶æ•´ä¸ªæ•°æ®æ•°ç»„ï¼Œå®ç°äº†é«˜æ•ˆçš„èµ„æºè½¬ç§»ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">LargeData</span> <span class="nf">createLargeData</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">LargeData</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">LargeData</span> <span class="n">ld</span> <span class="o">=</span> <span class="n">createLargeData</span><span class="p">();</span> <span class="c1">// ç§»åŠ¨æ„é€ ï¼Œä¸æ˜¯æ‹·è´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>createLargeData</code> è¿”å›ä¸€ä¸ªä¸´æ—¶çš„ <code>LargeData</code> å¯¹è±¡ï¼Œé€šè¿‡å³å€¼å¼•ç”¨å’Œç§»åŠ¨è¯­ä¹‰ï¼Œä¸´æ—¶å¯¹è±¡çš„èµ„æºè¢«é«˜æ•ˆåœ°ç§»åŠ¨åˆ° <code>ld</code>ï¼Œé¿å…äº†å¤§é‡æ•°æ®çš„å¤åˆ¶æ“ä½œã€‚</p>
<p>std::moveå¯å°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼ï¼Œå¼ºè¿«ç¼–è¯‘å™¨è°ƒç”¨ handleMessageå‡½æ•°çš„å³å€¼å¼•ç”¨ç‰ˆæœ¬</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">handleMessage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">));</span> <span class="c1">// Calls handleMessage(string&amp;&amp; value)
</span></span></span></code></pre></div><p>å› ä¸ºæœ‰åç§°çš„å˜é‡æ˜¯å·¦å€¼ã€‚å› æ­¤ï¼Œåœ¨ handleMessageå‡½æ•°ä¸­ï¼Œå³å€¼å¼•ç”¨å‚æ•° message æœ¬èº«æ˜¯ä¸€ä¸ªå·¦å€¼ï¼ŒåŸå› æ˜¯å®ƒå…·æœ‰åç§°! å¦‚æœå¸Œæœ›å°†è¿™ä¸ªå·¦å€¼å¼•ç”¨å‚æ•°ï¼Œä½œä¸ºå³å€¼ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°ï¼Œåˆ™éœ€è¦ä½¿ç”¨ std:moveå°†å·¦å€¼è½¬æ¢ä¸ºå³å€¼ã€‚ä¾‹å¦‚ï¼Œå‡è®¾è¦æ·»åŠ ä»¥ä¸‹å‡½æ•°ï¼Œä½¿ç”¨å³å€¼å¼•ç”¨å‚æ•°:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">helper</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span> <span class="n">message</span><span class="p">)</span>
</span></span></code></pre></div><p>å¦‚æœæŒ‰å¦‚ä¸‹æ–¹å¼è°ƒç”¨ï¼Œåˆ™æ— æ³•ç¼–è¯‘:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">handleMessage</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">helper</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>helperå‡½æ•°éœ€è¦å³å€¼å¼•ç”¨ï¼Œè€Œ handleMessageå‡½æ•°ä¼ é€’ messageï¼Œmessage å…·æœ‰åç§°ï¼Œæ˜¯å·¦å€¼ï¼Œå¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯ä½¿ç”¨std::move():</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">handleMessaqe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;&amp;</span> <span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">helper</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">message</span><span class="p">))</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>std::move</code> çš„è¿”å›çš„æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ã€‚</p>
<p><code>std::move</code> å¹¶ä¸çœŸçš„â€œç§»åŠ¨â€å¯¹è±¡ï¼Œè€Œæ˜¯å°†ä¸€ä¸ªå·¦å€¼è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œå…è®¸è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">MyClass</span> <span class="nf">b</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">));</span>
</span></span></code></pre></div><p><code>std::move(a)</code> å°† <code>a</code> è½¬æ¢ä¸ºå³å€¼å¼•ç”¨ï¼Œè§¦å‘ <code>MyClass</code> çš„ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>
<p>é”™è¯¯ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="n">MyClass</span> <span class="nf">a</span><span class="p">(</span><span class="s">&#34;Hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">MyClass</span><span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">);</span> <span class="c1">// å³å€¼å¼•ç”¨èµ‹ç»™å³å€¼å¼•ç”¨å˜é‡ rï¼Œä½† r ä½œä¸ºå˜é‡åï¼Œæ˜¯ä¸€ä¸ªå·¦å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">MyClass</span> <span class="nf">b</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="c1">// é”™è¯¯ï¼šè°ƒç”¨çš„æ˜¯å¤åˆ¶æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯ç§»åŠ¨æ„é€ å‡½æ•°
</span></span></span></code></pre></div><p>è™½ç„¶ <code>r</code> æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨ï¼Œä½†æ˜¯ <code>r</code> ä½œä¸ºä¸€ä¸ªå…·åå˜é‡æ˜¯ä¸€ä¸ªå·¦å€¼ï¼Œå› æ­¤ <code>MyClass b(r);</code> è°ƒç”¨äº†å¤åˆ¶æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/stl%E7%AE%97%E6%B3%95/">
    <span class="title">Â« Prev</span>
    <br>
    <span>stlä¸­çš„ç®—æ³•ä»‹ç»</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/catch2/">
    <span class="title">Next Â»</span>
    <br>
    <span>catch2æµ‹è¯•æ¡†æ¶</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="http://localhost:1313/">Cookie&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
